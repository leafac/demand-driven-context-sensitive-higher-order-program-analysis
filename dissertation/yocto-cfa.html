<!DOCTYPE html><html lang="en"><head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="yocto-cfa.css">
    
  <title>Yocto-CFA: A Program Analyzer That You Can Understand</title>
  <meta name="author" content="Leandro Facchinetti">
  <meta name="subject" content="TODO">
  <meta name="keywords" content="todo, todo, ...">
<meta name="date" content="2020-05-30"></head>
<body>
<header>
<div class="title-page">
  <div class="title">Yocto-CFA:<br>A Program Analyzer That You Can Understand</div>
  <div class="author">by<br>Leandro Facchinetti</div>
  <div class="statement">A dissertation submitted to Johns Hopkins University<br>in conformity with the requirements for the degree of Doctor of Philosophy</div>
  <div class="publishing-location">Baltimore, Maryland<br>August 2020</div>
<div class="timestamp draft">2020-05-30T22:15:38.366Z</div></div>

<!-- TODO
# Abstract

- **Primary Reader and Advisor:** Dr. Scott Fraser Smith.
- **Readers:** Dr. Zachary Eli Palmer and Dr. Matthew Daniel Green.
-->

<!-- TODO: # Acknowledgements -->

<!-- TODO: # Dedication -->

<h1 id="table-of-contents">Table of Contents</h1><div class="table-of-contents-item"><a href="#developing-an-analyzer" data-section="main"><span class="heading-counter">1</span> Developing an Analyzer</a></div><div class="table-of-contents-item"><a href="#the-analyzed-language-yocto-javascript" data-section="main"><span class="heading-counter">1.1</span> The Analyzed Language: Yocto-JavaScript</a></div><div class="table-of-contents-item"><a href="#values-in-yocto-javascript" data-section="main"><span class="heading-counter">1.1.1</span> Values in Yocto-JavaScript</a></div><div class="table-of-contents-item"><a href="#operations-in-yocto-javascript" data-section="main"><span class="heading-counter">1.1.2</span> Operations in Yocto-JavaScript</a></div><div class="table-of-contents-item"><a href="#the-computational-power-of-yocto-javascript" data-section="main"><span class="heading-counter">1.1.3</span> The Computational Power of Yocto-JavaScript</a></div><div class="table-of-contents-item"><a href="#a-formal-grammar-for-yocto-javascript" data-section="main"><span class="heading-counter">1.1.4</span> A Formal Grammar for Yocto-JavaScript</a></div><div class="table-of-contents-item"><a href="#the-analyzer-language-typescript" data-section="main"><span class="heading-counter">1.2</span> The Analyzer Language: TypeScript</a></div><div class="table-of-contents-item"><a href="#step-0-substitution-based-interpreter" data-section="main"><span class="heading-counter">1.3</span> Step 0: Substitution-Based Interpreter</a></div><div class="table-of-contents-item"><a href="#architecture" data-section="main"><span class="heading-counter">1.3.1</span> Architecture</a></div><div class="table-of-contents-item"><a href="#data-structures-to-represent-yocto-javascript-programs" data-section="main"><span class="heading-counter">1.3.2</span> Data Structures to Represent Yocto-JavaScript Programs</a></div><div class="table-of-contents-item"><a href="#an-expression-that-already-is-a-value" data-section="main"><span class="heading-counter">1.3.3</span> An Expression That Already Is a Value</a></div><div class="table-of-contents-item"><a href="#a-call-involving-immediate-functions" data-section="main"><span class="heading-counter">1.3.4</span> A Call Involving Immediate Functions</a></div><div class="table-of-contents-item"><a href="#substitution-in-function-definitions" data-section="main"><span class="heading-counter">1.3.5</span> Substitution in Function Definitions</a></div><div class="table-of-contents-item"><a href="#name-mismatch" data-section="main"><span class="heading-counter">1.3.6</span> Name Mismatch</a></div><div class="table-of-contents-item"><a href="#name-reuse" data-section="main"><span class="heading-counter">1.3.7</span> Name Reuse</a></div><div class="table-of-contents-item"><a href="#substitution-in-function-calls" data-section="main"><span class="heading-counter">1.3.8</span> Substitution in Function Calls</a></div><div class="table-of-contents-item"><a href="#an-argument-that-is-not-immediate" data-section="main"><span class="heading-counter">1.3.9</span> An Argument That Is Not Immediate</a></div><div class="table-of-contents-item"><a href="#a-function-that-is-not-immediate" data-section="main"><span class="heading-counter">1.3.10</span> A Function That Is Not Immediate</a></div><div class="table-of-contents-item"><a href="#continuing-to-run-after-a-function-call" data-section="main"><span class="heading-counter">1.3.11</span> Continuing to Run After a Function Call</a></div><div class="table-of-contents-item"><a href="#a-reference-to-an-undefined-variable" data-section="main"><span class="heading-counter">1.3.12</span> A Reference to an Undefined Variable</a></div><div class="table-of-contents-item"><a href="#the-entire-runner" data-section="main"><span class="heading-counter">1.3.13</span> The Entire Runner</a></div><div class="table-of-contents-item"><a href="#an-operational-semantics-for-the-interpreter" data-section="main"><span class="heading-counter">1.3.14</span> An Operational Semantics for the Interpreter</a></div><div class="table-of-contents-item"><a href="#parser" data-section="main"><span class="heading-counter">1.3.15</span> Parser</a></div><div class="table-of-contents-item"><a href="#generator" data-section="main"><span class="heading-counter">1.3.16</span> Generator</a></div><div class="table-of-contents-item"><a href="#programs-that-do-not-terminate" data-section="main"><span class="heading-counter">1.3.17</span> Programs That Do Not Terminate</a></div><div class="table-of-contents-item"><a href="#step-1-environment-based-interpreter" data-section="main"><span class="heading-counter">1.4</span> Step 1: Environment-Based Interpreter</a></div><div class="table-of-contents-item"><a href="#avoiding-substitution-by-introducing-environments-and-closures" data-section="main"><span class="heading-counter">1.4.1</span> Avoiding Substitution by Introducing Environments and Closures</a></div><div class="table-of-contents-item"><a href="#new-data-structures" data-section="main"><span class="heading-counter">1.4.2</span> New Data Structures</a></div><div class="table-of-contents-item"><a href="#adding-an-environment-to-the-runner" data-section="main"><span class="heading-counter">1.4.3</span> Adding an Environment to the Runner</a></div><div class="table-of-contents-item"><a href="#a-function-definition" data-section="main"><span class="heading-counter">1.4.4</span> A Function Definition</a></div><div class="table-of-contents-item"><a href="#a-function-call" data-section="main"><span class="heading-counter">1.4.5</span> A Function Call</a></div><div class="table-of-contents-item"><a href="#name-reuse-1" data-section="main"><span class="heading-counter">1.4.6</span> Name Reuse</a></div><div class="table-of-contents-item"><a href="#a-variable-reference" data-section="main"><span class="heading-counter">1.4.7</span> A Variable Reference</a></div><div class="table-of-contents-item"><a href="#a-function-body-is-evaluated-with-the-environment-in-its-closure" data-section="main"><span class="heading-counter">1.4.8</span> A Function Body Is Evaluated with the Environment in Its Closure</a></div><div class="table-of-contents-item"><a href="#the-entire-runner-1" data-section="main"><span class="heading-counter">1.4.9</span> The Entire Runner</a></div><div class="table-of-contents-item"><a href="#operational-semantics" data-section="main"><span class="heading-counter">1.4.10</span> Operational Semantics</a></div><div class="table-of-contents-item"><a href="#generator-1" data-section="main"><span class="heading-counter">1.4.11</span> Generator</a></div><div class="table-of-contents-item"><a href="#programs-that-do-not-terminate-1" data-section="main"><span class="heading-counter">1.4.12</span> Programs That Do Not Terminate</a></div><div class="table-of-contents-item"><a href="#step-2-store-based-interpreter" data-section="main"><span class="heading-counter">1.5</span> Step 2: Store-Based Interpreter</a></div><div class="table-of-contents-item"><a href="#avoiding-nested-environments-by-introducing-a-store" data-section="main"><span class="heading-counter">1.5.1</span> Avoiding Nested Environments by Introducing a Store</a></div><div class="table-of-contents-item"><a href="#new-data-structures-1" data-section="main"><span class="heading-counter">1.5.2</span> New Data Structures</a></div><div class="table-of-contents-item"><a href="#adding-a-store-to-the-runner" data-section="main"><span class="heading-counter">1.5.3</span> Adding a Store to the Runner</a></div><div class="table-of-contents-item"><a href="#adding-a-value-to-the-store" data-section="main"><span class="heading-counter">1.5.4</span> Adding a Value to the Store</a></div><div class="table-of-contents-item"><a href="#retrieving-a-value-from-the-store" data-section="main"><span class="heading-counter">1.5.5</span> Retrieving a Value from the Store</a></div><div class="table-of-contents-item"><a href="#the-entire-runner-2" data-section="main"><span class="heading-counter">1.5.6</span> The Entire Runner</a></div><div class="table-of-contents-item"><a href="#operational-semantics-1" data-section="main"><span class="heading-counter">1.5.7</span> Operational Semantics</a></div><div class="table-of-contents-item"><a href="#programs-that-do-not-terminate-2" data-section="main"><span class="heading-counter">1.5.8</span> Programs That Do Not Terminate</a></div><div class="table-of-contents-item"><a href="#step-3-finitely-many-addresses" data-section="main"><span class="heading-counter">1.6</span> Step 3: Finitely Many Addresses</a></div><div class="table-of-contents-item"><a href="#the-entire-runner-3" data-section="main"><span class="heading-counter">1.6.1</span> The Entire Runner</a></div><div class="table-of-contents-item"><a href="#bibliography" data-section="footer">Bibliography</a></div>
</header>
<main>

<!-- TODO:

# Introduction

- Link to GitHub
-->

<h1 id="developing-an-analyzer"><span class="heading-counter">1</span> Developing an Analyzer<code class="draft"> [](#developing-an-analyzer)</code></h1>
<!-- TODO: An overview of the rest of the section -->

<h2 id="the-analyzed-language-yocto-javascript"><span class="heading-counter">1.1</span> The Analyzed Language: Yocto-JavaScript<code class="draft"> [](#the-analyzed-language-yocto-javascript)</code></h2>
<p>Our first decision when developing a program analyzer is which language it should analyze. This decision is important, among other reasons, because it influences how difficult it is to develop the analyzer. In this dissertation we are interested in analysis techniques for higher-order functions, so we have plenty of options from which to choose, because higher-order functions are present in most languages, including JavaScript, Java, Python, Ruby, and so forth.</p>
<p>From all these options, we would like to choose JavaScript because it is the most popular programming language&nbsp;[<a href="#stack-overflow-developer-survey">29</a>, <a href="#jet-brains-developer-survey">11</a>], but JavaScript has many features besides higher-order functions that would complicate our analyzer. As a compromise, we analyze some parts of JavaScript, but not the entire language: we analyze only the JavaScript features that are related to higher-order functions, a language subset which we call <em>Yocto-JavaScript</em> (JavaScript<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.553ex" height="1.843ex" style="vertical-align: -0.338ex;" viewBox="0 -647.8 668.5 793.3" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title"> \times</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-D7" d="M611 37l-43 -42l-233 234l-234 -234l-42 42l234 234l-234 234l42 42l234 -234l233 234l43 -42l-235 -234Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-D7" x="0" y="0"></use>
</g>
</svg>10<sup>-24</sup>).</p>
<fieldset>
<legend><span class="legend-wrapper"><strong>Advanced</strong></span></legend>

<p>On the surface the choice of analyzed language is important because it influences how difficult it is to develop the analyzer, but it has deeper consequences as well: the analyzed language may also influence the analyzer’s precision and running time. For example, there is an analysis technique called <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.088ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 468.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">k</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D458" d="M240 722l-107 -492c125 175 208 252 274 252c12 0 30 -3 48 -9l-17 -63c-17 4 -28 6 -36 6c-50 0 -96 -25 -157 -86l-14 -14c39 -123 61 -177 96 -241c9 -17 16 -23 26 -23c8 0 15 2 29 10l43 24l8 -19l-46 -32c-44 -31 -68 -44 -81 -44c-25 0 -57 68 -126 268 c-34 -34 -58 -79 -67 -127l-23 -124l-67 -17l-9 10c52 209 68 278 82 353l48 268c1 7 2 16 2 24c0 17 -10 24 -34 24h-48l4 21c72 7 108 16 160 42Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D458" x="0" y="0"></use>
</g>
</svg>-CFA&nbsp;[<a href="#k-cfa">28</a>] that may be slower when applied to a language with higher-order functions than when applied to a language with objects, because the algorithmic complexity of the former is exponential and of the latter is polynomial&nbsp;[<a href="#m-cfa">18</a>].</p>
</fieldset>

<fieldset>
<legend><span class="legend-wrapper"><strong>Technical Terms</strong></span></legend>

<ul>
<li><strong><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.437ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 618.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\lambda</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D706" d="M209 656c42 11 138 72 174 33c16 -17 41 -363 56 -470c5 -31 13 -164 52 -164c21 0 50 22 67 33v-1h12v-13c-42 -30 -114 -116 -169 -80c-17 19 -40 371 -48 434c-92 -120 -199 -269 -242 -415c-26 -9 -51 -18 -76 -29l-10 14c95 163 194 322 322 462 c-4 40 -13 193 -65 193c-16 0 -47 -11 -64 -16c-5 2 -7 6 -9 11v8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D706" x="0" y="0"></use>
</g>
</svg>-Calculus&nbsp;[<a href="#understanding-computation">30 (§&nbsp;6)</a>]:</strong> Given the subset of JavaScript features that Yocto-JavaScript supports, it is a representation of the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.437ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 618.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\lambda</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D706" d="M209 656c42 11 138 72 174 33c16 -17 41 -363 56 -470c5 -31 13 -164 52 -164c21 0 50 22 67 33v-1h12v-13c-42 -30 -114 -116 -169 -80c-17 19 -40 371 -48 434c-92 -120 -199 -269 -242 -415c-26 -9 -51 -18 -76 -29l-10 14c95 163 194 322 322 462 c-4 40 -13 193 -65 193c-16 0 -47 -11 -64 -16c-5 2 -7 6 -9 11v8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D706" x="0" y="0"></use>
</g>
</svg>-calculus.</li>
</ul>
</fieldset>

<h3 id="values-in-yocto-javascript"><span class="heading-counter">1.1.1</span> Values in Yocto-JavaScript<code class="draft"> [](#values-in-yocto-javascript)</code></h3>
<p>JavaScript has many kinds of values:</p>
<figure>

<table>
<thead>
<tr>
<th align="center">Kind of JavaScript Value</th>
<th align="center">Example</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code><span style="color: #267F99">String</span></code></td>
<td align="center"><code><span style="color: #A31515">"Leandro"</span></code></td>
</tr>
<tr>
<td align="center"><code><span style="color: #267F99">Number</span></code></td>
<td align="center"><code><span style="color: #098658">29</span></code></td>
</tr>
<tr>
<td align="center"><code><span style="color: #267F99">Array</span></code></td>
<td align="center"><code><span style="color: #000000">[</span><span style="color: #A31515">"Leandro"</span><span style="color: #000000">, </span><span style="color: #098658">29</span><span style="color: #000000">]</span></code></td>
</tr>
<tr>
<td align="center"><code><span style="color: #267F99">Object</span></code></td>
<td align="center"><code><span style="color: #000000">{ </span><span style="color: #001080">name</span><span style="color: #000000">: </span><span style="color: #A31515">"Leandro"</span><span style="color: #000000">, </span><span style="color: #001080">age</span><span style="color: #000000">: </span><span style="color: #098658">29</span><span style="color: #000000"> }</span></code></td>
</tr>
<tr>
<td align="center"><code><span style="color: #267F99">Function</span></code></td>
<td align="center"><code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code></td>
</tr>
<tr>
<td align="center">…</td>
<td align="center">…</td>
</tr>
</tbody></table>
</figure>

<p>From all these kinds of values, Yocto-JavaScript supports only one: <code><span style="color: #267F99">Function</span></code>. An Yocto-JavaScript function is written as <code><span style="color: #800000">&lt;parameter&gt;</span><span style="color: #000000"> =&gt; </span><span style="color: #800000">&lt;body&gt;</span></code>, for example, <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code>, in which the <code><span style="color: #800000">&lt;parameter&gt;</span></code> is called <code><span style="color: #001080">x</span></code> and the <code><span style="color: #800000">&lt;body&gt;</span></code> is a reference to the variable <code><span style="color: #001080">x</span></code> (see <a href="#operations-in-yocto-javascript">§&nbsp;1.1.2</a> for more on variable references). An Yocto-JavaScript function must have exactly one parameter. Because an Yocto-JavaScript function is a value, it may be passed as argument in a function call or returned as the result of a function call (see <a href="#operations-in-yocto-javascript">§&nbsp;1.1.2</a> for more on function calls).</p>
<fieldset>
<legend><span class="legend-wrapper"><strong>Technical Terms</strong></span></legend>

<ul>
<li><strong>Arrow Function Expressions&nbsp;[<a href="#javascript-arrow-function-expressions">19</a>]:</strong> The notation we use for writing functions.</li>
<li><strong>Identity Function:</strong> The function given as example, <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code>.</li>
<li><strong>High-Order Functions:</strong> Functions that may act as values.</li>
</ul>
</fieldset>

<h3 id="operations-in-yocto-javascript"><span class="heading-counter">1.1.2</span> Operations in Yocto-JavaScript<code class="draft"> [](#operations-in-yocto-javascript)</code></h3>
<p>JavaScript has many kinds of operations on the values introduced in <a href="#values-in-yocto-javascript">§&nbsp;1.1.1</a>:</p>
<figure>

<table>
<thead>
<tr>
<th align="center">Kind of JavaScript Operation</th>
<th align="center">Example</th>
<th align="center">Result</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Access a character in a <code><span style="color: #267F99">String</span></code></td>
<td align="center"><code><span style="color: #A31515">"Leandro"</span><span style="color: #000000">[</span><span style="color: #098658">2</span><span style="color: #000000">]</span></code></td>
<td align="center"><code><span style="color: #A31515">"a"</span></code></td>
</tr>
<tr>
<td align="center">Add <code><span style="color: #267F99">Number</span></code>s</td>
<td align="center"><code><span style="color: #098658">29</span><span style="color: #000000"> + </span><span style="color: #098658">1</span></code></td>
<td align="center"><code><span style="color: #098658">30</span></code></td>
</tr>
<tr>
<td align="center">Call a <code><span style="color: #267F99">Function</span></code></td>
<td align="center"><code><span style="color: #795E26">parseInt</span><span style="color: #000000">(</span><span style="color: #A31515">"29"</span><span style="color: #000000">)</span></code></td>
<td align="center"><code><span style="color: #098658">29</span></code></td>
</tr>
<tr>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
</tr>
</tbody></table>
</figure>

<p>From all these operations, Yocto-JavaScript supports only two: function calls and variable references. A function call is written as <code><span style="color: #800000">&lt;function&gt;</span><span style="color: #000000">(</span><span style="color: #800000">&lt;argument&gt;</span><span style="color: #000000">)</span></code>, for example, <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">a</span><span style="color: #000000">)</span></code>, in which the <code><span style="color: #800000">&lt;function&gt;</span></code> is a hypothetical function <code><span style="color: #001080">f</span></code> and the <code><span style="color: #800000">&lt;argument&gt;</span></code> is a hypothetical argument <code><span style="color: #001080">a</span></code>. An Yocto-JavaScript function call must have exactly one argument (because an Yocto-JavaScript function must have exactly one parameter; see <a href="#values-in-yocto-javascript">§&nbsp;1.1.1</a>). A variable reference is written as a bare identifier, for example, <code><span style="color: #001080">x</span></code>.</p>
<p>The following is a complete Yocto-JavaScript program that exemplifies all the supported operations:</p>
<figure>

<table>
<thead>
<tr>
<th align="center">Example Yocto-JavaScript Program</th>
<th align="center">Result</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)</span></code></td>
<td align="center"><code><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)</span></code></td>
</tr>
</tbody></table>
</figure>

<p>This program is a function call in which the <code><span style="color: #800000">&lt;function&gt;</span></code> is <code><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span></code> and the <code><span style="color: #800000">&lt;argument&gt;</span></code> is <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code>. When called, an Yocto-JavaScript function returns the result of computing its <code><span style="color: #800000">&lt;body&gt;</span></code>. The <code><span style="color: #800000">&lt;body&gt;</span></code> of <code><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span></code> is a reference to the variable <code><span style="color: #001080">y</span></code>, so <code><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span></code> is a function that returns its argument unchanged.</p>
<p>In general, all kinds of Yocto-JavaScript expressions (function definitions, function calls, and variable references) may appear in the <code><span style="color: #800000">&lt;body&gt;</span></code> of a function definition, or as the <code><span style="color: #800000">&lt;function&gt;</span></code> or <code><span style="color: #800000">&lt;argument&gt;</span></code> of a call; for example, in the program <code><span style="color: #000000">(</span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">a</span><span style="color: #000000">))(</span><span style="color: #001080">b</span><span style="color: #000000">)</span></code> the function call <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">a</span><span style="color: #000000">)</span></code> appears as the <code><span style="color: #800000">&lt;function&gt;</span></code> of a call.</p>
<p>We use parentheses to resolve ambiguities on where function definitions start and end, and in which order operations are computed. For example, given hypothetical functions <code><span style="color: #001080">f</span></code>, <code><span style="color: #001080">g</span></code>, and <code><span style="color: #001080">h</span></code>, in <code><span style="color: #000000">(</span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">g</span><span style="color: #000000">))(</span><span style="color: #001080">h</span><span style="color: #000000">)</span></code> the call <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">g</span><span style="color: #000000">)</span></code> happens first and the result is a function that is called with <code><span style="color: #001080">h</span></code>, and in <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #795E26">g</span><span style="color: #000000">(</span><span style="color: #001080">h</span><span style="color: #000000">))</span></code> the call <code><span style="color: #795E26">g</span><span style="color: #000000">(</span><span style="color: #001080">h</span><span style="color: #000000">)</span></code> happens first and the result is passed as argument to <code><span style="color: #001080">f</span></code>. If there are no parentheses, then nested function definitions are read right-to-left and a sequence of function calls are read left-to-right; for example, <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code> is equivalent to <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> (</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)</span></code> and <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">a</span><span style="color: #000000">)(</span><span style="color: #001080">b</span><span style="color: #000000">)</span></code> is equivalent to <code><span style="color: #000000">(</span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">a</span><span style="color: #000000">))(</span><span style="color: #001080">b</span><span style="color: #000000">)</span></code>.</p>
<fieldset>
<legend><span class="legend-wrapper"><strong>Technical Terms</strong></span></legend>

<ul>
<li><strong>Precedence:</strong> The order in which operations are computed. Operations that are computed first have <em>higher precedence</em>; operations that are computed later have <em>lower precedence</em>.</li>
<li><strong>Associativity:</strong> The order in which operations of the same type are computed. Function definitions are <em>right-associative</em> and function calls are <em>left-associative</em>.</li>
</ul>
</fieldset>

<fieldset>
<legend><span class="legend-wrapper"><strong>Advanced</strong></span></legend>

<h3 id="the-computational-power-of-yocto-javascript"><span class="heading-counter">1.1.3</span> The Computational Power of Yocto-JavaScript<code class="draft"> [](#the-computational-power-of-yocto-javascript)</code></h3>
<p>Yocto-JavaScript has only a few features, which makes it the ideal language for discussing the analysis of higher-order functions, but does it have enough features to support every kind of computation? Perhaps surprisingly, the answer is positive: Yocto-JavaScript is equivalent to JavaScript (and Java, Python, Ruby, and so forth) in the sense that any program in any one of these languages may be translated into an equivalent program in any other language&nbsp;[<a href="#understanding-computation">30 (§&nbsp;6)</a>].</p>
<p>As an example of how this translation could be done, consider a JavaScript function of two parameters: <code><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">, </span><span style="color: #001080">y</span><span style="color: #000000">) </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code>. This function is not supported by Yocto-JavaScript because it does not have exactly one parameter (see <a href="#values-in-yocto-javascript">§&nbsp;1.1.1</a>), but we may encode it as <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code>, which is a function that receives the first parameter and returns another function that receives the second parameter. Similarly, we may encode a call with multiple arguments as a sequence of calls that passes one argument at a time; for example, <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">a</span><span style="color: #000000">, </span><span style="color: #001080">b</span><span style="color: #000000">)</span></code> may be encoded as <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">a</span><span style="color: #000000">)(</span><span style="color: #001080">b</span><span style="color: #000000">)</span></code>.</p>
<fieldset>
<legend><span class="legend-wrapper"><strong>Technical Terms</strong></span></legend>

<ul>
<li><strong>Computational Power:</strong> The ability of expressing computations.</li>
<li><strong>Turing Complete&nbsp;[<a href="#understanding-computation">30 (§&nbsp;7)</a>]:</strong> Property of a language that may express any computation of which a computer is capable. Yocto-JavaScript, JavaScript, Java, Python, Ruby, and so forth are all Turing Complete.</li>
<li><strong>Currying&nbsp;[<a href="#understanding-computation">30 (page&nbsp;163)</a>]:</strong> The translation technique we used to encode functions with multiple parameters and calls with multiple arguments.</li>
</ul>
</fieldset>

<p>For our goal of exploring analysis techniques, we are concerned only with computational power, but it is worth noting that programmers would be more interested in other language properties: Does the language promote writing programs of higher quality? (It most probably does not&nbsp;[<a href="#code-quality">4</a>].) Does the language improve productivity? Does the language work well in the domain of the problem? (For example, we would probably write an operating system in C and a web application in JavaScript, not the other way around.) Is the language more expressive than others? (Perhaps surprisingly, it is possible to make formal arguments about expressiveness without resorting to personal preference and anecdotal evidence&nbsp;[<a href="#expressive-power">7</a>].) Despite having the same computational power as other languages, Yocto-JavaScript fares badly in these other aspects: it is remarkably unproductive and inexpressive.</p>
<h3 id="a-formal-grammar-for-yocto-javascript"><span class="heading-counter">1.1.4</span> A Formal Grammar for Yocto-JavaScript<code class="draft"> [](#a-formal-grammar-for-yocto-javascript)</code></h3>
<p>The description of Yocto-JavaScript given in <a href="#values-in-yocto-javascript">§&nbsp;1.1.1</a> and <a href="#operations-in-yocto-javascript">§&nbsp;1.1.2</a> is informal; the following is a grammar in <em>Backus–Naur Form</em>&nbsp;(BNF)&nbsp;[<a href="#bnf">17</a>, <a href="#dragon-book">1 (§&nbsp;4.2)</a>] that formalizes it:</p>
<figure>

<table>
<thead>
<tr>
<th align="right"></th>
<th align="center"></th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="right"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.902ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 388.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
</g>
</svg></td>
<td align="center">::=</td>
<td align="left"><code><span style="color: #000000">(</span></code> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.16ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 499.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
</g>
</svg>&nbsp;&nbsp;<code><span style="color: #0000FF">=&gt;</span></code>&nbsp;&nbsp;<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.902ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 388.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
</g>
</svg> <code><span style="color: #000000">)</span></code> | <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.902ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 388.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
</g>
</svg> <code><span style="color: #000000">(</span></code> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.902ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 388.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
</g>
</svg> <code><span style="color: #000000">)</span></code> | <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.16ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 499.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
</g>
</svg></td>
<td align="left">Expressions</td>
</tr>
<tr>
<td align="right"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.16ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 499.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
</g>
</svg></td>
<td align="center">::=</td>
<td align="left"><code>&lt;A JavaScript Identifier&gt;</code></td>
<td align="left">Variables</td>
</tr>
</tbody></table>
</figure>
</fieldset>

<h2 id="the-analyzer-language-typescript"><span class="heading-counter">1.2</span> The Analyzer Language: TypeScript<code class="draft"> [](#the-analyzer-language-typescript)</code></h2>
<p>After choosing our analyzed language (Yocto-JavaScript; see <a href="#the-analyzed-language-yocto-javascript">§&nbsp;1.1</a>), we must decide in which language to develop the analyzer itself. Our analyzed language is based on JavaScript, so it is a natural first candidate, but JavaScript lacks a feature which we will need: the ability to express the <em>types</em> of data structures, functions, and so forth (see, for example, <a href="#data-structures-to-represent-yocto-javascript-programs">§&nbsp;1.3.2</a>). We choose instead to implement our analyzer in a JavaScript extension with support for types called <em>TypeScript</em>&nbsp;[<a href="#typescript-documentation">32</a>, <a href="#typescript-deep-dive">31</a>, <a href="#understanding-typescript">5</a>].</p>
<h2 id="step-0-substitution-based-interpreter"><span class="heading-counter">1.3</span> Step 0: Substitution-Based Interpreter<code class="draft"> [](#step-0-substitution-based-interpreter)</code></h2>
<p>Having chosen the analyzed language (Yocto-JavaScript; see <a href="#the-analyzed-language-yocto-javascript">§&nbsp;1.1</a>) and the language in which to develop the analyzer itself (TypeScript; see <a href="#the-analyzer-language-typescript">§&nbsp;1.2</a>), we are ready to start developing the analyzer. We begin in Step&nbsp;0 by developing an interpreter that executes Yocto-JavaScript programs and produces the same outputs that would be produced by a regular JavaScript interpreter. This is a good starting point for two reasons: first, this interpreter is the basis upon which we will build the analyzer; and second, the outputs of this interpreter are the ground truth against which we will validate the outputs of the analyzer.</p>
<!-- TODO: Forward reference to where we validate the outputs of the analyzer. -->

<h3 id="architecture"><span class="heading-counter">1.3.1</span> Architecture<code class="draft"> [](#architecture)</code></h3>
<p>Our interpreter is defined as a function called <code><span style="color: #795E26">evaluate</span><span style="color: #000000">()</span></code>, which receives an Yocto-JavaScript program represented as a string and returns the result of running it.</p>
<p>The following are two examples of how we will be able to use <code><span style="color: #795E26">evaluate</span><span style="color: #000000">()</span></code> by the end of Step&nbsp;0 (the <code><span style="color: #000000">&gt;</span></code> represents the console, and by convention strings that represent Yocto-JavaScript programs are delimited by backticks (<code><span style="color: #A31515">`</span></code>)&nbsp;[<a href="#javascript-template-literals">24</a>]):</p>
<pre><code class="language-ts"><span style="color: #000000">&gt; </span><span style="color: #795E26">evaluate</span><span style="color: #000000">(</span><span style="color: #A31515">`x =&gt; x`</span><span style="color: #000000">)</span>
<span style="color: #A31515">`x =&gt; x`</span>
<span style="color: #000000">&gt; </span><span style="color: #795E26">evaluate</span><span style="color: #000000">(</span><span style="color: #A31515">`(y =&gt; y)(x =&gt; x)`</span><span style="color: #000000">)</span>
<span style="color: #A31515">`x =&gt; x`</span></code></pre>
<p>The implementation of <code><span style="color: #795E26">evaluate</span><span style="color: #000000">()</span></code> is separated into three parts called <code><span style="color: #795E26">parse</span><span style="color: #000000">()</span></code>, <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code>, and <code><span style="color: #795E26">generate</span><span style="color: #000000">()</span></code>:</p>
<figure>

<p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="391px" height="396px" viewBox="-0.5 -0.5 391 396" content="<mxfile host=&quot;&quot; modified=&quot;2020-05-30T10:18:15.839Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Code/1.45.1 Chrome/78.0.3904.130 Electron/7.2.4 Safari/537.36&quot; etag=&quot;4EhQCWFqqKDJrGF3Eali&quot; version=&quot;13.1.3&quot;><diagram id=&quot;6hGFLwfOUW9BJ-s0fimq&quot; name=&quot;Page-1&quot;>7VrLkps4FP0aV3U2KZ5+LPuZWSQ1qUqmZrKUQY3VLSOXkLvt+fqRQAKBZBs7BuPq2bisixBwztHR1YWRf7/cfKFgtfhGYohHnhNvRv7DyPOmsyn/FYFtERj7YRFIKIqLkFsFfqB/oQw6MrpGMcxqHRkhmKFVPRiRNIURq8UApeS93u2Z4PpVVyCBRuBHBLAZ/RvFbCGfwnGq+B8QJQt55Zk6sASqrwxkCxCTdy3kP478e0oIK/4tN/cQC+gULMV5TzuOlvdFYcosJ/yVQfrn/EVA4jkYzDkreSf4BvAaMHjzqRgAo/S1OMKyIqKuEFZ3WV49Y1sFDCXrNIairzvy755Jyp7AEmFB8/efvOs3khJ+ANBIkuqL1pqRrGg6ojnPCF4zeFt2EmNRwgADc6zaAKMk5f8xfOZPevcGKUOcoFsZZmTFo9kKRChN5MCy9VMc0gNf8yEeXBHiimEApZDKLuIR1F2MedsEWGIubgButJDE6AskS8jolndRRx0pdil+X6njvZKSP5OxhSYjTwWBlG9Sjl1RzP9IYlRTI32vCPhDZS0U4HUqALe1AJrMVFy7Z+JJwa14Uial8TS10OR3yhJdp4c58j8OR/W5FAQmR5POODL8N5D3z91UYi1tvgIfxnwlkU1C2YIkJAX4sYreVfQIA6r6fCW5cQnkXiBjWwmsIIaHFmyJDzEK0/hWrH48PMckei1CTwjjHXztZCgjaxpBzRD4AgxoApmmP88Rz7qXRQoxYOitvqoewYlBwPQSeMMNYv+I0z+HsvVLO/KwkSPnja22rvTIUXhuQuSp3wlKWTUdy3ml8rqgMc8KkcizGrSWt2FjepcdJpCv1e0ylw/jiZO6J4aBmV+4bn+mOP6Ipuibpnj2OdjWFCctCDBBaIcdvxXN+kTzl7I70ajML29ty5YO8Mt6uVLspySFeRq+RNHoyBRcB9trCbY2J0LLlFCxM/si3yrWhyikY/iiOVAzJ21uCc5usDcCpfzvOGE5+s72083GCG4MA35pGPBsrwFzcxMjZYySV3hPMKGVGp65Vhohtf2LuAjEZs3YAC5RHFucY6eU80fmxhJD2rhUfRPZ8PwO9oeeHzbEYua0ri2p9brx74K4/f6RcJRXpy9usk4jV8lR+SSng2bbrJWzTgetXAmPQG3XXOHyw4dmgas/hzkNeACtMmgXmlW4x0Je0nlEwaJuOq6ZT9iQ7XYfXHOfA5DvL1kMEfKgjrglgwv6S+Bcv0UCged59qBsuJ5YSSetlv29VnzYUxWgesblWrIAt20a8Ls51zlUGlydSt3poGQaXq1MgwvLdHtQnOPrE2ddmxNTm36P2myzB7u8Ni2lPHc8eG1Or06b00Fps0V+P1BtTi+szc0hbWovda9Fm244JHGW2+dhizMwxan2sAMW5/Xti0pUhyHO69gY2cTZ18bIfEU6MSHSqv8SkHrRTq8GW4rFPb2y65A2ywuEmUna7MKGclLVN/i/7HtaBXNs+SzI+lVQN94Wtlh4f7Pqa2CzqxDcGrNgbGLmehbQpseDdoYSj7//HXT3C254tCobhUhL6be7Cs/JiU1w6Rr78Tg3qhWWSlqPeU3gDS2vCS0rpJr7+hIZuBdeIw9rc/+3eUPU5uEqb5/abPON3TC12ddXcbxZfUFevPmvvsL3H/8D</diagram></mxfile>">
    <defs></defs>
    <g>
        
            <rect x="0" y="47" width="390" height="290" rx="1.5" ry="1.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" font-size="16px">
                <text x="9.5" y="66.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #795E26">evaluate</tspan><tspan style="fill: #000000">()</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="85" y="82" width="80" height="30" rx="1.5" ry="1.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="124.5" y="103.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #795E26">parse</tspan><tspan style="fill: #000000">()</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="90" y="192" width="70" height="30" rx="1.5" ry="1.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="124.5" y="213.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #795E26">run</tspan><tspan style="fill: #000000">()</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 125 112 L 125 183.88" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 125 190.88 L 121.5 183.88 L 128.5 183.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path>
        <path d="M 125 317 L 125 378.88" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 125 385.88 L 121.5 378.88 L 128.5 378.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path>
        
            <rect x="70" y="287" width="110" height="30" rx="1.5" ry="1.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="124.5" y="308.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #795E26">generate</tspan><tspan style="fill: #000000">()</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 125 222 L 125 278.88" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 125 285.88 L 121.5 278.88 L 128.5 278.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path>
        <path d="M 125 7 L 125 73.88" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 125 80.88 L 121.5 73.88 L 128.5 73.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path>
        
            <rect x="130" y="12" width="170" height="20" fill="none" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="214.5" y="28.5">
<tspan style="fill: #000000">                    (</tspan><tspan style="fill: #001080">y</tspan><tspan style="fill: #000000"> </tspan><tspan style="fill: #0000FF">=&gt;</tspan><tspan style="fill: #000000"> </tspan><tspan style="fill: #001080">y</tspan><tspan style="fill: #000000">)(</tspan><tspan style="fill: #001080">x</tspan><tspan style="fill: #000000"> </tspan><tspan style="fill: #0000FF">=&gt;</tspan><tspan style="fill: #000000"> </tspan><tspan style="fill: #001080">x</tspan><tspan style="fill: #000000">)</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="260" cy="107" rx="30" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="259.5" y="113.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">call</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="190" cy="137" rx="20" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="189.5" y="143.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 237.1 116.69 L 207.36 129.56" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="330" cy="137" rx="20" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="329.5" y="143.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 282.9 116.69 L 312.64 129.56" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="155" cy="167" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="154.5" y="173.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 176.94 148.36 L 166.39 157.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="225" cy="167" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="224.5" y="173.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 203.06 148.36 L 213.61 157.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="295" cy="167" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="294.5" y="173.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 316.94 148.36 L 306.39 157.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="365" cy="167" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="364.5" y="173.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 343.06 148.36 L 353.61 157.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 215 32 L 215 32" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <rect x="130" y="347" width="90" height="20" fill="none" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="174.5" y="363.5">
<tspan style="fill: #000000">                    (</tspan><tspan style="fill: #001080">x</tspan><tspan style="fill: #000000"> </tspan><tspan style="fill: #0000FF">=&gt;</tspan><tspan style="fill: #000000"> </tspan><tspan style="fill: #001080">x</tspan><tspan style="fill: #000000">)</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="190" cy="232" rx="20" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="189.5" y="238.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="155" cy="262" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="154.5" y="268.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 176.94 243.36 L 166.39 252.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="225" cy="262" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="224.5" y="268.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 203.06 243.36 L 213.61 252.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
    </g>
</svg></p>
</figure>

<pre><code class="language-ts"><span style="color: #0000FF">export</span><span style="color: #000000"> </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">evaluate</span><span style="color: #000000">(</span><span style="color: #001080">input</span><span style="color: #000000">: </span><span style="color: #267F99">string</span><span style="color: #000000">): </span><span style="color: #267F99">string</span><span style="color: #000000"> {</span>
<span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #795E26">generate</span><span style="color: #000000">(</span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #795E26">parse</span><span style="color: #000000">(</span><span style="color: #001080">input</span><span style="color: #000000">)));</span>
<span style="color: #000000">}</span></code></pre>
<p>The <code><span style="color: #795E26">parse</span><span style="color: #000000">()</span></code> function prepares the <code><span style="color: #001080">input</span></code> for interpretation, converting it from a string into more convenient data structures (see <a href="#data-structures-to-represent-yocto-javascript-programs">§&nbsp;1.3.2</a> for more on these data structures). The <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> function is responsible for the interpretation itself. The <code><span style="color: #795E26">generate</span><span style="color: #000000">()</span></code> function converts the outputs of <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> into a human-readable format. In the following sections (<a href="#data-structures-to-represent-yocto-javascript-programs">§&nbsp;1.3.2</a>–<a href="#an-operational-semantics-for-the-interpreter">§&nbsp;1.3.14</a>) we address the implementation of <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code>, deferring <code><span style="color: #795E26">parse</span><span style="color: #000000">()</span></code> to <a href="#parser">§&nbsp;1.3.15</a> and <code><span style="color: #795E26">generate</span><span style="color: #000000">()</span></code> to <a href="#generator">§&nbsp;1.3.16</a>.</p>
<p>In later Steps the implementations of <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> and <code><span style="color: #795E26">generate</span><span style="color: #000000">()</span></code> will change, but the implementations of <code><span style="color: #795E26">evaluate</span><span style="color: #000000">()</span></code> and <code><span style="color: #795E26">parse</span><span style="color: #000000">()</span></code> will remain the same, because the architecture and the data structures used to represent Yocto-JavaScript programs will remain the same.</p>
<fieldset>
<legend><span class="legend-wrapper"><strong>Advanced</strong></span></legend>

<p>The <code><span style="color: #795E26">evaluate</span><span style="color: #000000">()</span></code> function is named after a native JavaScript function called <code><span style="color: #795E26">eval</span><span style="color: #000000">()</span></code>&nbsp;[<a href="#javascript-eval">21</a>], which is similar to <code><span style="color: #795E26">evaluate</span><span style="color: #000000">()</span></code> but for JavaScript programs instead of Yocto-JavaScript. The <code><span style="color: #795E26">parse</span><span style="color: #000000">()</span></code> and <code><span style="color: #795E26">generate</span><span style="color: #000000">()</span></code> functions are named after the library functions used to implement them (see <a href="#parser">§&nbsp;1.3.15</a> and <a href="#generator">§&nbsp;1.3.16</a>).</p>
</fieldset>

<h3 id="data-structures-to-represent-yocto-javascript-programs"><span class="heading-counter">1.3.2</span> Data Structures to Represent Yocto-JavaScript Programs<code class="draft"> [](#data-structures-to-represent-yocto-javascript-programs)</code></h3>
<p>The <code><span style="color: #795E26">evaluate</span><span style="color: #000000">()</span></code> function receives an Yocto-JavaScript program represented as a string (see <a href="#architecture">§&nbsp;1.3.1</a>), which is convenient for humans to write and read, but inconvenient for <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> to manipulate directly, because it is concerned with the <em>structure</em> rather than the <em>text</em> of the program: for <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> it does not matter, for example, whether a function is written as <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code> or <code><span style="color: #001080">x</span><span style="color: #0000FF">=&gt;</span><span style="color: #001080">x</span></code>. So before <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> starts interpreting the program, <code><span style="color: #795E26">parse</span><span style="color: #000000">()</span></code> transforms it from a string into more convenient data structures (see <a href="#parser">§&nbsp;1.3.15</a> for <code><span style="color: #795E26">parse</span><span style="color: #000000">()</span></code>’s implementation).</p>
<p>The following are two examples of Yocto-JavaScript programs and the data structures used to represent them:</p>
<table>
<tbody><tr>
<td>

<pre><code class="language-ts"><span style="color: #000000">&gt; </span><span style="color: #795E26">parse</span><span style="color: #000000">(</span><span style="color: #A31515">`x =&gt; x`</span><span style="color: #000000">)</span>
<span style="color: #000000">{</span>
<span style="color: #000000">  </span><span style="color: #A31515">"type"</span><span style="color: #000000">: </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">,</span>
<span style="color: #000000">  </span><span style="color: #A31515">"params"</span><span style="color: #000000">: [</span>
<span style="color: #000000">    {</span>
<span style="color: #000000">      </span><span style="color: #A31515">"type"</span><span style="color: #001080">:</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">,</span>
<span style="color: #000000">      </span><span style="color: #A31515">"name"</span><span style="color: #001080">:</span><span style="color: #000000"> </span><span style="color: #A31515">"x"</span>
<span style="color: #000000">    }</span>
<span style="color: #000000">  ],</span>
<span style="color: #000000">  </span><span style="color: #A31515">"body"</span><span style="color: #000000">: {</span>
<span style="color: #000000">    </span><span style="color: #A31515">"type"</span><span style="color: #000000">: </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">,</span>
<span style="color: #000000">    </span><span style="color: #A31515">"name"</span><span style="color: #000000">: </span><span style="color: #A31515">"x"</span>
<span style="color: #000000">  }</span>
<span style="color: #000000">}</span></code></pre>
</td>
<td align="center">

<p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="101px" height="61px" viewBox="-0.5 -0.5 101 61" content="<mxfile host=&quot;&quot; modified=&quot;2020-05-30T10:20:02.006Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Code/1.45.1 Chrome/78.0.3904.130 Electron/7.2.4 Safari/537.36&quot; etag=&quot;5iildHULOTPwmeuIzloY&quot; version=&quot;13.1.3&quot;><diagram id=&quot;6hGFLwfOUW9BJ-s0fimq&quot; name=&quot;Page-1&quot;>1ZZdb4IwFEB/De9I0ejj/NyL2RK37LnCFepKS0pR3K9foReBMbe4ZMt8IfTcltJzbwsOmSXFStE0XssQuOO5YeGQueN548nYXEtwsmBEhhZEioUWDRqwYW+A0EWasxCyTkctJdcs7cJACgGB7jCqlDx2u+0k786a0gh6YBNQ3qcvLNQxrsJ1G34PLIpx5kkdSGjdF0EW01AeW4gsHDJTUmp7lxQz4KW6Wosdt7wQPb+XAqE/GfCcgXrY7kslnsvp1mSl6lRdR5EZMrVP4Ey82tA+s6SewmaqO32mT7UZA0wSTGNKcy0zm7mBae6k0EuaMF6m/PHJjFpLITGAGR6MTDtLacBEhMP6C8I1HkBpKFoIX2kFMgGtTqYLRr0xysZi82v5xyZ1PqK4lTWCjGKxROcnN0LNDVqomy3FXyovvhPtD25O9PCD6GFfNPk10b3N4Hu4AMpzlIabrm1xW22/cpHM7G8jAkR4Vx4RhgopwJIlK2eeu9f4vWg0k7kKoL2dzPFFVQS6nXnPhbBzCvW9K+BUs0P3ULrC4s9rk9xabRLvf9Wmf6u1Sf6oNk2z+QxWsdavBFm8Aw==</diagram></mxfile>">
    <defs></defs>
    <g>
        
            <ellipse cx="50" cy="15" rx="20" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="49.5" y="21.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="15" cy="45" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="14.5" y="51.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 36.94 26.36 L 26.39 35.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="85" cy="45" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="84.5" y="51.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 63.06 26.36 L 73.61 35.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
    </g>
</svg></p>
</td>
</tr>
<tr>
<td>

<pre><code class="language-ts"><span style="color: #000000">&gt; </span><span style="color: #795E26">parse</span><span style="color: #000000">(</span><span style="color: #A31515">`(y =&gt; y)(x =&gt; x)`</span><span style="color: #000000">)</span>
<span style="color: #000000">{</span>
<span style="color: #000000">  </span><span style="color: #A31515">"type"</span><span style="color: #000000">: </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">,</span>
<span style="color: #000000">  </span><span style="color: #A31515">"callee"</span><span style="color: #000000">: {</span>
<span style="color: #000000">    </span><span style="color: #A31515">"type"</span><span style="color: #000000">: </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">,</span>
<span style="color: #000000">    </span><span style="color: #A31515">"params"</span><span style="color: #000000">: [</span>
<span style="color: #000000">      {</span>
<span style="color: #000000">        </span><span style="color: #A31515">"type"</span><span style="color: #001080">:</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #A31515">"name"</span><span style="color: #001080">:</span><span style="color: #000000"> </span><span style="color: #A31515">"y"</span>
<span style="color: #000000">      }</span>
<span style="color: #000000">    ],</span>
<span style="color: #000000">    </span><span style="color: #A31515">"body"</span><span style="color: #000000">: {</span>
<span style="color: #000000">      </span><span style="color: #A31515">"type"</span><span style="color: #000000">: </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">,</span>
<span style="color: #000000">      </span><span style="color: #A31515">"name"</span><span style="color: #000000">: </span><span style="color: #A31515">"y"</span>
<span style="color: #000000">    }</span>
<span style="color: #000000">  },</span>
<span style="color: #000000">  </span><span style="color: #A31515">"arguments"</span><span style="color: #000000">: [</span>
<span style="color: #000000">    {</span>
<span style="color: #000000">      </span><span style="color: #A31515">"type"</span><span style="color: #001080">:</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">,</span>
<span style="color: #000000">      </span><span style="color: #A31515">"params"</span><span style="color: #001080">:</span><span style="color: #000000"> [</span>
<span style="color: #000000">        {</span>
<span style="color: #000000">          </span><span style="color: #A31515">"type"</span><span style="color: #001080">:</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">,</span>
<span style="color: #000000">          </span><span style="color: #A31515">"name"</span><span style="color: #001080">:</span><span style="color: #000000"> </span><span style="color: #A31515">"x"</span>
<span style="color: #000000">        }</span>
<span style="color: #000000">      ],</span>
<span style="color: #000000">      </span><span style="color: #A31515">"body"</span><span style="color: #001080">:</span><span style="color: #000000"> {</span>
<span style="color: #000000">        </span><span style="color: #A31515">"type"</span><span style="color: #001080">:</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #A31515">"name"</span><span style="color: #001080">:</span><span style="color: #000000"> </span><span style="color: #A31515">"x"</span>
<span style="color: #000000">      }</span>
<span style="color: #000000">    }</span>
<span style="color: #000000">  ]</span>
<span style="color: #000000">}</span></code></pre>
</td>
<td align="center">

<p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="241px" height="91px" viewBox="-0.5 -0.5 241 91" content="<mxfile host=&quot;&quot; modified=&quot;2020-05-30T10:20:17.929Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Code/1.45.1 Chrome/78.0.3904.130 Electron/7.2.4 Safari/537.36&quot; etag=&quot;xZETy3_wJtwz6eiXSjrZ&quot; version=&quot;13.1.3&quot;><diagram id=&quot;6hGFLwfOUW9BJ-s0fimq&quot; name=&quot;Page-1&quot;>1ZjRcqMgFIafxnsFY83lbtq0N512pt3Za6JUaREySBqzT78YjgZj2k5n2kZuHPkB4fzn48xggBdVc63IuryVOeUBCvMmwJcBQuk8Nc9W2FkhwTMrFIrlVooOwgP7R0EMQd2wnNaDgVpKrtl6KGZSCJrpgUaUktvhsCfJh6uuSUFHwkNG+Fj9y3JdQhRheNBvKCtKWHnedVSkGwtCXZJcbh0JXwV4oaTU9q1qFpS31nW22HnLN3r7fSkq9IkJf2qq7lbPrSUo5GRlsrIfZCLjdipn4sVqz7VV+m9H/f76dWu96ywxgnHfNH6TjZa1TVlkmk9S6CWpGG9zff9oZt1KIaEDUhslpl2vScZEAdPGkUBwr1Rp2jgSbOmayopqtTNDoBddgMtAWRwCZVs3Z1YqnXRh0AhQUvRfPjhpXsCFrul4+67X+2dS6D7GdyxH3lkeHVmOx5bH32b5+DxgCIDwDZgG5851cbU/gW2QzBwEYwQV+a+2ShhVSEGtsmTtypfhZ/x909FablTWFZOughFVUO1mHoU0HxSise+KcqLZ67AufcLFr6A09o1SPJsWpTNfKY3PTOnuQzYT39iM0iM2kzGb+AfZvPCBTXSCzWTybKa+sYmO6+aZ2Zz7ymZ6Zjabj9h0LiOesInRpNjsA5g0m/GYzc7GCbPp3a0Iz6fFphe3olNs/tStyDQP/2D2fc5/LHz1Hw==</diagram></mxfile>">
    <defs></defs>
    <g>
        
            <ellipse cx="120" cy="15" rx="30" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="119.5" y="21.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">call</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="50" cy="45" rx="20" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="49.5" y="51.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 97.1 24.69 L 67.36 37.56" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="190" cy="45" rx="20" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="189.5" y="51.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 142.9 24.69 L 172.64 37.56" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="15" cy="75" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="14.5" y="81.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 36.94 56.36 L 26.39 65.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="85" cy="75" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="84.5" y="81.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 63.06 56.36 L 73.61 65.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="155" cy="75" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="154.5" y="81.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 176.94 56.36 L 166.39 65.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="225" cy="75" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="224.5" y="81.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 203.06 56.36 L 213.61 65.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
    </g>
</svg></p>
</td>
</tr>
</tbody></table>

<p>We choose to represent Yocto-JavaScript programs with the data structures above because they match the data structures used by Babel&nbsp;[<a href="#babel">2</a>], which is a library to manipulate JavaScript programs that we use to implement the <code><span style="color: #795E26">parse</span><span style="color: #000000">()</span></code> and <code><span style="color: #795E26">generate</span><span style="color: #000000">()</span></code> functions (see <a href="#parser">§&nbsp;1.3.15</a> and <a href="#generator">§&nbsp;1.3.16</a>).</p>
<p>In general, the data structures used to represent Yocto-JavaScript programs have the following types (written as TypeScript types adapted from the Babel types&nbsp;[<a href="#babel-types">3</a>] to include only the features supported by Yocto-JavaScript):</p>
<pre><code class="language-ts"><span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Expression</span><span style="color: #000000"> = </span><span style="color: #267F99">ArrowFunctionExpression</span><span style="color: #000000"> | </span><span style="color: #267F99">CallExpression</span><span style="color: #000000"> | </span><span style="color: #267F99">Identifier</span><span style="color: #000000">;</span>

<span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">ArrowFunctionExpression</span><span style="color: #000000"> = {</span>
<span style="color: #000000">  </span><span style="color: #001080">type</span><span style="color: #000000">: </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">;</span>
<span style="color: #000000">  </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #267F99">Identifier</span><span style="color: #000000">];</span>
<span style="color: #000000">  </span><span style="color: #001080">body</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">;</span>
<span style="color: #000000">};</span>

<span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">CallExpression</span><span style="color: #000000"> = {</span>
<span style="color: #000000">  </span><span style="color: #001080">type</span><span style="color: #000000">: </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">;</span>
<span style="color: #000000">  </span><span style="color: #001080">callee</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">;</span>
<span style="color: #000000">  </span><span style="color: #001080">arguments</span><span style="color: #000000">: [</span><span style="color: #267F99">Expression</span><span style="color: #000000">];</span>
<span style="color: #000000">};</span>

<span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Identifier</span><span style="color: #000000"> = {</span>
<span style="color: #000000">  </span><span style="color: #001080">type</span><span style="color: #000000">: </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">;</span>
<span style="color: #000000">  </span><span style="color: #001080">name</span><span style="color: #000000">: </span><span style="color: #267F99">string</span><span style="color: #000000">;</span>
<span style="color: #000000">};</span></code></pre>
<p>In later Steps almost everything about the interpreter will change, but the data structures used to represent Yocto-JavaScript programs will remain the same.</p>
<fieldset>
<legend><span class="legend-wrapper"><strong>Technical Terms</strong></span></legend>

<ul>
<li><strong>Parsing&nbsp;[<a href="#dragon-book">1 (§&nbsp;4)</a>]:</strong> The process of converting a program represented as a string into more convenient data structures.</li>
<li><strong>Abstract Syntax Tree&nbsp;(AST)&nbsp;[<a href="#dragon-book">1 (§&nbsp;4)</a>]:</strong> The data structures that represent a program.</li>
</ul>
</fieldset>

<fieldset>
<legend><span class="legend-wrapper"><strong>Advanced</strong></span></legend>

<p>The definitions of the data structures used to represent programs correspond to elements of the Yocto-JavaScript grammar (see <a href="#a-formal-grammar-for-yocto-javascript">§&nbsp;1.1.4</a>); for example, <code><span style="color: #001080">Expression</span></code> corresponds to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.902ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 388.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
</g>
</svg>.</p>
</fieldset>

<h3 id="an-expression-that-already-is-a-value"><span class="heading-counter">1.3.3</span> An Expression That Already Is a Value<code class="draft"> [](#an-expression-that-already-is-a-value)</code></h3>
<figure>

<table>
<thead>
<tr>
<th align="center">Example Program</th>
<th align="center">Current Output</th>
<th align="center">Expected Output</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code></td>
<td align="center">—</td>
<td align="center"><code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code></td>
</tr>
</tbody></table>
</figure>

<p>Having defined the architecture (<a href="#architecture">§&nbsp;1.3.1</a>) and the data structures to represent Yocto-JavaScript programs (<a href="#data-structures-to-represent-yocto-javascript-programs">§&nbsp;1.3.2</a>), we start developing the <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> function. The development is driven by a series of example programs that highlight different aspects of the interpreter. In <a href="#an-expression-that-already-is-a-value">§&nbsp;1.3.3</a>–<a href="#a-reference-to-an-undefined-variable">§&nbsp;1.3.12</a> we begin with these example programs and modify the implementation to achieve the expected output.</p>
<p>Consider the example program above. As mentioned in <a href="#data-structures-to-represent-yocto-javascript-programs">§&nbsp;1.3.2</a>, the <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> function receives as parameter an Yocto-JavaScript program represented as an <code><span style="color: #001080">Expression</span></code>. The <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> function is then responsible for interpreting the program and producing a value. In Yocto-JavaScript, the only kind of value is a function (see <a href="#values-in-yocto-javascript">§&nbsp;1.1.1</a>), so we start the implementation of <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> with the following (we use <code><span style="color: #0000FF">throw</span></code> as a placeholder for code that has not be written yet to prevent the TypeScript compiler from signaling type errors):</p>
<pre><code class="language-ts"><span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Value</span><span style="color: #000000"> = </span><span style="color: #267F99">ArrowFunctionExpression</span><span style="color: #000000">;</span>

<span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): </span><span style="color: #267F99">Value</span><span style="color: #000000"> {</span>
<span style="color: #000000">  </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
<span style="color: #000000">}</span></code></pre>
<p>The first thing that <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> has to do is determine which type of <code><span style="color: #001080">expression</span></code> it is given:</p>
<pre><code class="language-ts{2-9}"><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): </span><span style="color: #267F99">Value</span><span style="color: #000000"> {</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">switch</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000">) {</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">      </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">      </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">      </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">  }</span>
</div><span style="color: #000000">}</span></code></pre>
<p>In our current example, the <code><span style="color: #001080">expression</span></code> already is a <code><span style="color: #001080">Value</span></code>, so we return it unchanged:</p>
<pre><code class="language-ts{3}"><span style="color: #008000">// run()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000">;</span>
</div></code></pre>
<h3 id="a-call-involving-immediate-functions"><span class="heading-counter">1.3.4</span> A Call Involving Immediate Functions<code class="draft"> [](#a-call-involving-immediate-functions)</code></h3>
<figure>

<table>
<thead>
<tr>
<th align="center">Example Program</th>
<th align="center">Current Output</th>
<th align="center">Expected Output</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)</span></code></td>
<td align="center"><code>NOT IMPLEMENTED YET</code></td>
<td align="center"><code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code></td>
</tr>
</tbody></table>
</figure>

<p>Interpreting function calls is the main responsibility of our interpreter. There are several techniques to do this and in Step&nbsp;0 we use one of the simplest: when the interpreter encounters a function call, it substitutes the variable references in the body of the called function with the argument. This is similar to how we reason about functions in mathematics; for example, given the function <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.788ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.057ex;" viewBox="-24.5 -863.1 5075.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f(x) = x + 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D453" d="M345 437c63 0 62 2 91 9l4 -7c-6 -14 -13 -37 -17 -56h-104c-84 -401 -104 -497 -175 -581c-39 -47 -93 -78 -134 -78c-11 0 -26 3 -35 8c5 9 19 57 23 80l14 4c18 -22 29 -29 52 -29c36 0 66 31 84 90c22 69 59 255 89 450l9 56h-81l5 22c25 9 45 17 86 37l15 79 c11 57 23 87 45 109c23 24 105 85 129 96c8 4 24 7 35 7c23 0 54 -6 70 -13l-5 -15c-8 -20 -18 -51 -23 -67l-10 -4c-15 24 -42 39 -72 39c-46 0 -74 -38 -90 -124l-21 -112h16Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-28" d="M146 266c0 -281 109 -403 155 -460l-19 -21c-82 77 -114 116 -149 183c-48 90 -73 191 -73 298c0 276 165 409 222 460l19 -26c-58 -68 -155 -174 -155 -434Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-29" d="M51 726c57 -51 222 -184 222 -461c0 -288 -169 -430 -222 -480l-19 21c51 63 155 184 155 460c0 260 -100 370 -155 434Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-3D" d="M604 347h-539v59h539v-59zM604 134h-539v59h539v-59Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2B" d="M604 241h-240v-241h-59v241h-240v59h240v238h59v-238h240v-59Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-31" d="M418 -3c-16 0 -126 3 -157 3c-11 0 -11 0 -165 -3v30l56 3c54 3 65 14 65 66v518l-150 -66l-7 50l241 102v-604c0 -52 10 -63 65 -66l52 -3v-30Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D453" x="0" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-28" x="550" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="883" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-29" x="1382" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-3D" x="1992" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="2939" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-2B" x="3660" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-31" x="4551" y="0"></use>
</g>
</svg>, we calculate <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.2ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.057ex;" viewBox="-24.5 -863.1 2239 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f(29)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D453" d="M345 437c63 0 62 2 91 9l4 -7c-6 -14 -13 -37 -17 -56h-104c-84 -401 -104 -497 -175 -581c-39 -47 -93 -78 -134 -78c-11 0 -26 3 -35 8c5 9 19 57 23 80l14 4c18 -22 29 -29 52 -29c36 0 66 31 84 90c22 69 59 255 89 450l9 56h-81l5 22c25 9 45 17 86 37l15 79 c11 57 23 87 45 109c23 24 105 85 129 96c8 4 24 7 35 7c23 0 54 -6 70 -13l-5 -15c-8 -20 -18 -51 -23 -67l-10 -4c-15 24 -42 39 -72 39c-46 0 -74 -38 -90 -124l-21 -112h16Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-28" d="M146 266c0 -281 109 -403 155 -460l-19 -21c-82 77 -114 116 -149 183c-48 90 -73 191 -73 298c0 276 165 409 222 460l19 -26c-58 -68 -155 -174 -155 -434Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-32" d="M16 23l170 181c113 120 155 194 155 269c0 85 -55 139 -141 139c-67 0 -103 -25 -119 -83l-13 -46h-29l17 136c49 50 98 70 170 70c127 0 205 -71 205 -186c0 -75 -30 -130 -127 -233l-182 -193c185 4 231 0 346 5v-85c-193 0 -193 3 -229 3s-36 -3 -223 -3v26Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-39" d="M96 -20l-34 17v8c181 44 290 167 298 335l-70 -58c-18 -15 -57 -26 -91 -26c-104 0 -179 84 -179 199c0 134 96 234 224 234c132 0 213 -103 213 -272c0 -134 -51 -249 -148 -332c-54 -46 -102 -69 -213 -105zM240 656c-82 0 -134 -63 -134 -164c0 -104 54 -175 134 -175 c77 0 130 62 130 154c0 45 -12 94 -30 126c-22 40 -55 59 -100 59Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-29" d="M51 726c57 -51 222 -184 222 -461c0 -288 -169 -430 -222 -480l-19 21c51 63 155 184 155 460c0 260 -100 370 -155 434Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D453" x="0" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-28" x="550" y="0"></use>
<g transform="translate(883,0)">
 <use xlink:href="#E1-ASANAMATHMAIN-32"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-39" x="499" y="0"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-29" x="1882" y="0"></use>
</g>
</svg> by substituting the references to <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.16ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 499.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> in <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.905ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2111.9 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x + 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2B" d="M604 241h-240v-241h-59v241h-240v59h240v238h59v-238h240v-59Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-31" d="M418 -3c-16 0 -126 3 -157 3c-11 0 -11 0 -165 -3v30l56 3c54 3 65 14 65 66v518l-150 -66l-7 50l241 102v-604c0 -52 10 -63 65 -66l52 -3v-30Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-2B" x="721" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-31" x="1612" y="0"></use>
</g>
</svg> with the argument <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.32ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 999 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">29</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-32" d="M16 23l170 181c113 120 155 194 155 269c0 85 -55 139 -141 139c-67 0 -103 -25 -119 -83l-13 -46h-29l17 136c49 50 98 70 170 70c127 0 205 -71 205 -186c0 -75 -30 -130 -127 -233l-182 -193c185 4 231 0 346 5v-85c-193 0 -193 3 -229 3s-36 -3 -223 -3v26Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-39" d="M96 -20l-34 17v8c181 44 290 167 298 335l-70 -58c-18 -15 -57 -26 -91 -26c-104 0 -179 84 -179 199c0 134 96 234 224 234c132 0 213 -103 213 -272c0 -134 -51 -249 -148 -332c-54 -46 -102 -69 -213 -105zM240 656c-82 0 -134 -63 -134 -164c0 -104 54 -175 134 -175 c77 0 130 62 130 154c0 45 -12 94 -30 126c-22 40 -55 59 -100 59Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-32"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-39" x="499" y="0"></use>
</g>
</svg>: <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.109ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.057ex;" viewBox="-24.5 -863.1 6074.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">f(29) = 29 + 1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D453" d="M345 437c63 0 62 2 91 9l4 -7c-6 -14 -13 -37 -17 -56h-104c-84 -401 -104 -497 -175 -581c-39 -47 -93 -78 -134 -78c-11 0 -26 3 -35 8c5 9 19 57 23 80l14 4c18 -22 29 -29 52 -29c36 0 66 31 84 90c22 69 59 255 89 450l9 56h-81l5 22c25 9 45 17 86 37l15 79 c11 57 23 87 45 109c23 24 105 85 129 96c8 4 24 7 35 7c23 0 54 -6 70 -13l-5 -15c-8 -20 -18 -51 -23 -67l-10 -4c-15 24 -42 39 -72 39c-46 0 -74 -38 -90 -124l-21 -112h16Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-28" d="M146 266c0 -281 109 -403 155 -460l-19 -21c-82 77 -114 116 -149 183c-48 90 -73 191 -73 298c0 276 165 409 222 460l19 -26c-58 -68 -155 -174 -155 -434Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-32" d="M16 23l170 181c113 120 155 194 155 269c0 85 -55 139 -141 139c-67 0 -103 -25 -119 -83l-13 -46h-29l17 136c49 50 98 70 170 70c127 0 205 -71 205 -186c0 -75 -30 -130 -127 -233l-182 -193c185 4 231 0 346 5v-85c-193 0 -193 3 -229 3s-36 -3 -223 -3v26Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-39" d="M96 -20l-34 17v8c181 44 290 167 298 335l-70 -58c-18 -15 -57 -26 -91 -26c-104 0 -179 84 -179 199c0 134 96 234 224 234c132 0 213 -103 213 -272c0 -134 -51 -249 -148 -332c-54 -46 -102 -69 -213 -105zM240 656c-82 0 -134 -63 -134 -164c0 -104 54 -175 134 -175 c77 0 130 62 130 154c0 45 -12 94 -30 126c-22 40 -55 59 -100 59Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-29" d="M51 726c57 -51 222 -184 222 -461c0 -288 -169 -430 -222 -480l-19 21c51 63 155 184 155 460c0 260 -100 370 -155 434Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-3D" d="M604 347h-539v59h539v-59zM604 134h-539v59h539v-59Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2B" d="M604 241h-240v-241h-59v241h-240v59h240v238h59v-238h240v-59Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-31" d="M418 -3c-16 0 -126 3 -157 3c-11 0 -11 0 -165 -3v30l56 3c54 3 65 14 65 66v518l-150 -66l-7 50l241 102v-604c0 -52 10 -63 65 -66l52 -3v-30Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D453" x="0" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-28" x="550" y="0"></use>
<g transform="translate(883,0)">
 <use xlink:href="#E1-ASANAMATHMAIN-32"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-39" x="499" y="0"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-29" x="1882" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-3D" x="2492" y="0"></use>
<g transform="translate(3438,0)">
 <use xlink:href="#E1-ASANAMATHMAIN-32"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-39" x="499" y="0"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-2B" x="4659" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-31" x="5550" y="0"></use>
</g>
</svg>. The implementation of this substitution technique starts in this section and will only be complete in <a href="#substitution-in-function-calls">§&nbsp;1.3.8</a>.</p>
<p>In the example we are considering both the function that is called (<code><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span></code>) and the argument (<code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code>) are immediate functions, as opposed to being the result of other operations, so for now we may limit the interpreter to handle only this case:</p>
<pre><code class="language-ts{3-7}"><span style="color: #008000">// run()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000"> !== </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000"> ||</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">].</span><span style="color: #001080">type</span><span style="color: #000000"> !== </span><span style="color: #A31515">"ArrowFunctionExpression"</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">  )</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
</div><span style="color: #000000">  </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span></code></pre>
<p>Next, we unpack the called function (using something called <em>destructuring assignment</em>&nbsp;[<a href="#javascript-destructuring-assignment">20</a>]) and the argument:</p>
<pre><code class="language-ts{8-12}"><span style="color: #008000">// run()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #000000">  </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span>
<span style="color: #000000">    </span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000"> !== </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000"> ||</span>
<span style="color: #000000">    </span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">].</span><span style="color: #001080">type</span><span style="color: #000000"> !== </span><span style="color: #A31515">"ArrowFunctionExpression"</span>
<span style="color: #000000">  )</span>
<span style="color: #000000">    </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">  } = </span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">;</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">];</span>
</div><span style="color: #000000">  </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span></code></pre>
<p>Finally, we setup an auxiliary function called <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code> that implements the traversal of the <code><span style="color: #001080">body</span></code> looking for references to <code><span style="color: #001080">parameter</span></code> and substituting them with the <code><span style="color: #001080">argument</span></code> (for now the result of substitution is restricted to be an <code><span style="color: #001080">ArrowFunctionExpression</span></code>):</p>
<figure>

<p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="601px" height="312px" viewBox="-0.5 -0.5 601 312" content="<mxfile host=&quot;&quot; modified=&quot;2020-05-30T21:38:49.873Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Code/1.45.1 Chrome/78.0.3904.130 Electron/7.2.4 Safari/537.36&quot; etag=&quot;fz0L9eT2jwWXTwq6Rcz6&quot; version=&quot;13.1.3&quot;><diagram id=&quot;6hGFLwfOUW9BJ-s0fimq&quot; name=&quot;Page-1&quot;>7Vxbc5s4FP41mdl9CCMQF/GYxHHb3Xab3WQ3TV462Cg2CTZekGO7v36FEcaAAPnCxd5mOh1zJJD8feemg6wLeDNZfvCt2fiLZ2P3QgH28gL2LhQFmYj+HwpWkUDVtEgw8h07EsmJ4N75gZkQMOncsXGQ6kg8zyXOLC0cetMpHpKUzPJ9b5Hu9uK56VFn1gjnBPdDy81LHx2bjCOpDkAi/4id0ZiNbMYNEyvuywTB2LK9xZYI3l7AG9/zSPRpsrzBbghdDEt0X7+gdTMvH08J54a/A+x/HbyGkCjAtQaUlXUneoM1wQT70f2uM32LGkgQSeIBVG0zyc3gAVnFuBC8pMNeB8T33vCN53o+lU+9KW2+fnFcNxZdKPBl/UflluuMplQ2pFOmE4DX79gnDsX6ijVMHNt210/wpqRvTRw31Jq7Bzr0F2/qsQamJLIejj+zhs50RC9BOMCceAFrpZd5iBhq4bh4uSViX/MD9ig2/op2Ya0GY49pr6Ky60WiC3JM+XhLD2LWLaZ+o82TE4roB4ZsfLlFGp911WBfwHLnjAimXQkz9A5qHCGKi7FD8D1FKGxZUPOksjGZuAyeDE39PqB/RZxawSwyrxdnie3jgCvLWhpdg4duHlx5d3CLzMHyR/NJ+A0qrEFTfloD5SfNFwR5vszajKGIwoFnr6ro08FP+ig3GfrMPH1a4/QF80FAHDIn2L4WYPL3z88BWaLZwh5cfvi4WLy+yd8vz4beHJccxgvphaYpQaOSYllvLl493cKpNrMsZ9F7Rm9Xq++9P8hlPH5ZEBv53nxWiAlL9qxB3B3sipWZjusQ5nHiwQR3hymHiQbri+HARLqGDojh5YQJexpFqyuQ5+HUzx9OLZOF1pYm5dEVSDipqU7tEIC1X/N8MvZG3tRyP3vejOH6iglZMV8YOr406nhqX4VLtQRaKuk74aR6+YR0m5cdEQ+8uT/EaTMkNAXEJK1L2E4tCvO8+Ni1iPOeXiMehLN6xlrcgtpq/yu1VdtSW/605Wrw647vStpjqpz4zs2DjCMonz8hN4+uevfuvv7749Huj26+Pl7qSo0GDvZYuVekmiXMFidVUDKaC/x8mGtMrvYqkNQAs9xeOsDHXMDeW3C2sVFwfWPaqZZa7LanLdW5vXk9ulvmT7POFKMjHggaUqak2LZtCKx1z9o21NOwjW7mizFNeOmQb6xX+PkpfiL93FtuNfRW7GJvYlVRYlFTxLJb7zwnLNPHlq6bUqYarSrpZ0Tfld2W0Y/NPA5QGYG6QwdURu6QyhjtqoxhtK0yNb6960oEziLcdvxFZwx5VzA2T8ITNhA8DUFPaCjtekJTkxRZVXUdmCrQDQWmbRZJGtQ0CE2gmVAx4kjXkJc0up0yNxhYhdXpUEdyoDrJAOUiq9mszgiUIE6+7APSZR+9ZbcfO7GzDK38F28NQs6frUB1s+7KOg0LkpnZScIrr3Pfn5tHQGb55bO8+Ac9XN8NZPnp0199Z/5wJuV1WO4AoCrBBgvsfKDr3L3QEaBVmA1nDZYR+ah3OycSyHBKrXY7wynVur2ZPXoZkT9NgRJ7B1LXo66ESvmqJla4JnQosQWpqwwSn1p7VYgPwWnUno+63jlQafS2lQa1rjR17nrrSBhG2Zd5DRa6Sp3VWYLeFYwFCrYd8IYNhFBd0BsanCVco94QahKCZvvVRD6Mp1GcFo+ulGN/9W374mn7IrlpfdWcFjaWoRdooWrmY7JYEZLzLFnSVQOpMjRNZKA4rY+rQLJk6qZBdV6BhqybMD1KBFVtCi1SHj/ZINR62a1UtzuzObuO4pKidQvzrm2IrwPzjJ6jtjEXKKK2vmt+9xhmiK4rDeHNaq1WmQyBgsHJmwbomGl0c49zc6ahnYZp1LndpyOmoSgdezfRTdPYrLCaXS8pogYlvH+2pvWSCSRT1hUTqKoCDHbARaJUUIIyov8ATVIUDcXNTS1yBFbtJ2/Hmeyv7cqbcQo/9d0jxCFRizRPIsShOtf/XTEN0DHT6OZe/8ZMAzVWYj5oe5RQ9pegPHC94VuagxzGV30Aete0ZTj339fsyili5GL4BbZUVRy8E8sO3e2bMabsWS/CZVG94kEFSQHF21ptdZuFHYLi+Wbjogr404rbjfJ2DRS0x7t90sNVdc+CUDQ6v7sml3fPnDenZU8BLKe2qnt2Va2aFf2VHZ+v7fZt5Qz2KtoJHVWreHyWK72if9ZSKqaTC1NFmho/Pzv/qv5ZS4AV/WGmf5ou+iEyxX1T9T/JY28OP81+u3mG/vjp43eC8WbFs+1jqSu8Z5dJILxNpNeHB0vOe1ggaaVvzsrWiOWhV9TDp2MuHy5wYIQsoB5lqAdAkgFUVaQYGtKzD9x7+VZ9itsvv0ZDFR/hVo1L/gi3RGHWaWvRkWuWP2QqAy9yR6xZg8Bz6QyvNp3ktSoSK94PHT+bf2rbkY5p26Sp8dljiLOlN7bkAw8fEzmjjU+HyA8q6jfzQqI5aVw6KcvSWGDCgvYqxO+BJgzzJlyz0T74FtXkwHLT9snNrdH2l27/iMV77DsvpdYK8g4g7MzL7Y9g1BnuNM4PIhDHpI9z7CIVJedIR+qQnMUNb/8D</diagram></mxfile>">
    <defs></defs>
    <g>
        
            <rect x="70" y="0" width="100" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="119.5" y="16.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">parameter</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <ellipse cx="120" cy="35" rx="5" ry="5" fill="#ff0000" stroke="none" pointer-events="all"></ellipse>
        
            <rect x="75" y="60" width="90" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="119.5" y="76.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">argument</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="95" y="150" width="50" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="119.5" y="166.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">body</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="399.37" y="150" width="160" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="478.87" y="166.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">substitutedBody</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <ellipse cx="120" cy="95" rx="5" ry="5" fill="#098658" stroke="none" pointer-events="all"></ellipse>
        <ellipse cx="145" cy="115" rx="5" ry="5" fill="#098658" stroke="none" pointer-events="all"></ellipse>
        <path d="M 123.98 98.03 L 141.1 111.88" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        <ellipse cx="95" cy="115" rx="5" ry="5" fill="#098658" stroke="none" pointer-events="all"></ellipse>
        <path d="M 116.02 98.03 L 98.9 111.88" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        <ellipse cx="118.75" cy="195" rx="5" ry="5" fill="#000000" stroke="none" pointer-events="all"></ellipse>
        <ellipse cx="175" cy="215" rx="5" ry="5" fill="#ff0000" stroke="none" pointer-events="all"></ellipse>
        <path d="M 123.46 196.66 L 170.29 213.32" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <ellipse cx="62.5" cy="215" rx="5" ry="5" fill="#000000" stroke="none" pointer-events="all"></ellipse>
        <path d="M 114.04 196.66 L 67.21 213.32" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 58.96 218.54 L 29.5 232.82" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 66.04 218.54 L 95.5 232.82" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <ellipse cx="100" cy="235" rx="5" ry="5" fill="#000000" stroke="none" pointer-events="all"></ellipse>
        <ellipse cx="25" cy="235" rx="5" ry="5" fill="#000000" stroke="none" pointer-events="all"></ellipse>
        <path d="M 96.46 238.54 L 78.98 251.97" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 103.54 238.54 L 121.02 251.97" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <ellipse cx="125" cy="255" rx="5" ry="5" fill="#ff0000" stroke="none" pointer-events="all"></ellipse>
        <ellipse cx="75" cy="255" rx="5" ry="5" fill="#000000" stroke="none" pointer-events="all"></ellipse>
        <ellipse cx="479.37" cy="195" rx="5" ry="5" fill="#000000" stroke="none" pointer-events="all"></ellipse>
        <ellipse cx="388.74" cy="215" rx="5" ry="5" fill="#000000" stroke="none" pointer-events="all"></ellipse>
        <path d="M 474.48 196.04 L 393.63 213.92" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 385.21 218.54 L 349.64 233.14" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 392.28 218.54 L 427.85 233.14" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <ellipse cx="432.49" cy="235" rx="5" ry="5" fill="#000000" stroke="none" pointer-events="all"></ellipse>
        <ellipse cx="344.99" cy="235" rx="5" ry="5" fill="#000000" stroke="none" pointer-events="all"></ellipse>
        <path d="M 428.96 238.54 L 399.49 252.82" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 436.03 238.54 L 466.46 251.46" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <ellipse cx="394.99" cy="255" rx="5" ry="5" fill="#000000" stroke="none" pointer-events="all"></ellipse>
        <ellipse cx="469.99" cy="255" rx="5" ry="5" fill="#098658" stroke="none" pointer-events="all"></ellipse>
        <ellipse cx="494.99" cy="275" rx="5" ry="5" fill="#098658" stroke="none" pointer-events="all"></ellipse>
        <path d="M 473.97 258.03 L 491.09 271.88" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        <ellipse cx="444.99" cy="275" rx="5" ry="5" fill="#098658" stroke="none" pointer-events="all"></ellipse>
        <path d="M 466.02 258.03 L 448.9 271.88" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        <ellipse cx="569.99" cy="215" rx="5" ry="5" fill="#098658" stroke="none" pointer-events="all"></ellipse>
        <path d="M 484.29 195.9 L 566.46 211.46" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <ellipse cx="594.99" cy="235" rx="5" ry="5" fill="#098658" stroke="none" pointer-events="all"></ellipse>
        <path d="M 573.97 218.03 L 591.09 231.88" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        <ellipse cx="544.99" cy="235" rx="5" ry="5" fill="#098658" stroke="none" pointer-events="all"></ellipse>
        <path d="M 566.02 218.03 L 548.9 231.88" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 90 180 Q 50 200 25 215 Q 0 230 0 245 Q 0 260 20 260 Q 40 260 50 245 Q 60 230 60 250 Q 60 270 65 275 Q 70 280 80 280 Q 90 280 95 265 Q 100 250 110 265 Q 120 280 135 275 Q 150 270 145 255 Q 140 240 105 225 Q 70 210 115 215 Q 160 220 175 230 Q 190 240 195 220 Q 200 200 185 200 Q 170 200 160 195 Q 150 190 140 185 Q 130 180 151.88 180" fill="none" stroke="#af00db" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 158.88 180 L 151.88 183.5 L 151.88 176.5 Z" fill="#af00db" stroke="#af00db" stroke-miterlimit="10" pointer-events="all"></path>
        <path d="M 210 160 L 180 160 L 180 160.1" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <rect x="210" y="145" width="130" height="30" rx="1.5" ry="1.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="274.5" y="166.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #795E26">substitute</tspan><tspan style="fill: #000000">()</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 340 160 L 371.88 160" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 378.88 160 L 371.88 163.5 L 371.88 156.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path>
        <rect x="80" y="290" width="80" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
        <g fill="#AF00DB" font-family="PT Serif" text-anchor="middle" font-size="16px">
            <text x="119.5" y="306.5">
                Traversal
            </text>
        </g>
    </g>
</svg></p>
</figure>

<pre><code class="language-ts{13-19}"><span style="color: #008000">// run()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #000000">  </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span>
<span style="color: #000000">    </span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000"> !== </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000"> ||</span>
<span style="color: #000000">    </span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">].</span><span style="color: #001080">type</span><span style="color: #000000"> !== </span><span style="color: #A31515">"ArrowFunctionExpression"</span>
<span style="color: #000000">  )</span>
<span style="color: #000000">    </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
<span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<span style="color: #000000">    </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<span style="color: #000000">    </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<span style="color: #000000">  } = </span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">;</span>
<span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">];</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">substitutedBody</span><span style="color: #000000"> = </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">body</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">  </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">substitutedBody</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000"> !== </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">)</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">substitutedBody</span><span style="color: #000000">;</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">  </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): </span><span style="color: #267F99">Expression</span><span style="color: #000000"> {</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">  }</span>
</div></code></pre>
<p>Similar to <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> itself, <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code> starts by determining which type of <code><span style="color: #001080">expression</span></code> is passed to it:</p>
<pre><code class="language-ts{2-9}"><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): </span><span style="color: #267F99">Expression</span><span style="color: #000000"> {</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">switch</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000">) {</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">      </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">      </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">      </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">  }</span>
</div><span style="color: #000000">}</span></code></pre>
<p>In our current example the <code><span style="color: #001080">expression</span></code> is <code><span style="color: #001080">y</span></code>, an <code><span style="color: #001080">Identifier</span></code>, and it must be substituted with the <code><span style="color: #001080">argument</span></code> (<code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code>):</p>
<figure>

<p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="491px" height="282px" viewBox="-0.5 -0.5 491 282" content="<mxfile host=&quot;&quot; modified=&quot;2020-05-30T21:48:51.179Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Code/1.45.1 Chrome/78.0.3904.130 Electron/7.2.4 Safari/537.36&quot; etag=&quot;Rv0rVVvNJ_OAsZCgRwif&quot; version=&quot;13.1.3&quot;><diagram id=&quot;6hGFLwfOUW9BJ-s0fimq&quot; name=&quot;Page-1&quot;>7Vpbb+I4GP01SLsPVEmcG49cStvdzm5HnVGnfalMYsCtiSPHKTC/fhziJIRcaQu9qDwg/Nmxne+c4+8kogOGi9UZg/78G3UR6WiKu+qAUUfT7J4tvqPAOg6YwIgDM4bdOKRmgWv8G8mgIqMhdlGQG8gpJRz7+aBDPQ85PBeDjNFlftiUkvyqPpyhQuDagaQYvcEun8u7UJQsfo7wbC5X7iUdC5iMlYFgDl263AqB0w4YMkp5/GuxGiISpS5JS3zduKI33RdDHi+54GeA2P+ThyglmkLgRKCyGSQugAvEEYuvJ9h7jDt4EEeSBXQj3WS6eMDXSV44WollBwFn9BENKaFMxD3qie7BFBOShDoamG4+Ig4Jnnki5ogtiw2AwRNiHItc92XHArsu2cxAPT6GC0wi1lz9EEt/ox6VHZIkqhmt70MHezPRVKIFQk4D2SuaxRTJrEXrotVWSN7mGaIiN2wthsheS6In2ZvScplxQU0gn2/xIEEdSvrN0pkziMQPmdmkuQVaLYiQzcJFdFMNGBraF4YCQyOPoV3EsHd0CCfUXTfBZypf8Als8vCBXhE+4+jwBeEk4JiHHLmDFkj+e3kX8JXtL91J9+x8uXx4VO+7X/DGePZOgNUIsWoeDONCbb09BZ7hQ4iXozv7sb++H/3Hu5Y0Mk+QhBIhWdgzyJDn9iPPIVoTQh1BhsGcL4hMVh5JAVt/rCijgehxQvaEXDlMTDLGhDRlGLk541LMb4M+khhDBHL8lLc7ZQmVK1xRHBWeVJ35AqnvQhLQkDlIXrTtZ3bmSfGtmoiLood4YSKRb7jeGuZHA4L2+zWV/bbVNF4vv42MjPGGM2qmiJWxtUDN7/xmFIIL/5/hHWDz2/N7jlDXLGGiYMe1bFLG53RGPUhOs+iA0dBzN6SLdJ2NuaTUl9x7QJyv5VkQCT9PZ7TC/Je8PPp9G/0+MWRrtNrqGq1loyABZfOJWZ9IR55xmQ6UOh3EBKvLjtJSMC9UgmrvQK8oJ6oCdN0WDsQ2dyes4HMzJ5pL0l9/N9WjmkRV1qOMMGpd/YDMkZQBxXoBJwElYof9dJC6oSKHHE4I2pq7vAS9Us1JbXxScGyjWHBAyaEJDlNwyuFIbquu4Bxe5pVAlxS7fOnahfH9SxgUJXxg0f5gUNA2gCSvz1IHYm/f9Nv7xWvE8HRfwxgNLnNAryDqXeysoom0j/6cUHgyeNg5ibvDCcfnpnPeG156p+ogDAhoOolFAPsBKs/unqa+1JiOx7IqV2BQglQlLKqy8/itF3E54lFr+MFdF91QfvHzypk+nKGL71rXNJuP2pk4Sf3KfMjXj7KIdVJWtc/Tzpsm0PZNk7l/nqrIuvk2ZzwFvpq25WmsP6AOTlulZ5uG3Za2NUyoflgtgqIfjLtVMK2eB079u8CPDM66Epw3P1hACw9HJhsTlZTeFg9D7TFpQGHHULXGIO/Zag4DTYktU1tiPsfL7XnKPVM++qeVT0UBeodqMr7U1KgmvRzkQ6mp0eCW79J6WzUd0uCmby7fk3J6zco5tMHVtcKL/rJUvXeTa73xs9lrFIJeLVAf2ORan+AJpAKc91uWLe3TleVey7KceKbGsmy99IXlUUyuBT6tfD6MybX0LzU1qgmUg/xSNYlm9oe8+KV+9qdGcPoH</diagram></mxfile>">
    <defs></defs>
    <g>
        
            <rect x="0" y="0" width="100" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="49.5" y="16.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">parameter</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="5" y="70" width="90" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="49.5" y="86.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">argument</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="25" y="180" width="50" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="49.5" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">body</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="329.37" y="180" width="160" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="408.87" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">substitutedBody</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 20 210 Q 20 250 55 250 Q 90 250 80 230 Q 70 210 81.88 210" fill="none" stroke="#af00db" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 88.88 210 L 81.88 213.5 L 81.88 206.5 Z" fill="#af00db" stroke="#af00db" stroke-miterlimit="10" pointer-events="all"></path>
        <path d="M 140 190 L 110 190 L 110 190.1" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <rect x="140" y="175" width="130" height="30" rx="1.5" ry="1.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="204.5" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #795E26">substitute</tspan><tspan style="fill: #000000">()</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 270 190 L 301.88 190" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 308.88 190 L 301.88 193.5 L 301.88 186.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path>
        <rect x="10" y="260" width="80" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
        <g fill="#AF00DB" font-family="PT Serif" text-anchor="middle" font-size="16px">
            <text x="49.5" y="276.5">
                Traversal
            </text>
        </g>
        
            <ellipse cx="50" cy="45" rx="15" ry="15" fill="#ffffff" stroke="#ff0000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="49.5" y="51.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="50" cy="115" rx="20" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="49.5" y="121.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="15" cy="145" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="14.5" y="151.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 36.94 126.36 L 26.39 135.24" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="85" cy="145" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="84.5" y="151.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 63.06 126.36 L 73.61 135.24" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="50" cy="225" rx="15" ry="15" fill="#ffffff" stroke="#ff0000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="49.5" y="231.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="409.37" cy="225" rx="20" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="408.87" y="231.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="374.37" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="373.87" y="261.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 396.31 236.36 L 385.76 245.24" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="444.37" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="443.87" y="261.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 422.43 236.36 L 432.98 245.24" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
    </g>
</svg></p>
</figure>

<pre><code class="language-ts{3}"><span style="color: #008000">// substitute()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000">;</span>
</div></code></pre>
<h3 id="substitution-in-function-definitions"><span class="heading-counter">1.3.5</span> Substitution in Function Definitions<code class="draft"> [](#substitution-in-function-definitions)</code></h3>
<figure>

<table>
<thead>
<tr>
<th align="center">Example Program</th>
<th align="center">Current Output</th>
<th align="center">Expected Output</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)</span></code></td>
<td align="center"><code>NOT IMPLEMENTED YET</code></td>
<td align="center"><code><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code></td>
</tr>
</tbody></table>
</figure>

<p>When <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code> (see <a href="#a-call-involving-immediate-functions">§&nbsp;1.3.4</a>) starts traversing the <code><span style="color: #001080">body</span></code> of the example above, the <code><span style="color: #001080">expression</span></code> is an <code><span style="color: #001080">ArrowFunctionExpression</span></code> (<code><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span></code>), and we want substitution to proceed deeper to find and substitute <code><span style="color: #001080">y</span></code>, so we call <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code> recursively (we use a feature called <em>spread syntax</em>&nbsp;[<a href="#javascript-spread-syntax">23</a>] to build an <code><span style="color: #001080">expression</span></code> based on the existing one with a new <code><span style="color: #001080">body</span></code>):</p>
<figure>

<p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="505px" height="322px" viewBox="-0.5 -0.5 505 322" content="<mxfile host=&quot;&quot; modified=&quot;2020-05-30T21:59:01.277Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Code/1.45.1 Chrome/78.0.3904.130 Electron/7.2.4 Safari/537.36&quot; etag=&quot;L8GRUyrTQfOJWiMNf885&quot; version=&quot;13.1.3&quot;><diagram id=&quot;6hGFLwfOUW9BJ-s0fimq&quot; name=&quot;Page-1&quot;>7VvbcuI4EP0aqmYfSNmWbzwGCElmM7uZykxlk5eUwAKcCIuSRYD5+pGxfDeWyXBxsslDymq3ZblPn+5W27RAb7a6pHA+/UYchFua4qxaoN/SNGB0+P9AsA4FmqGHggl1nVCkJoI79xcSQkVIF66D/IwiIwQzd54VjojnoRHLyCClZJlVGxOcvescTlBBcDeCuCi9dx02DaWmoiTyK+ROpuLOnejEDEa6QuBPoUOWKRG4aIEeJYSFR7NVD+HAdJFZwusGW87G66LIYyUX/PQR/Xf4HJhEUzAcclQ2Spv/5oRf0g1nwK73Ep569kNJdAtj7j+20T1h1z9vR+PnS3T9XWtbydrjNflsHZmLCzgyfNCFC0b8EE6VD8fEYwM4c3HgB7c/+FXfiEfECQG7avKxP4cj15uIy3xGyQvqEUzo5gZA6dimYcerTz+/MMkrogytUiKx2EtEZojRNVcRZ/WOfgas8Crhnroh4FomYOtCNE3hDIQMCveaxJMnEPADYaJomAKlEiT+VJBPh2geIpaDSDcq0eB2YAUjesQL8Bm7GKfsOt78Bbhhd+Jx2YjblS8AdAN7upwQ5+LEzHUcjN4GqVJ0jD3gaCkZDOPYkcJQVUpA1A4KIqSTxSx4KAmGhvaJIcfQyGJoFzHsHB3CIXHWMvjM6oD4P4Gvk4UPdIrwGUeHz18MfeayBUNOtwaSf988+mxlz5fOsH15tVw+v6hP7U94Qzw7+UxZBrFqHgzjQgH0cAE8Yw6hu+w/2i/n66f+P6xt2eLJIF4IhET1lSpRPOc8KAz5aIjJiDtDd8pmeFvBcT5QlH6Xnxkt6CtyhBqfZOBiLLMwcjLVZdG+En5EMoowZO5rtiYtM6i4wy1xg8QTszObIPU8JD5Z0BESF6WLztw8qi2ZiPGkh1hhIm5vuE6pzQMFf/t6jdxtTKVyWblVGUq1uqrmprcl+lpO35Do6zn9jkTf2nH9eTgtiX4eNdn68+bP7iz4QYhnwtzYocvIXGDud3bfX4Dr+dfeI6DTh6snhlDbLCEqJ8+dGBLKpmRCPIgvEmmXkoXnbDgZhL1E54aQuaDmM2JsLUJlEBezbEcrl/0nLg+OH4LjM0OM+qvUqf5aDIpbks1fGBSiyCJSQBImlKowEfKvyjpKzXjyh4Gi4CqKcqYqQNdtXqDZZn7CLXSX+4Q8Y3/5S5auKwy1NV0nDlO5J4V0JFwGFNMpHPoE8xWex0rqxhUZZHCI0/vd7dvaPaRkLRfFgG0U8zEoySn72brWZHX0WFX5+PA03wp0SS2Qzex5GJtPYVCk8IFJ+4NC7rY+xFl+lhZodvqhT19O3yHqjnetpwPlsgJxD6TOVzIlnQy7hNKH3UYVNk75RmG7N2TulTm66vRuvAu1u/AxkEXigzcKBwORlfcAi6rkuhN6EZcjhtrSxqxpykPthEfSeX17xF11kdda6c51jUYcqNuIM3e306H622Z1gDplf7sa9vp7+SZ0uFdvA6e6VfqewVlvBefkgQXUqOHwcFNERam3xmaoPib7QiFdolVwX1PCCknqh/us5XaMcm+kj/5h6bMlATWQTcYnm0rd8ghsKiBUZ3uaqplqF0gl5VVdl41bqs2smU6egZVMVV+CSNry5juohH5JTQ4+gskbEZGjSNOc4Ju1bS4Cllk2G3ijQiQdYzP+coRaRNoeMKs/Ujl2J+DPYkajKow6e/73789GOSCH8ucdsqF1Ys/eLTRLPoYzCq/4y2qRBiZIy/xAKGhFFEo+STxijLGsdxxjSkJM9KFZOsRkPOiQGw6r01RjcpPRdfwqPBg8pAfJq/DNKHoXvj8I5B8b7+8VmaGoWYbpZnaKvb8ie1u/xmpuL3rnVygGKH5rXfIF2anbM5bWNIJKMZA2YqKSVU63ul+tNautaZ16g7zPnySY74MmjdtIH5Mm4Eg04cPk90Fh8kl+YwUufgM=</diagram></mxfile>">
    <defs></defs>
    <g>
        
            <ellipse cx="453.37" cy="255" rx="20" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="452.87" y="261.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="9" y="0" width="100" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="16.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">parameter</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="14" y="70" width="90" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="86.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">argument</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="34" y="180" width="50" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">body</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="338.37" y="180" width="160" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="417.87" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">substitutedBody</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 29 210 Q -11 250 4 270 Q 19 290 34 280 Q 49 270 54 255 Q 59 240 69 260 Q 79 280 94 285 Q 109 290 119 275 Q 129 260 124 250 Q 119 240 104 225 Q 89 210 110.88 210" fill="none" stroke="#af00db" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 117.88 210 L 110.88 213.5 L 110.88 206.5 Z" fill="#af00db" stroke="#af00db" stroke-miterlimit="10" pointer-events="all"></path>
        <path d="M 149 190 L 119 190 L 119 190.1" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <rect x="149" y="175" width="130" height="30" rx="1.5" ry="1.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="213.5" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #795E26">substitute</tspan><tspan style="fill: #000000">()</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 279 190 L 310.88 190" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 317.88 190 L 310.88 193.5 L 310.88 186.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path>
        <rect x="19" y="300" width="80" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
        <g fill="#AF00DB" font-family="PT Serif" text-anchor="middle" font-size="16px">
            <text x="58.5" y="316.5">
                Traversal
            </text>
        </g>
        
            <ellipse cx="59" cy="45" rx="15" ry="15" fill="#ffffff" stroke="#ff0000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="51.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="59" cy="115" rx="20" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="121.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="24" cy="145" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="23.5" y="151.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 45.75 126.23 L 35.36 135.21" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="94" cy="145" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="93.5" y="151.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 72.25 126.23 L 82.64 135.21" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="59" cy="225" rx="20" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="231.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="24" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="23.5" y="261.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">z</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 45.75 236.23 L 35.36 245.21" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="94" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#ff0000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="93.5" y="261.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 72.25 236.23 L 82.64 245.21" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="418.37" cy="225" rx="20" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="417.87" y="231.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="383.37" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="382.87" y="261.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">z</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 405.12 236.23 L 394.73 245.21" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 430.83 236.73 L 439.13 244.46" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="488.37" cy="295" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="487.87" y="301.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 464.33 267.55 L 478.52 283.68" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="418.37" cy="295" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="417.87" y="301.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 442.41 267.55 L 428.22 283.68" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
    </g>
</svg></p>
</figure>

<pre><code class="language-ts{3-6}"><span style="color: #008000">// substitute()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> {</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    ...</span><span style="color: #001080">expression</span><span style="color: #000000">,</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #001080">body:</span><span style="color: #000000"> </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">body</span><span style="color: #000000">),</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">  };</span>
</div></code></pre>
<h3 id="name-mismatch"><span class="heading-counter">1.3.6</span> Name Mismatch<code class="draft"> [](#name-mismatch)</code></h3>
<figure>

<table>
<thead>
<tr>
<th align="center">Example Program</th>
<th align="center">Current Output</th>
<th align="center">Expected Output</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code><span style="color: #000000">(</span><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code></td>
<td align="center"><code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> (</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code></td>
<td align="center"><code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code></td>
</tr>
</tbody></table>
</figure>

<p>The implementation of <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code> in the case of <code><span style="color: #001080">Identifier</span></code> introduced in <a href="#a-call-involving-immediate-functions">§&nbsp;1.3.4</a> <em>always</em> substitutes variable references, regardless of whether they refer to the <code><span style="color: #001080">parameter</span></code> of the called function. For example, in the program above <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code> is substituting the <code><span style="color: #001080">x</span></code> even though the <code><span style="color: #001080">parameter</span></code> is <code><span style="color: #001080">z</span></code>. To fix this, we check whether the variable reference matches the <code><span style="color: #001080">parameter</span></code>, and if it does not then we prevent the substitution by retuning the variable reference unchanged:</p>
<figure>

<p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="500px" height="322px" viewBox="-0.5 -0.5 500 322" content="<mxfile host=&quot;&quot; modified=&quot;2020-05-30T22:01:15.051Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Code/1.45.1 Chrome/78.0.3904.130 Electron/7.2.4 Safari/537.36&quot; etag=&quot;_7n10jHyU80J8B2enFTl&quot; version=&quot;13.1.3&quot;><diagram id=&quot;6hGFLwfOUW9BJ-s0fimq&quot; name=&quot;Page-1&quot;>7VrbcuI4EP0aqnYfSNkWNuYxQEiym9mdqcxUNnlJCVsBJcJyyXKA+fqRsXy/soHgTIUHym61LblP9+ljQQ9MVptLBt3lF2oj0tMUe9MD056mmSNTfAeGbWgwgB4aFgzboUlNDLf4J5JGRVp9bCMv48gpJRy7WaNFHQdZPGODjNF11u2JkuysLlygguHWgqRovcM2X8qnUJTEfoXwYilnHkUDKxj5SoO3hDZdp0zgogcmjFIeHq02E0SC0EVhCa+bVYzG62LI4SUX/PAQ+3f+HIREUwicC1R2TuICuEIcsfB6gp2XcIB7oSWaYKDHi4wn9/g2igtHGzHt2OOMvqAJJZQJu0MdMTx+woREpp4GnnYfYYcELxxhs8SSxQLA+BUxjkWsz+XACts22d2BOnwGV5gEWfP1u5j6C3WoHJBJohrB/C60sLMQp0owgc+pJ0fFaTFEMmrBvGiTMsnHvERUxIZthYscHUr0ZPbGablOckGNIF+m8iBCHcr0W8R3TiASBzKy0WkKtFoQIVv4q+ChGjDUtU8MBYZ6FkOziOHo3SGcU3vbBJ+hfMInsMnCB0ZF+PR3h8/z5x7H3OfIHrdA8u+bB49vTHdtz/uXV+v184v62P+EN8RzdAaGjRCrxtEwLvTW+wvg6C6EeD19MF/Ot4/Tf3h/KIXMKyS+REg29gQy5NjngeYQZ3NCLZEM4yVfERmsLJICtvOZokzHYsTy2SuypZu4yQwT0hRhZGeESzG+DfUR2RgikOPXrNwpC6ic4SvFQeOJqzPbIAd5SDzqMwvJi9J6Jncf1Wy4ERdND/HCjUS84Tbl5gYOXvV69dw0hlK7rNyqdKXeXVVztzcb/LWcv97gP8j5jxr8h3uuPw/nsME/j1rT+vPhz4pWcRDimVRunNBlxVyo3G/8buqDa/evyQNgy/urR45Q3ygpVFE8t/KUMr6kC+pAcpFYx4z6jr2ryYD2Ep8bSl1Zms+I862kyoAXs9WONpj/Jy8Pju+D4zNdnk03qaHpVp4UGELZfUJSiJhFtoCEJpQ6mgjrry46Sks+eSNRFFJFUc5UBQwGphBoppG/YUW5N+dEc8f+48+mdl0TqMp2nSSMWtdeIbNkyoBiO4VzjxKxwvPYSd2lIocczglK3bu8Qx+oJWs5FgOmXuzHoKSngOP043I4oseq68fHL/NKoEu0QLaz52HsfgmDYgkfuWi/MyjS1oMkW5+lAs1MP/Tp5fQtYvhpXz0dOJcJxAMUdV7JlOxkmCUlfdzXqJ95Jn7OMXF/Muf4yrCuRpMb50Id+x4BTUwsDNj1UHl093znKdXts5nsygeARVVyuxODIi7vSLW66z300R3l1z++Wk/Pl+j6m9Y3jGaqXQgmddvHI96wlX2tl94UbbERB9puxBn7x6kqWXffxoLHwFenbXkY6wnq6GmrjExDN0vTth729u/yRVAGR8vdKpgKmzHtwKnfKv3I4GwrwTk5sYAWGo7MdyIqar0tXobaY3IoFNISrab2NSVUSI15eEgttyfL/c/yGfy25VPRgDpYTfpnNZWm5TtUUwGhNq+n76yZ4i3Vbmqmk3dgpVLVG3vL+k4ooU1jyMHvEPJOMHLENN0h3+bYpnk20h1pSo3k2cm0SHMC1/9J5YMkcBcVRpt3/g+Xz/qp1MBwtJcaaN36S4RDZXoNtMIP7R1XBOaJ9/lyKVeCSjr6IcYfXBE0bKJ/kJB3gkFNrdsMmmPBsshmKTX6eSBNqWbXFIHZLUn7Ns7olCIwO65wD5PPoByQt+azOE3+6h3+Hpr8XR5c/AI=</diagram></mxfile>">
    <defs></defs>
    <g>
        
            <rect x="9" y="0" width="100" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="16.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">parameter</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="14" y="70" width="90" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="86.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">argument</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="34" y="180" width="50" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">body</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="338.37" y="180" width="160" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="417.87" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">substitutedBody</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 29 210 Q -11 250 4 270 Q 19 290 34 280 Q 49 270 54 255 Q 59 240 69 260 Q 79 280 94 285 Q 109 290 119 275 Q 129 260 124 250 Q 119 240 104 225 Q 89 210 110.88 210" fill="none" stroke="#af00db" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 117.88 210 L 110.88 213.5 L 110.88 206.5 Z" fill="#af00db" stroke="#af00db" stroke-miterlimit="10" pointer-events="all"></path>
        <path d="M 149 190 L 119 190 L 119 190.1" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <rect x="149" y="175" width="130" height="30" rx="1.5" ry="1.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="213.5" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #795E26">substitute</tspan><tspan style="fill: #000000">()</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 279 190 L 310.88 190" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 317.88 190 L 310.88 193.5 L 310.88 186.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path>
        <rect x="19" y="300" width="80" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
        <g fill="#AF00DB" font-family="PT Serif" text-anchor="middle" font-size="16px">
            <text x="58.5" y="316.5">
                Traversal
            </text>
        </g>
        
            <ellipse cx="59" cy="45" rx="15" ry="15" fill="#ffffff" stroke="#ff0000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="51.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">z</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="59" cy="115" rx="20" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="121.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="24" cy="145" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="23.5" y="151.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 45.94 126.36 L 35.39 135.24" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="94" cy="145" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="93.5" y="151.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 72.06 126.36 L 82.61 135.24" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="59" cy="225" rx="20" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="231.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="24" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="23.5" y="261.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 45.94 236.36 L 35.39 245.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="94" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="93.5" y="261.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 72.06 236.36 L 82.61 245.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="418.37" cy="225" rx="20" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="417.87" y="231.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="383.37" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="382.87" y="261.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 405.31 236.36 L 394.76 245.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="453.37" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="452.87" y="261.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 431.43 236.36 L 441.98 245.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
    </g>
</svg></p>
</figure>

<pre><code class="language-ts{3}"><span style="color: #008000">// substitute()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000"> !== </span><span style="color: #001080">parameter</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">) </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000">;</span>
</div><span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000">;</span></code></pre>
<h3 id="name-reuse"><span class="heading-counter">1.3.7</span> Name Reuse<code class="draft"> [](#name-reuse)</code></h3>
<figure>

<table>
<thead>
<tr>
<th align="center">Example Program</th>
<th align="center">Current Output</th>
<th align="center">Expected Output</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code><span style="color: #000000">(</span><span style="color: #FF0000">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #008000">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">x</span><span style="color: #000000">)(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code></td>
<td align="center"><code><span style="color: #008000">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> (</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code></td>
<td align="center"><code><span style="color: #008000">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">x</span></code></td>
</tr>
</tbody></table>
<!--
| `` js`(x => x => x)(y => y) `` | `` js`x => (y => y) `` | `` js`x => x `` |
<code><span style="color: #FF0000">x</span></code>
<code><span style="color: #008000">x</span></code>
<code><span style="color: #795E26">x</span></code>
-->

</figure>

<p>In the program above, <code><span style="color: #795E26">x</span></code> could refer to either <code><span style="color: #FF0000">x</span></code> or <code><span style="color: #008000">x</span></code>:</p>
<figure>

<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">If <code><span style="color: #795E26">x</span></code> Refers to</th>
<th align="center">Then the Output of Example Program Is</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>Option 1</strong></td>
<td align="center"><code><span style="color: #FF0000">x</span></code></td>
<td align="center"><code><span style="color: #008000">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> (</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code></td>
</tr>
<tr>
<td align="center"><strong>Option 2</strong></td>
<td align="center"><code><span style="color: #008000">x</span></code></td>
<td align="center"><code><span style="color: #008000">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">x</span></code></td>
</tr>
</tbody></table>
</figure>

<p>Currently <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code> is implementing Option&nbsp;1, but this leads to an issue: we are unable to reason about <code><span style="color: #008000">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">x</span></code> independently; we must know where it appears and whether a variable called <code><span style="color: #FF0000">x</span></code> is already defined there.</p>
<p>We avoid this issue by modifying <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code> to implement Option&nbsp;2, which is also the choice of JavaScript and every other popular programming language. We change <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code>’s behavior when encountering a function definition so that if the parameter of the function definition matches the parameter that <code><span style="color: #795E26">subsitute</span><span style="color: #000000">()</span></code> is looking for, then <code><span style="color: #795E26">subsitute</span><span style="color: #000000">()</span></code> returns the function unchanged, preventing further substitution (there is no recursive call to <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code> in this case):</p>
<figure>

<p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="500px" height="322px" viewBox="-0.5 -0.5 500 322" content="<mxfile host=&quot;&quot; modified=&quot;2020-05-30T22:07:08.341Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Code/1.45.1 Chrome/78.0.3904.130 Electron/7.2.4 Safari/537.36&quot; etag=&quot;8f6yjkPPo5QL37UzM_ti&quot; version=&quot;13.1.3&quot;><diagram id=&quot;6hGFLwfOUW9BJ-s0fimq&quot; name=&quot;Page-1&quot;>7Vrbcqs2FP0az7QPzghkMH70NUmb0+ZMzpk0ecnIoNgkMmKEiO1+fYURdwy49YV04gcP2tpIYq99WRJ04Hi1uWbIXX6jFiYdFVibDpx0VNUYGOI/EGxDgQ61ULBgthWKlETwYP+NpRBIqW9b2MsockoJt92s0KSOg02ekSHG6Dqr9kpJdlYXLXBB8GAiUpQ+2hZfyqcAIJHfYHuxlDMPoo4VinSlwFsii65TIjjtwDGjlIdXq80Yk8B0kVnC+2Z7euN1Mezwkht+epj9OX8LTKICguYClZ2SuAGtMMcsvJ/YznvYwb1QEk3Q0+JFxpN7fBvZheONmHbkcUbf8ZgSyoTcoY7oHr3ahESijgpfdz8hR8ReOEJmiiWLBcDRB2bcFrYeyo6VbVlkNwJ1+AytbBJ4zf0PMfU36lDZIZ1E0YP5XWTazkI0QTCBz6kne0WzaCJptWBevEmJ5GNeYypsw7ZCRfb2JXrSe2O3XCe+oESQL1N+EKGOpPst4pETiMSFtGzUTIFWCSJiC38VPFQNhpr6haHAUMtiaBQxHJwdwjm1tnXw6eALPoFNFj44KMKnnR0+z5973OY+x9aoAZK/3z17fGO4a2vevb5Zr9/elZfuF7whnoMr2K+FWNFPhnGhtj5NoaO5CNnrybPxPty+TP7g3b4kMh+I+BIhWdgTyLBjDQPOIVpzQk3hDKMlXxFprCySArbhDIDJSPSYPvvAllQTg8xsQuosjK0McSnatyY+IhnDBHH7I0t3ygwqZ7indlB44ujMFsheHhKP+szE8qY0n8mNoxg1A3FR9DAvDCTsjbYpNTdQ8PavV8tNo4PKZeVWpYFqdUXJDW/U6Ks5fa1Gv5fTH9To9w9cfx7Ofo1+HrW69efNnyWt4iLEM4nc2KHLgrkQud/548SHt+5v42fIlk83Lxzjrl4SqCJ4HmSTMr6kC+ogMk2kI0Z9x9rFZJD2Ep07Sl0Zmm+Y861MlUFezEY73tj8L3l7cP0UXF9psjXZpLomW9koZAiw+4VJIcossgQkaQJUpYkw/qqsAxrmk/+YKAquAsCVAmCvZwiCZuj5AfeEe71P1FfsX36tK9cVhtpbrhOHUarKK2KmdBlYLKdo7lEiVjiMlZSdK3LE0Zzg1NjlFfpIJVnNZTFoaMV6DEtqCjxNPS6HI3qsqnp8+jDfC3QJF8hW9jyM7Q9hWAzhEwftD4aE23qIZOOzlKAZ6Ye+PJ1+wMx+PZRPB8plBPEIQZ1nMiUnGUZJSJ92G7XJ4todz7l9o5s3g/GdM1VGvkdgXd4VAtv1cLktD9zhlLL02UzW4Bw4sfwI4Cggd0bRK6JzxoSrud5zFz9Sfvvz3nx9u8a339Wurtcn3IXIp25ze8THtrK6ddJHow2O42DT4zj9cDvtc9ndv77gMfAJjXjLH7+VmrE6TZ3cncHA0DWj1G2rYW++oy+C0juZ7+6DqXAk0wyc6gPTzwzOdi84F08ssAGTI/MdlYoKcIMtUXNMjoVCmqhVxL4KQp5U64fHZHQHZrl/GT69/2347ClALYwm7SuaSt3yDNFUQKjJJvXMnCk+WG0nZ7p4BQZ7Wb1+MK1vBRPK7bHCatsCA+e2UwAYRzB8K/JylG/ak4LrnTqdbSP2kU6sEUm7GCPJu3H15ykXc+P+QJuq5cd5h+ePVrGNJvv/T+fV2qWYQX9weWbQUwuv3lvODowLnwVWuFwM6KdmBzWH6G1kBwcYvhV51FA/Tx6NbJvOo9FbgnQeNZp+lHImdmC0lORWsIPD80er2IHxiThvY68+F+cVzeRD8PBtafIxPZz+Aw==</diagram></mxfile>">
    <defs></defs>
    <g>
        
            <rect x="9" y="0" width="100" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="16.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">parameter</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="14" y="70" width="90" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="86.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">argument</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="34" y="180" width="50" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">body</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="338.37" y="180" width="160" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="417.87" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">substitutedBody</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 29 210 Q -11 250 4 270 Q 19 290 34 280 Q 49 270 54 255 Q 59 240 69 260 Q 79 280 94 285 Q 109 290 119 275 Q 129 260 124 250 Q 119 240 104 225 Q 89 210 110.88 210" fill="none" stroke="#af00db" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 117.88 210 L 110.88 213.5 L 110.88 206.5 Z" fill="#af00db" stroke="#af00db" stroke-miterlimit="10" pointer-events="all"></path>
        <path d="M 149 190 L 119 190 L 119 190.1" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <rect x="149" y="175" width="130" height="30" rx="1.5" ry="1.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="213.5" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #795E26">substitute</tspan><tspan style="fill: #000000">()</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 279 190 L 310.88 190" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 317.88 190 L 310.88 193.5 L 310.88 186.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path>
        <rect x="19" y="300" width="80" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
        <g fill="#AF00DB" font-family="PT Serif" text-anchor="middle" font-size="16px">
            <text x="58.5" y="316.5">
                Traversal
            </text>
        </g>
        <ellipse cx="59" cy="45" rx="15" ry="15" fill="#ffffff" stroke="#ff0000" pointer-events="all"></ellipse>
        <g fill="#FF0000" font-family="PT Mono" text-anchor="middle" font-size="16px">
            <text x="58.5" y="51.5">
                x
            </text>
        </g>
        
            <ellipse cx="59" cy="115" rx="20" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="121.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="24" cy="145" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="23.5" y="151.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 45.94 126.36 L 35.39 135.24" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="94" cy="145" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="93.5" y="151.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 72.06 126.36 L 82.61 135.24" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="59" cy="225" rx="20" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="58.5" y="231.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <ellipse cx="24" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
        <g fill="#008000" font-family="PT Mono" text-anchor="middle" font-size="16px">
            <text x="23.5" y="261.5">
                x
            </text>
        </g>
        <path d="M 45.94 236.36 L 35.39 245.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <ellipse cx="94" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
        <g fill="#795E26" font-family="PT Mono" text-anchor="middle" font-size="16px">
            <text x="93.5" y="261.5">
                x
            </text>
        </g>
        <path d="M 72.06 236.36 L 82.61 245.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="418.37" cy="225" rx="20" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="417.87" y="231.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <ellipse cx="383.37" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
        <g fill="#008000" font-family="PT Mono" text-anchor="middle" font-size="16px">
            <text x="382.87" y="261.5">
                x
            </text>
        </g>
        <path d="M 405.31 236.36 L 394.76 245.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <ellipse cx="453.37" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
        <g fill="#795E26" font-family="PT Mono" text-anchor="middle" font-size="16px">
            <text x="452.87" y="261.5">
                x
            </text>
        </g>
        <path d="M 431.43 236.36 L 441.98 245.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
    </g>
</svg></p>
</figure>

<pre><code class="language-ts{3}"><span style="color: #008000">// substitute()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">params</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">].</span><span style="color: #001080">name</span><span style="color: #000000"> === </span><span style="color: #001080">parameter</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">) </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000">;</span>
</div><span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> {</span>
<span style="color: #000000">    ...</span><span style="color: #001080">expression</span><span style="color: #000000">,</span>
<span style="color: #000000">    </span><span style="color: #001080">body:</span><span style="color: #000000"> </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">body</span><span style="color: #000000">),</span>
<span style="color: #000000">  };</span></code></pre>
<fieldset>
<legend><span class="legend-wrapper"><strong>Technical Terms</strong></span></legend>

<ul>
<li><strong>Local Reasoning:</strong> The ability to reason about a function without having to know the context under which it appears. Option&nbsp;1 defeats local reasoning and Option&nbsp;2 enables it.</li>
<li><strong>Shadowing:</strong> The behavior exhibited by Option&nbsp;2: <code><span style="color: #FF0000">x</span></code> is <em>shadowed</em> by <code><span style="color: #008000">x</span></code> because there is no way to refer to <code><span style="color: #FF0000">x</span></code> from the body of the inner function.</li>
</ul>
</fieldset>

<h3 id="substitution-in-function-calls"><span class="heading-counter">1.3.8</span> Substitution in Function Calls<code class="draft"> [](#substitution-in-function-calls)</code></h3>
<figure>

<table>
<thead>
<tr>
<th align="right"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="right"><strong>Example Program</strong></td>
<td align="left"><code><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">y</span><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000">))(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)</span></code></td>
</tr>
<tr>
<td align="right"><strong>Current Output</strong></td>
<td align="left"><code>NOT IMPLEMENTED YET</code></td>
</tr>
<tr>
<td align="right"><strong>Expected Output</strong></td>
<td align="left"><code><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> (</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)</span></code></td>
</tr>
</tbody></table>
</figure>

<p>This case is similar to <a href="#substitution-in-function-definitions">§&nbsp;1.3.5</a>: all <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code> has to do is continue traversing the function call recursively:</p>
<figure>

<p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="544px" height="362px" viewBox="-0.5 -0.5 544 362" content="<mxfile host=&quot;&quot; modified=&quot;2020-05-30T22:15:12.590Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Code/1.45.1 Chrome/78.0.3904.130 Electron/7.2.4 Safari/537.36&quot; etag=&quot;CBvrOUY_KjD85OVVFj0H&quot; version=&quot;13.1.3&quot; pages=&quot;2&quot;><diagram id=&quot;6hGFLwfOUW9BJ-s0fimq&quot; name=&quot;Page-1&quot;>7VzbcqM4EP0aV+0+2IUQAvEY27ntZHYzlZmaTV5S2Cg2CUYukBN7vn6FETZ3cAyGySYPKaslBO7TffqCkh4cLdaXrrGcf6UmsXuyZK57cNyTZaxj/tsXbAKBClEgmLmWGYjAXnBn/SJCKAnpyjKJF1vIKLWZtYwLp9RxyJTFZIbr0rf4sidqx++6NGYkJbibGnZa+tMy2Vx8C0nay6+INZuLO+vhxMII1wqBNzdM+hYRwfMeHLmUsuDTYj0itq+6UC3BdRc5s7vnconDMi744RH3n8mzrxJZso0JR2W7iF9gLAgjbnC9bTkvwQTzAkl4AwXtHnJ3c49tQr0wsua3HXrMpS9kRG3qcrlDHT49fLJsOxT1ZPi0/eFyw7ZmDpdN+SPzB4DDV+Iyi+v6TEwsLNO0tztQh10YC8v2reb2O7/1V+pQMSGMBKj+/ZfG1HJmfCj5N1gx6olZPkyrSGjNvy9ZR0Tia14SynXjbvgSMasJ9IT17szybW8LIIR8HrGDEHVDmN9st/MeIv5BaDYcRkArBNFwZ6uF/6VKMETyJ4YcQxTHEKcx1E8O4YSamzL4VOkTPo5NHD6op+FDJ4fPW008ZrEVI+awApJfbh48tsbLN3PSv7x6e3t+AY/9T3gDPPUB1EohBmpjGKdi6/05dNDSMKy38QN+Ods8jv9mfU0kMq+GvRIIicC+h4w45pmfc/DRxKZTbgzDOVvYQllxJDlsZxeSNB7ymenKfSWmWMY3ubBsu0zDxIwlLmn9lvhHKHOJbTDrNZ7uZClU3OGWWn7g2XlnPEAqSUg8unKnRFwUzWcS+wBcshHjQY+w1EZc38YmsmzpL/DynzcR0BVFKnwslFiOi5cntIGk4uUAJLbXStbDA9cn9kfgsP0RKlmf0CZKJq1lIOsl65P6LNlfPvD5ZfWw50nur5TpR0msh7H1/ENgvnui2vlvFneliOob+zlewevlX6MH6M7vrx4ZIX01g5c4V9yJIXXZnM6oY9jne+nQpSvH3FKQz/L7NTeULgUTPRPGNiIy+GEgTm5kbbF/xeX+53v/8wCJ0XgdmRpvxCBFiNL2J+DAkEhFxNuzolTEigHdFGlHqkifR/JiytQlaQAkqCiY56NYTW6Yw27lNlGeoPzxZ68kOylQVG52sjcYUJRNGO5UmAxMZw/GxKM2f8Kz3SKwNUVmMGNik8je2QlJTRmInGBJiEXGGU0/Qs+PhtBQVnP6kQ1H+LWK0o/m3TwX6IzUJ57IJGHsvgvDtAs37LTfXYObrWfYcf/MzEdx9Eu3Xz3cEdd6OrR88Bdn5cM1ODXOzgSiPo0zXLrZqjFVJz4nmLg/mjDrSp1e6aMb5xwMV54Ny5iYC6ylR7K1e2CJl1mmXFyIqFwDLEBKNGOUNC4npFq09B765Cdl1z9up0/Pl+T6m9xX1XKqnXEmXVbXx64/LeJaL9oDrtB3hFX7jurhesoz1u1vdcZ2wOebbbYaiwmqcbOVdKwinGm2xbBXb12kQVEas908mNbvA0f+sOBscsFpnVhghRzOnmyTqDD0ViiGqmNSFwrRFK3A92UpyJBK7bDOXO5Alnun+ygf1n1yAlAHvQl9elOmWZ7Am1IIzbTbx6XkXPRHEv7ybWle37Avfb0CQpFEqnLWlJFzVbXjXVs59moBpS0ZJIu9IzimNO3P1h5sl2MSaX8GOlEUCgwgF5tE91U7JcfkYcVJwn4XXPi0VVpjoCQKZ5juhWW9iWuI+LM1LbdL/JkcW1nxcb4vMKU435dTRH2NL6QNoKpgVcaKrOhIi7+d1eQBQpoOkC4rqqJo8d3f3ROriL3yib3YUWkEe6DKAxUiADWANASUAuix3vRLjHcGzpaT8+YDJ4DxLlonImever+o9e6DlNvRLE5kf6/W0K9SHFpOMRvEoRN1q9pytKpN4dGwFbZsohEq7GydvvCs0qz/ECouzBaafhWqwQHCiqZBFUJVUoAeCz8QDWQV61iDSNd0qCHUcF7w7iIt+GuEbhVpxYFEUVLHIxXUvZpM19t1w0w3KD1eUGAjFZwPSFojzqYgZaBrqioBDWgYyGocfV0ZQB1CHctYBlgLp09UgO36Ym0hzfF0N7uTZv7gPjrYnzTbjsKjZq3YB2ioPJfwQMIA+qW5DnUVw4SBoAHYnjXEGOiaDJpm4wMS/xyT6lY5cBRfZxxnz+o5d7AYyMGmWyXCcdioGbG01QIhR+cdLxtqoVHh9ZXi7LE8etRbrN2RpU840jl0jVmPIg90tK8x5ISfJmuMzge1aHLY/hGB44gTp4lTTxchHTz8lIPNacvAZrFBKWxQxku79oNayxViGQg1sahWOagdS6N1H3TKqWFaPnxcp6so8u/hKqDK33r8j1wlZoMncJWjYz9ou2iq0WlQ2ml+69gPunV08zhCSzcbuklonaugmiA0ACsT2rFnN04U+9WP4yoo3fvppqton66Sa4M1ugof7v/3VtAm2P//Mnj+Hw==</diagram><diagram id=&quot;yXMqpa1IgjGufazfH77A&quot; name=&quot;Page-2&quot;>7Vtdb+I4FP01SJ2HXcVJgPDYDzor7YxaqV3t9tEQN4SaGDmmhfn1ayd2Pk0SKAHC9KXCN4lx7jnn3utr2rNuF+vvFC5nP4mLcM803HXPuuuZpjNy+F9h2MSGgdWPDR713dgEUsOT/wtJoyGtK99FYe5GRghm/jJvnJIgQFOWs0FKyUf+tleC89+6hB4qGZ6mEJet//oum8m3MIzU/hfyvZn85pG6sIDqXmkIZ9AlHxmTNe5Zt5QQFn9arG8RFq5TbhltPh4f5q/Ow/MYj1f019PL3+4f8WT3uzySvAFFAWs69T8hog+TufCoaWA44aBGT6J3iFeQoatv8azYD97iKyyMLZVrMZMXT9Yeso3yNSWrwEXiedCzbl5JwO7hwseCOY/P/NafJCD8AqRTyRNLjFaMhPHQEMNJSPCKoevkJjEXJQwyOMFqDLHvBfwzRq/cJTfviDKfY34tzYwsuTVcwqkfeHJiOXoWl7KGH9EUd0CYOAkZ9ANE5S3iFdQqBnwce0h8G1oX6FUDDsg47jsiC8Tohj+nZjGkqKTILMXCj5Sy1kjaZhm6msoIpUy8ZO6UC/yDREsNM+yoZAt/rXBfqlitUgU0pkoRw5QVoE1EFTAKURU2M4g6GkCtVvGkq2BPNO3fHM28Pm27jOawNTSbpQm5IhHfJSoyb6UwIZenRjkklM2IRwKIx6n1JgVShL/0nh8kCpvCx3PE2EZCICDkphlb4DrsUeBei3TOzRNMpm+x6d7HeAuy8erFkvdAkr82WdEpqotPvBiB1ENV89l6ZlCEIfPf84vbAedmoA5OgSFa++w/8fiffTl6yVy5W8uZo8Emkym7gfvwk3jKRx+JH7A0QiRSV2WyXZB+zDP5VIEVyTJ0RNkWyz3E65T9K7msG37DgD7MB/S+XS64ADhxRHe+IvpOyrYbRvTPRoBPRfRRA1DLjm2GB19fJm6L4YuK1WKQRu5otElGWdDmq8VSMSogAYp2RQt/2qvaEe2NaS1Wlh6rjEz7GpUq24GDujkoqD+mZCmolycq7gaK27aDZ4cr4aXo48BjEU7G5tvVumRcl7LHvEn2AEbGa+X0waO1mD9klLyhW4IJTdn0yrlWMKnd/JRzRuy9S/v5he+6mmi2VQqRI3iwcxEtfFW+J1DIWMfa7ptWv8Cr8nYC6PYT5hGzDwD1kcrjeCwbJnHZ4JOpv5e8S/vu1e29Eyln3Ztk/B38u02AnL14P2lV99i4wV+GSE9erRhaq7Dqelr5mAfKFZYOg3YbILngtw841V2tzoBj57HRVL/2iYtfYDcolPAkqpJUusgXpTLip+VNZco4WGHTtFoFZsMSCGypgT5br7amkf5laAQ45y+SwZdINKQ7gkg2+0mjuuvSHWnklTEsK8M6tTKaNE86rYym/WvQUrvjwMoYXYYynLNXRrLv+lLGSA9lW8pY76UMM0u4DisD9M9fGualS6PfUBrmFizPTBoXshtPemFnLI2L3443lkZL2/GGOPTLbs+cAUon59vk2fMbzfHOkX4hcHoqNGWC0bR+MNphwtYznYMd35iDysD5dXxTHa4L5wsDza81tT/WPGa8HtbH611ObzRe3Hagc2Dv2oOyd4Gpca+zu3vbaoGaTkcKE3NLc0B/TKA5wmmvA3rgUrEr/YUaRAqdN01P+tSVotXR/oKKmLX1gek0rRQ70V+wutJfqFFG/WnNyZXR0fbC4ZVhtdRe4MP0H7LiH0+l/9Rmjf8H</diagram></mxfile>">
    <defs></defs>
    <g>
        
            <rect x="13" y="0" width="100" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="62.5" y="16.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">parameter</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="18" y="70" width="90" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="62.5" y="86.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">argument</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="38" y="180" width="50" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="62.5" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">body</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <rect x="342.37" y="180" width="160" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="421.87" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">substitutedBody</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 33 210 Q 13 230 3 250 Q -7 270 13 280 Q 33 290 43 275 Q 53 260 63 260 Q 73 260 63 280 Q 53 300 63 320 Q 73 340 93 325 Q 113 310 118 295 Q 123 280 128 295 Q 133 310 153 325 Q 173 340 188 310 Q 203 280 188 260 Q 173 240 128 230 Q 83 220 115.12 211.97" fill="none" stroke="#af00db" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 121.92 210.27 L 115.97 215.36 L 114.28 208.57 Z" fill="#af00db" stroke="#af00db" stroke-miterlimit="10" pointer-events="all"></path>
        <path d="M 153 190 L 123 190 L 123 190.1" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <rect x="153" y="175" width="130" height="30" rx="1.5" ry="1.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="217.5" y="196.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #795E26">substitute</tspan><tspan style="fill: #000000">()</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 283 190 L 314.88 190" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 321.88 190 L 314.88 193.5 L 314.88 186.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path>
        <rect x="23" y="340" width="80" height="20" fill="#ffffff" stroke="none" pointer-events="all"></rect>
        <g fill="#AF00DB" font-family="PT Serif" text-anchor="middle" font-size="16px">
            <text x="62.5" y="356.5">
                Traversal
            </text>
        </g>
        
            <ellipse cx="63" cy="45" rx="15" ry="15" fill="#ffffff" stroke="#ff0000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="62.5" y="51.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="63" cy="115" rx="20" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="62.5" y="121.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="28" cy="145" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="27.5" y="151.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 49.94 126.36 L 39.39 135.24" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="98" cy="145" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="97.5" y="151.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 76.06 126.36 L 86.61 135.24" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="88" cy="295" rx="15" ry="15" fill="#ffffff" stroke="#ff0000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="87.5" y="301.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="123" cy="260" rx="30" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="122.5" y="266.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">call</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 109.58 273.42 L 98.61 284.39" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 137.66 273.09 L 151.71 285.12" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="163" cy="295" rx="15" ry="15" fill="#ffffff" stroke="#ff0000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="162.5" y="301.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">y</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="63" cy="225" rx="20" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="62.5" y="231.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="28" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="27.5" y="261.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">z</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 49.94 236.36 L 39.39 245.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 78.87 234.13 L 103.48 248.61" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="422.37" cy="260" rx="30" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="421.87" y="266.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">call</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 402.3 271.15 L 368.28 290.91" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 443.01 270.88 L 478.23 289.39" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="362.37" cy="225" rx="20" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="361.87" y="231.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="327.37" cy="255" rx="15" ry="15" fill="#ffffff" stroke="#000000" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="326.87" y="261.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">z</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 349.31 236.36 L 338.76 245.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        <path d="M 378.24 234.13 L 402.85 248.61" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="352.37" cy="300" rx="20" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="351.87" y="306.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="317.37" cy="340" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="316.87" y="346.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 341.24 312.46 L 327.25 328.71" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="387.37" cy="340" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="386.87" y="346.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 363.5 312.46 L 377.49 328.71" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="492.37" cy="300" rx="20" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="491.87" y="306.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #0000FF">=&gt;</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        
            <ellipse cx="457.37" cy="340" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="456.87" y="346.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 481.24 312.46 L 467.25 328.71" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
        
            <ellipse cx="527.37" cy="340" rx="15" ry="15" fill="#ffffff" stroke="#098658" pointer-events="all"></ellipse>
            <g fill="#000000" font-family="PT Mono" text-anchor="middle" font-size="16px">
                <text x="526.87" y="346.5">
<tspan style="fill: #000000">                    </tspan><tspan style="fill: #001080">x</tspan>
<tspan style="fill: #000000">                </tspan></text>
            </g>
        
        <path d="M 503.5 312.46 L 517.49 328.71" fill="none" stroke="#098658" stroke-miterlimit="10" pointer-events="stroke"></path>
    </g>
</svg></p>
</figure>

<pre><code class="language-ts{3-7}"><span style="color: #008000">// substitute()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> {</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    ...</span><span style="color: #001080">expression</span><span style="color: #000000">,</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #001080">callee:</span><span style="color: #000000"> </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">),</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #001080">arguments:</span><span style="color: #000000"> [</span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">])],</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">  };</span>
</div></code></pre>
<p>This concludes the implementation of <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code>.</p>
<h3 id="an-argument-that-is-not-immediate"><span class="heading-counter">1.3.9</span> An Argument That Is Not Immediate<code class="draft"> [](#an-argument-that-is-not-immediate)</code></h3>
<figure>

<table>
<thead>
<tr>
<th align="right"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="right"><strong>Example Program</strong></td>
<td align="left"><code><span style="color: #000000">(</span><span style="color: #001080">a</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">a</span><span style="color: #000000">)((</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">))</span></code></td>
</tr>
<tr>
<td align="right"><strong>Current Output</strong></td>
<td align="left"><code>NOT IMPLEMENTED YET</code></td>
</tr>
<tr>
<td align="right"><strong>Expected Output</strong></td>
<td align="left"><code><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code></td>
</tr>
</tbody></table>
</figure>

<p>The <code><span style="color: #001080">argument</span></code>s in the example programs from <a href="#an-expression-that-already-is-a-value">§&nbsp;1.3.3</a>–<a href="#substitution-in-function-calls">§&nbsp;1.3.8</a> are <code><span style="color: #001080">ArrowFunctionExpression</span></code>s, but in general an <code><span style="color: #001080">argument</span></code> may be any kind of <code><span style="color: #001080">Expression</span></code>; for example, in the program above the <code><span style="color: #001080">argument</span></code> is a <code><span style="color: #001080">CallExpression</span></code>. We address the general case by calling <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> recursively on the <code><span style="color: #001080">argument</span></code> to evaluate it to a <code><span style="color: #001080">Value</span></code>:</p>
<pre><code class="language-ts{9}"><span style="color: #008000">// run()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #000000">  </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000"> !== </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
<span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<span style="color: #000000">    </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<span style="color: #000000">    </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<span style="color: #000000">  } = </span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">;</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">]);</span>
</div><span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">substitutedBody</span><span style="color: #000000"> = </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">body</span><span style="color: #000000">);</span>
<span style="color: #000000">  </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">substitutedBody</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000"> !== </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
<span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">substitutedBody</span><span style="color: #000000">;</span>
<span style="color: #000000">  </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): </span><span style="color: #267F99">Expression</span><span style="color: #000000"> {</span>
<span style="color: #000000">    </span><span style="color: #008000">// ...</span>
<span style="color: #000000">  }</span></code></pre>
<fieldset>
<legend><span class="legend-wrapper"><strong>Technical Terms</strong></span></legend>

<ul>
<li><strong>Big-Step Interpreter&nbsp;[<a href="#natural-semantics">12</a>]:</strong> An interpreter using the technique of calling <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> recursively to evaluate the <code><span style="color: #001080">argument</span></code>.</li>
</ul>
</fieldset>

<fieldset>
<legend><span class="legend-wrapper"><strong>Advanced</strong></span></legend>

<p>The notion that the argument is interpreted to produce a value as soon as the function call is encountered characterizes Yocto-JavaScript as a <em>call-by-value</em> language&nbsp;[<a href="#call-by-name-call-by-value-and-the-lambda-calculus">25</a>]. JavaScript and most other popular programming languages are call-by-value as well, but there is one notable exception, Haskell, which is a <em>call-by-need</em> language. In a call-by-need language the argument is interpreted only if it is <em>needed</em>, for example, if it is used in the function position of another call (see <a href="#a-function-that-is-not-immediate">§&nbsp;1.3.10</a>), or if it is the result of the program (see <a href="#continuing-to-run-after-a-function-call">§&nbsp;1.3.11</a>). In a call-by-need language the result of the program above would be <code><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> ((</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">))</span></code>, and the call <code><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)</span></code> would not be computed is not computed, because it is not needed. There is yet another policy for when to interpret arguments called <em>call-by-name</em>: the difference between call-by-name and call-by-need is that in a call-by-name language the an argument may be computed multiple times if it is used multiple times, but in a call-by-need language an argument is guaranteed to be computed at most once.</p>
</fieldset>

<h3 id="a-function-that-is-not-immediate"><span class="heading-counter">1.3.10</span> A Function That Is Not Immediate<code class="draft"> [](#a-function-that-is-not-immediate)</code></h3>
<figure>

<table>
<thead>
<tr>
<th align="right"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="right"><strong>Example Program</strong></td>
<td align="left"><code><span style="color: #000000">((</span><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">z</span><span style="color: #000000">)(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">))(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)</span></code></td>
</tr>
<tr>
<td align="right"><strong>Current Output</strong></td>
<td align="left"><code>NOT IMPLEMENTED YET</code></td>
</tr>
<tr>
<td align="right"><strong>Expected Output</strong></td>
<td align="left"><code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code></td>
</tr>
</tbody></table>
</figure>

<p>This is the dual of <a href="#an-argument-that-is-not-immediate">§&nbsp;1.3.9</a> for the called function, and the solution is the same: to call <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> recursively:</p>
<pre><code class="language-ts{6}"><span style="color: #008000">// run()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<span style="color: #000000">    </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<span style="color: #000000">    </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  } = </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">);</span>
</div><span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">]);</span>
<span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">substitutedBody</span><span style="color: #000000"> = </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">body</span><span style="color: #000000">);</span>
<span style="color: #000000">  </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">substitutedBody</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000"> !== </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">"NOT IMPLEMENTED YET"</span><span style="color: #000000">);</span>
<span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">substitutedBody</span><span style="color: #000000">;</span>
<span style="color: #000000">  </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): </span><span style="color: #267F99">Expression</span><span style="color: #000000"> {</span>
<span style="color: #000000">    </span><span style="color: #008000">// ...</span>
<span style="color: #000000">  }</span></code></pre>
<h3 id="continuing-to-run-after-a-function-call"><span class="heading-counter">1.3.11</span> Continuing to Run After a Function Call<code class="draft"> [](#continuing-to-run-after-a-function-call)</code></h3>
<figure>

<table>
<thead>
<tr>
<th align="right"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="right"><strong>Example Program</strong></td>
<td align="left"><code><span style="color: #000000">(</span><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> (</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)(</span><span style="color: #001080">z</span><span style="color: #000000">))(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)</span></code></td>
</tr>
<tr>
<td align="right"><strong>Current Output</strong></td>
<td align="left"><code>NOT IMPLEMENTED YET</code></td>
</tr>
<tr>
<td align="right"><strong>Expected Output</strong></td>
<td align="left"><code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code></td>
</tr>
</tbody></table>
</figure>

<p>This is similar to <a href="#an-argument-that-is-not-immediate">§&nbsp;1.3.9</a> and <a href="#a-function-that-is-not-immediate">§&nbsp;1.3.10</a>: the result of substitution may be not an immediate function but another call, and more work may be necessary to interpret it. We solve this with yet another recursive call to <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code>:</p>
<pre><code class="language-ts{8}"><span style="color: #008000">// run()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<span style="color: #000000">    </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<span style="color: #000000">    </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<span style="color: #000000">  } = </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">);</span>
<span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">]);</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">body</span><span style="color: #000000">));</span>
</div><span style="color: #000000">  </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): </span><span style="color: #267F99">Expression</span><span style="color: #000000"> {</span>
<span style="color: #000000">    </span><span style="color: #008000">// ...</span>
<span style="color: #000000">  }</span></code></pre>
<h3 id="a-reference-to-an-undefined-variable"><span class="heading-counter">1.3.12</span> A Reference to an Undefined Variable<code class="draft"> [](#a-reference-to-an-undefined-variable)</code></h3>
<figure>

<table>
<thead>
<tr>
<th align="right"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="right"><strong>Example Program</strong></td>
<td align="left"><code><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">u</span><span style="color: #000000">)(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)</span></code></td>
</tr>
<tr>
<td align="right"><strong>Current Output</strong></td>
<td align="left"><code>NOT IMPLEMENTED YET</code></td>
</tr>
<tr>
<td align="right"><strong>Expected Output</strong></td>
<td align="left"><code>Reference to undefined variable: u</code></td>
</tr>
</tbody></table>
</figure>

<p>The only case in which <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> may encounter a variable reference directly is if the referenced variable is undefined, otherwise <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code> would have already substituted it (see <a href="#a-call-involving-immediate-functions">§&nbsp;1.3.4</a>–<a href="#continuing-to-run-after-a-function-call">§&nbsp;1.3.11</a>). In this case, we throw an exception:</p>
<pre><code class="language-ts{3}"><span style="color: #008000">// run()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">`Reference to undefined variable: </span><span style="color: #0000FF">${</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span><span style="color: #000000">);</span>
</div></code></pre>
<figure>

<table>
<thead>
<tr>
<th align="center">Example Program</th>
<th align="center">Current Output</th>
<th align="center">Expected Output</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">u</span></code></td>
<td align="center"><code><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">u</span></code></td>
<td align="center"><code><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">u</span></code></td>
</tr>
</tbody></table>
</figure>

<p>If the reference to an undefined variable occurs in the body of a function that is not called, then we do not reach the case addressed in this section and an exception is not thrown. This is consistent with JavaScript’s behavior.</p>
<h3 id="the-entire-runner"><span class="heading-counter">1.3.13</span> The Entire Runner<code class="draft"> [](#the-entire-runner)</code></h3>
<p>The implementation of the <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> function is complete:</p>
<pre><code class="language-ts{number}"><span style="color: #aaa;"> 1</span>  <span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Value</span><span style="color: #000000"> = </span><span style="color: #267F99">ArrowFunctionExpression</span><span style="color: #000000">;</span>
<span style="color: #aaa;"> 2</span>  
<span style="color: #aaa;"> 3</span>  <span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): </span><span style="color: #267F99">Value</span><span style="color: #000000"> {</span>
<span style="color: #aaa;"> 4</span>  <span style="color: #000000">  </span><span style="color: #0000FF">switch</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000">) {</span>
<span style="color: #aaa;"> 5</span>  <span style="color: #000000">    </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">:</span>
<span style="color: #aaa;"> 6</span>  <span style="color: #000000">      </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000">;</span>
<span style="color: #aaa;"> 7</span>  <span style="color: #000000">    </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #aaa;"> 8</span>  <span style="color: #000000">      </span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<span style="color: #aaa;"> 9</span>  <span style="color: #000000">        </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<span style="color: #aaa;">10</span>  <span style="color: #000000">        </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<span style="color: #aaa;">11</span>  <span style="color: #000000">      } = </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">);</span>
<span style="color: #aaa;">12</span>  <span style="color: #000000">      </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">]);</span>
<span style="color: #aaa;">13</span>  <span style="color: #000000">      </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">body</span><span style="color: #000000">));</span>
<span style="color: #aaa;">14</span>  <span style="color: #000000">      </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): </span><span style="color: #267F99">Expression</span><span style="color: #000000"> {</span>
<span style="color: #aaa;">15</span>  <span style="color: #000000">        </span><span style="color: #0000FF">switch</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000">) {</span>
<span style="color: #aaa;">16</span>  <span style="color: #000000">          </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">17</span>  <span style="color: #000000">            </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">params</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">].</span><span style="color: #001080">name</span><span style="color: #000000"> === </span><span style="color: #001080">parameter</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">) </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000">;</span>
<span style="color: #aaa;">18</span>  <span style="color: #000000">            </span><span style="color: #0000FF">return</span><span style="color: #000000"> {</span>
<span style="color: #aaa;">19</span>  <span style="color: #000000">              ...</span><span style="color: #001080">expression</span><span style="color: #000000">,</span>
<span style="color: #aaa;">20</span>  <span style="color: #000000">              </span><span style="color: #001080">body:</span><span style="color: #000000"> </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">body</span><span style="color: #000000">),</span>
<span style="color: #aaa;">21</span>  <span style="color: #000000">            };</span>
<span style="color: #aaa;">22</span>  <span style="color: #000000">          </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">23</span>  <span style="color: #000000">            </span><span style="color: #0000FF">return</span><span style="color: #000000"> {</span>
<span style="color: #aaa;">24</span>  <span style="color: #000000">              ...</span><span style="color: #001080">expression</span><span style="color: #000000">,</span>
<span style="color: #aaa;">25</span>  <span style="color: #000000">              </span><span style="color: #001080">callee:</span><span style="color: #000000"> </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">),</span>
<span style="color: #aaa;">26</span>  <span style="color: #000000">              </span><span style="color: #001080">arguments:</span><span style="color: #000000"> [</span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">])],</span>
<span style="color: #aaa;">27</span>  <span style="color: #000000">            };</span>
<span style="color: #aaa;">28</span>  <span style="color: #000000">          </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">29</span>  <span style="color: #000000">            </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000"> !== </span><span style="color: #001080">parameter</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">) </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000">;</span>
<span style="color: #aaa;">30</span>  <span style="color: #000000">            </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000">;</span>
<span style="color: #aaa;">31</span>  <span style="color: #000000">        }</span>
<span style="color: #aaa;">32</span>  <span style="color: #000000">      }</span>
<span style="color: #aaa;">33</span>  <span style="color: #000000">    </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">34</span>  <span style="color: #000000">      </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">`Reference to undefined variable: </span><span style="color: #0000FF">${</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span><span style="color: #000000">);</span>
<span style="color: #aaa;">35</span>  <span style="color: #000000">  }</span>
<span style="color: #aaa;">36</span>  <span style="color: #000000">}</span></code></pre>
<fieldset>
<legend><span class="legend-wrapper"><strong>Advanced</strong></span></legend>

<h3 id="an-operational-semantics-for-the-interpreter"><span class="heading-counter">1.3.14</span> An Operational Semantics for the Interpreter<code class="draft"> [](#an-operational-semantics-for-the-interpreter)</code></h3>
<p>What we accomplished in <a href="#an-expression-that-already-is-a-value">§&nbsp;1.3.3</a>–<a href="#the-entire-runner">§&nbsp;1.3.13</a> is more than defining an interpreter for Yocto-JavaScript; we also defined formally the <em>meaning</em> of Yocto-JavaScript programs: an Yocto-JavaScript program means what the interpreter produces for it. The definition of the meaning of programs in a language is something called the <em>semantics</em> of the language, and there are several techniques to specify semantics; the technique we have been using so far is known as a <em>definitional interpreter</em>&nbsp;[<a href="#definitional-interpreters">27</a>].</p>
<p>A definitional interpreter has some advantages over other techniques for specifying semantics: it is executable and it is easier to understand for most programmers. But a definitional interpreter also has one disadvantage: to understand the meaning of an Yocto-JavaScript program we have to understand an interpreter written in TypeScript, which is a big language with many complex features. To address this, there are other techniques for defining semantics that do not depend on other programming languages, and in this section we introduce one of them: <em>operational semantics</em>&nbsp;[<a href="#natural-semantics">12</a>, <a href="#semantics-engineering">8</a>, <a href="#pl-book">10</a>].</p>
<p>First, we extend the grammar from <a href="#a-formal-grammar-for-yocto-javascript">§&nbsp;1.1.4</a> with the notion of values that is equivalent to the type <code><span style="color: #001080">Value</span></code> (see <a href="#the-entire-runner">§&nbsp;1.3.13</a>, line 1):</p>
<figure>

<table>
<thead>
<tr>
<th align="right"></th>
<th align="center"></th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="right"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.16ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 499.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">v</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="0" y="0"></use>
</g>
</svg></td>
<td align="center">::=</td>
<td align="left"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.16ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 499.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
</g>
</svg>&nbsp;&nbsp;<code><span style="color: #0000FF">=&gt;</span></code>&nbsp;&nbsp;<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.902ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 388.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
</g>
</svg></td>
<td align="left">Values</td>
</tr>
</tbody></table>
</figure>

<p>Next, we define a <em>relation</em> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.707ex" height="1.843ex" style="vertical-align: -0.338ex;" viewBox="0 -647.8 2457.1 793.3" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e \Rightarrow v</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-21D2" d="M949 273l-253 -266l-30 31l80 98h-681v59h732l63 76l-64 78h-731v59h681l-80 98l30 33Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-21D2" x="666" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="1957" y="0"></use>
</g>
</svg> using <em>inference rules</em> that are equivalent to the behavior of <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> (see <a href="#the-entire-runner">§&nbsp;1.3.13</a>, lines 3–36):</p>
<figure>
<table>
<tbody><tr>
<th>Value</th>
<td>

<figure><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.801ex" height="3.676ex" style="vertical-align: -1.838ex;" viewBox="0 -791.3 2928.1 1582.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\frac{}{v \Rightarrow v}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-21D2" d="M949 273l-253 -266l-30 31l80 98h-681v59h732l63 76l-64 78h-731v59h681l-80 98l30 33Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(120,0)">
<rect stroke="none" width="2688" height="60" x="0" y="220"></rect>
<g transform="translate(60,-686)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="0" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-21D2" x="777" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="2068" y="0"></use>
</g>
</g>
</g>
</svg></figure>
</td>
</tr>
<tr>
<th>Function Call</th>
<td>

<figure><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="44.281ex" height="8.009ex" style="vertical-align: -3.338ex;" viewBox="0 -2011.3 19065.2 3448.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\frac{
e_f \Rightarrow \texttt{(}x_p \texttt{ =&gt; } e_b\texttt{)} \quad
e_a \Rightarrow v_a \quad
e_b[x_p \backslash v_a] \Rightarrow v
}{
e_f\texttt{(}e_a\texttt{)} \Rightarrow v
}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D453" d="M345 437c63 0 62 2 91 9l4 -7c-6 -14 -13 -37 -17 -56h-104c-84 -401 -104 -497 -175 -581c-39 -47 -93 -78 -134 -78c-11 0 -26 3 -35 8c5 9 19 57 23 80l14 4c18 -22 29 -29 52 -29c36 0 66 31 84 90c22 69 59 255 89 450l9 56h-81l5 22c25 9 45 17 86 37l15 79 c11 57 23 87 45 109c23 24 105 85 129 96c8 4 24 7 35 7c23 0 54 -6 70 -13l-5 -15c-8 -20 -18 -51 -23 -67l-10 -4c-15 24 -42 39 -72 39c-46 0 -74 -38 -90 -124l-21 -112h16Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-21D2" d="M949 273l-253 -266l-30 31l80 98h-681v59h732l63 76l-64 78h-731v59h681l-80 98l30 33Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-28" d="M146 266c0 -281 109 -403 155 -460l-19 -21c-82 77 -114 116 -149 183c-48 90 -73 191 -73 298c0 276 165 409 222 460l19 -26c-58 -68 -155 -174 -155 -434Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D45D" d="M176 -11c-18 0 -40 7 -61 14l-42 -262c-32 -5 -52 -10 -73 -17l-7 6l8 37c20 90 39 181 49 241l58 343c2 10 4 30 4 38c0 14 -7 23 -17 23c-9 0 -20 -5 -48 -23l-32 -21l-7 20l28 20c74 53 112 74 133 74c14 0 22 -11 22 -30c0 -12 -2 -27 -5 -44l-24 -119 c36 59 56 85 97 120c52 47 105 73 147 73c36 0 59 -44 59 -111c0 -75 -34 -185 -75 -246c-43 -63 -158 -136 -214 -136zM143 165l-18 -106c26 -16 51 -23 82 -23c41 0 73 15 93 44c53 76 93 195 93 276c0 46 -12 68 -38 68c-83 0 -190 -131 -212 -259Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-3D" d="M604 347h-539v59h539v-59zM604 134h-539v59h539v-59Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D44F" d="M235 722l-86 -398c62 79 95 109 146 136c28 14 58 22 82 22c15 0 28 -5 35 -14c12 -15 21 -54 21 -92c0 -132 -66 -269 -162 -337c-43 -31 -94 -50 -131 -50c-55 0 -103 33 -103 72c0 3 0 7 1 10l101 551c1 6 2 17 2 24c0 17 -10 24 -34 24h-48l4 21c72 7 108 16 160 42z M322 424c-29 0 -81 -29 -114 -63c-81 -85 -96 -226 -96 -260c0 -42 25 -65 71 -65c54 0 94 32 127 101c30 65 51 151 51 215c0 49 -13 72 -39 72Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-29" d="M51 726c57 -51 222 -184 222 -461c0 -288 -169 -430 -222 -480l-19 21c51 63 155 184 155 460c0 260 -100 370 -155 434Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D44E" d="M271 204c-116 -163 -196 -215 -233 -215c-19 0 -34 34 -34 78c0 78 31 198 75 287c25 49 58 79 120 110c27 13 47 18 75 18c27 0 44 -4 85 -19l33 18l10 -9l-92 -379c-1 -3 -1 -6 -1 -11c0 -14 6 -23 15 -23c22 0 51 27 75 47l7 -21c-82 -68 -123 -94 -146 -94 c-15 0 -24 13 -24 35c0 16 2 34 6 51zM319 414c-44 15 -62 19 -85 19c-48 0 -71 -18 -95 -73c-35 -80 -63 -197 -63 -261c0 -27 6 -40 18 -40c32 0 93 58 150 142c34 52 53 104 75 213Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2216" d="M101 459l559 -409l39 42l-559 409Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-5D" d="M245 -184h-194l-6 6v26l4 5h38c27 0 49 6 61 16c9 9 12 23 12 56v691c0 33 -3 48 -12 57c-12 10 -34 16 -61 16h-38l-4 5v26l6 6h194c4 -9 5 -20 5 -35c0 -26 -4 -63 -4 -113v-622c0 -68 2 -96 8 -127Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
<g transform="translate(120,0)">
<rect stroke="none" width="18825" height="60" x="0" y="220"></rect>
<g transform="translate(60,949)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D453" x="549" y="-247"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-21D2" x="1155" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-28" x="2446" y="216"></use>
<g transform="translate(2779,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
<g transform="translate(3732,0)">
 <use xlink:href="#E1-ASANAMATHMAIN-3D" x="524" y="0"></use>
<g transform="translate(1192,0)">
<text font-family="monospace" stroke="none" transform="scale(71.759) matrix(1 0 0 -1 0 0)">&gt;</text>
</g>
</g>
<g transform="translate(6058,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44F" x="549" y="-247"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-29" x="6874" y="216"></use>
<g transform="translate(8206,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="549" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-21D2" x="9286" y="0"></use>
<g transform="translate(10577,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="706" y="-213"></use>
</g>
<g transform="translate(12490,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44F" x="549" y="-247"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="13306" y="0"></use>
<g transform="translate(13638,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-2216" x="14591" y="0"></use>
<g transform="translate(15391,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-5D" x="16304" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-21D2" x="16914" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="18205" y="0"></use>
</g>
<g transform="translate(7205,-963)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D453" x="549" y="-247"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-28" x="877" y="216"></use>
<g transform="translate(1210,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="549" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-29" x="2012" y="216"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-21D2" x="2622" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="3913" y="0"></use>
</g>
</g>
</g>
</svg></figure>
</td>
</tr>
</tbody></table>
</figure>

<p>Finally, we define a <em>metafunction</em> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.369ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 4464.6 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e[x \backslash v] = e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2216" d="M101 459l559 -409l39 42l-559 409Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-5D" d="M245 -184h-194l-6 6v26l4 5h38c27 0 49 6 61 16c9 9 12 23 12 56v691c0 33 -3 48 -12 57c-12 10 -34 16 -61 16h-38l-4 5v26l6 6h194c4 -9 5 -20 5 -35c0 -26 -4 -63 -4 -113v-622c0 -68 2 -96 8 -127Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-3D" d="M604 347h-539v59h539v-59zM604 134h-539v59h539v-59Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="388" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="721" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-2216" x="1220" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="2020" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-5D" x="2519" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-3D" x="3129" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="4076" y="0"></use>
</g>
</svg> that is equivalent to the behavior of <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code> (see <a href="#the-entire-runner">§&nbsp;1.3.13</a>, lines 14–32):</p>
<figure>

<table>
<thead>
<tr>
<th align="right"></th>
<th align="center"></th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="right"><code><span style="color: #000000">(</span></code> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.16ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 499.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
</g>
</svg>&nbsp;&nbsp;<code><span style="color: #0000FF">=&gt;</span></code>&nbsp;&nbsp;<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.902ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 388.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
</g>
</svg> <code><span style="color: #000000">)</span></code> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.735ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 3330.3 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[x_p \backslash v_a]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D45D" d="M176 -11c-18 0 -40 7 -61 14l-42 -262c-32 -5 -52 -10 -73 -17l-7 6l8 37c20 90 39 181 49 241l58 343c2 10 4 30 4 38c0 14 -7 23 -17 23c-9 0 -20 -5 -48 -23l-32 -21l-7 20l28 20c74 53 112 74 133 74c14 0 22 -11 22 -30c0 -12 -2 -27 -5 -44l-24 -119 c36 59 56 85 97 120c52 47 105 73 147 73c36 0 59 -44 59 -111c0 -75 -34 -185 -75 -246c-43 -63 -158 -136 -214 -136zM143 165l-18 -106c26 -16 51 -23 82 -23c41 0 73 15 93 44c53 76 93 195 93 276c0 46 -12 68 -38 68c-83 0 -190 -131 -212 -259Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2216" d="M101 459l559 -409l39 42l-559 409Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D44E" d="M271 204c-116 -163 -196 -215 -233 -215c-19 0 -34 34 -34 78c0 78 31 198 75 287c25 49 58 79 120 110c27 13 47 18 75 18c27 0 44 -4 85 -19l33 18l10 -9l-92 -379c-1 -3 -1 -6 -1 -11c0 -14 6 -23 15 -23c22 0 51 27 75 47l7 -21c-82 -68 -123 -94 -146 -94 c-15 0 -24 13 -24 35c0 16 2 34 6 51zM319 414c-44 15 -62 19 -85 19c-48 0 -71 -18 -95 -73c-35 -80 -63 -197 -63 -261c0 -27 6 -40 18 -40c32 0 93 58 150 142c34 52 53 104 75 213Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-5D" d="M245 -184h-194l-6 6v26l4 5h38c27 0 49 6 61 16c9 9 12 23 12 56v691c0 33 -3 48 -12 57c-12 10 -34 16 -61 16h-38l-4 5v26l6 6h194c4 -9 5 -20 5 -35c0 -26 -4 -63 -4 -113v-622c0 -68 2 -96 8 -127Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
<g transform="translate(332,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-2216" x="1285" y="0"></use>
<g transform="translate(2084,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-5D" x="2997" y="0"></use>
</g>
</svg></td>
<td align="center">=</td>
<td align="left"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.16ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 499.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
</g>
</svg>&nbsp;&nbsp;<code><span style="color: #0000FF">=&gt;</span></code>&nbsp;&nbsp;<code><span style="color: #000000">(</span></code> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.902ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 388.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
</g>
</svg> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.735ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 3330.3 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[x_p \backslash v_a]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D45D" d="M176 -11c-18 0 -40 7 -61 14l-42 -262c-32 -5 -52 -10 -73 -17l-7 6l8 37c20 90 39 181 49 241l58 343c2 10 4 30 4 38c0 14 -7 23 -17 23c-9 0 -20 -5 -48 -23l-32 -21l-7 20l28 20c74 53 112 74 133 74c14 0 22 -11 22 -30c0 -12 -2 -27 -5 -44l-24 -119 c36 59 56 85 97 120c52 47 105 73 147 73c36 0 59 -44 59 -111c0 -75 -34 -185 -75 -246c-43 -63 -158 -136 -214 -136zM143 165l-18 -106c26 -16 51 -23 82 -23c41 0 73 15 93 44c53 76 93 195 93 276c0 46 -12 68 -38 68c-83 0 -190 -131 -212 -259Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2216" d="M101 459l559 -409l39 42l-559 409Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D44E" d="M271 204c-116 -163 -196 -215 -233 -215c-19 0 -34 34 -34 78c0 78 31 198 75 287c25 49 58 79 120 110c27 13 47 18 75 18c27 0 44 -4 85 -19l33 18l10 -9l-92 -379c-1 -3 -1 -6 -1 -11c0 -14 6 -23 15 -23c22 0 51 27 75 47l7 -21c-82 -68 -123 -94 -146 -94 c-15 0 -24 13 -24 35c0 16 2 34 6 51zM319 414c-44 15 -62 19 -85 19c-48 0 -71 -18 -95 -73c-35 -80 -63 -197 -63 -261c0 -27 6 -40 18 -40c32 0 93 58 150 142c34 52 53 104 75 213Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-5D" d="M245 -184h-194l-6 6v26l4 5h38c27 0 49 6 61 16c9 9 12 23 12 56v691c0 33 -3 48 -12 57c-12 10 -34 16 -61 16h-38l-4 5v26l6 6h194c4 -9 5 -20 5 -35c0 -26 -4 -63 -4 -113v-622c0 -68 2 -96 8 -127Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
<g transform="translate(332,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-2216" x="1285" y="0"></use>
<g transform="translate(2084,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-5D" x="2997" y="0"></use>
</g>
</svg> <code><span style="color: #000000">)</span></code></td>
<td align="left">if <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.216ex" height="2.676ex" style="vertical-align: -1.005ex;" viewBox="0 -719.6 2676.3 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x \ne x_p</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2260" d="M604 135h-296l-74 -190h-57l75 189h-187v59h211l61 154h-272v59h296l75 190h57l-75 -189h186v-59h-210l-61 -154h271v-59Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D45D" d="M176 -11c-18 0 -40 7 -61 14l-42 -262c-32 -5 -52 -10 -73 -17l-7 6l8 37c20 90 39 181 49 241l58 343c2 10 4 30 4 38c0 14 -7 23 -17 23c-9 0 -20 -5 -48 -23l-32 -21l-7 20l28 20c74 53 112 74 133 74c14 0 22 -11 22 -30c0 -12 -2 -27 -5 -44l-24 -119 c36 59 56 85 97 120c52 47 105 73 147 73c36 0 59 -44 59 -111c0 -75 -34 -185 -75 -246c-43 -63 -158 -136 -214 -136zM143 165l-18 -106c26 -16 51 -23 82 -23c41 0 73 15 93 44c53 76 93 195 93 276c0 46 -12 68 -38 68c-83 0 -190 -131 -212 -259Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-2260" x="777" y="0"></use>
<g transform="translate(1723,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
</g>
</svg></td>
</tr>
<tr>
<td align="right"><code><span style="color: #000000">(</span></code> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.213ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 952.7 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x_p</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D45D" d="M176 -11c-18 0 -40 7 -61 14l-42 -262c-32 -5 -52 -10 -73 -17l-7 6l8 37c20 90 39 181 49 241l58 343c2 10 4 30 4 38c0 14 -7 23 -17 23c-9 0 -20 -5 -48 -23l-32 -21l-7 20l28 20c74 53 112 74 133 74c14 0 22 -11 22 -30c0 -12 -2 -27 -5 -44l-24 -119 c36 59 56 85 97 120c52 47 105 73 147 73c36 0 59 -44 59 -111c0 -75 -34 -185 -75 -246c-43 -63 -158 -136 -214 -136zM143 165l-18 -106c26 -16 51 -23 82 -23c41 0 73 15 93 44c53 76 93 195 93 276c0 46 -12 68 -38 68c-83 0 -190 -131 -212 -259Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
</svg>&nbsp;&nbsp;<code><span style="color: #0000FF">=&gt;</span></code>&nbsp;&nbsp;<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.902ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 388.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
</g>
</svg> <code><span style="color: #000000">)</span></code> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.735ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 3330.3 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[x_p \backslash v_a]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D45D" d="M176 -11c-18 0 -40 7 -61 14l-42 -262c-32 -5 -52 -10 -73 -17l-7 6l8 37c20 90 39 181 49 241l58 343c2 10 4 30 4 38c0 14 -7 23 -17 23c-9 0 -20 -5 -48 -23l-32 -21l-7 20l28 20c74 53 112 74 133 74c14 0 22 -11 22 -30c0 -12 -2 -27 -5 -44l-24 -119 c36 59 56 85 97 120c52 47 105 73 147 73c36 0 59 -44 59 -111c0 -75 -34 -185 -75 -246c-43 -63 -158 -136 -214 -136zM143 165l-18 -106c26 -16 51 -23 82 -23c41 0 73 15 93 44c53 76 93 195 93 276c0 46 -12 68 -38 68c-83 0 -190 -131 -212 -259Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2216" d="M101 459l559 -409l39 42l-559 409Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D44E" d="M271 204c-116 -163 -196 -215 -233 -215c-19 0 -34 34 -34 78c0 78 31 198 75 287c25 49 58 79 120 110c27 13 47 18 75 18c27 0 44 -4 85 -19l33 18l10 -9l-92 -379c-1 -3 -1 -6 -1 -11c0 -14 6 -23 15 -23c22 0 51 27 75 47l7 -21c-82 -68 -123 -94 -146 -94 c-15 0 -24 13 -24 35c0 16 2 34 6 51zM319 414c-44 15 -62 19 -85 19c-48 0 -71 -18 -95 -73c-35 -80 -63 -197 -63 -261c0 -27 6 -40 18 -40c32 0 93 58 150 142c34 52 53 104 75 213Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-5D" d="M245 -184h-194l-6 6v26l4 5h38c27 0 49 6 61 16c9 9 12 23 12 56v691c0 33 -3 48 -12 57c-12 10 -34 16 -61 16h-38l-4 5v26l6 6h194c4 -9 5 -20 5 -35c0 -26 -4 -63 -4 -113v-622c0 -68 2 -96 8 -127Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
<g transform="translate(332,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-2216" x="1285" y="0"></use>
<g transform="translate(2084,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-5D" x="2997" y="0"></use>
</g>
</svg></td>
<td align="center">=</td>
<td align="left"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.213ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 952.7 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x_p</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D45D" d="M176 -11c-18 0 -40 7 -61 14l-42 -262c-32 -5 -52 -10 -73 -17l-7 6l8 37c20 90 39 181 49 241l58 343c2 10 4 30 4 38c0 14 -7 23 -17 23c-9 0 -20 -5 -48 -23l-32 -21l-7 20l28 20c74 53 112 74 133 74c14 0 22 -11 22 -30c0 -12 -2 -27 -5 -44l-24 -119 c36 59 56 85 97 120c52 47 105 73 147 73c36 0 59 -44 59 -111c0 -75 -34 -185 -75 -246c-43 -63 -158 -136 -214 -136zM143 165l-18 -106c26 -16 51 -23 82 -23c41 0 73 15 93 44c53 76 93 195 93 276c0 46 -12 68 -38 68c-83 0 -190 -131 -212 -259Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
</svg>&nbsp;&nbsp;<code><span style="color: #0000FF">=&gt;</span></code>&nbsp;&nbsp;<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.902ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 388.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
</g>
</svg></td>
<td align="left"></td>
</tr>
<tr>
<td align="right"><code><span style="color: #000000">(</span></code> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.039ex" height="2.509ex" style="vertical-align: -1.171ex;" viewBox="0 -576.1 877.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e_f</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D453" d="M345 437c63 0 62 2 91 9l4 -7c-6 -14 -13 -37 -17 -56h-104c-84 -401 -104 -497 -175 -581c-39 -47 -93 -78 -134 -78c-11 0 -26 3 -35 8c5 9 19 57 23 80l14 4c18 -22 29 -29 52 -29c36 0 66 31 84 90c22 69 59 255 89 450l9 56h-81l5 22c25 9 45 17 86 37l15 79 c11 57 23 87 45 109c23 24 105 85 129 96c8 4 24 7 35 7c23 0 54 -6 70 -13l-5 -15c-8 -20 -18 -51 -23 -67l-10 -4c-15 24 -42 39 -72 39c-46 0 -74 -38 -90 -124l-21 -112h16Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D453" x="549" y="-247"></use>
</g>
</svg> <code><span style="color: #000000">(</span></code> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.863ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 802.1 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e_a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D44E" d="M271 204c-116 -163 -196 -215 -233 -215c-19 0 -34 34 -34 78c0 78 31 198 75 287c25 49 58 79 120 110c27 13 47 18 75 18c27 0 44 -4 85 -19l33 18l10 -9l-92 -379c-1 -3 -1 -6 -1 -11c0 -14 6 -23 15 -23c22 0 51 27 75 47l7 -21c-82 -68 -123 -94 -146 -94 c-15 0 -24 13 -24 35c0 16 2 34 6 51zM319 414c-44 15 -62 19 -85 19c-48 0 -71 -18 -95 -73c-35 -80 -63 -197 -63 -261c0 -27 6 -40 18 -40c32 0 93 58 150 142c34 52 53 104 75 213Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="549" y="-213"></use>
</g>
</svg> <code><span style="color: #000000">))</span></code> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.735ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 3330.3 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[x_p \backslash v_a]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D45D" d="M176 -11c-18 0 -40 7 -61 14l-42 -262c-32 -5 -52 -10 -73 -17l-7 6l8 37c20 90 39 181 49 241l58 343c2 10 4 30 4 38c0 14 -7 23 -17 23c-9 0 -20 -5 -48 -23l-32 -21l-7 20l28 20c74 53 112 74 133 74c14 0 22 -11 22 -30c0 -12 -2 -27 -5 -44l-24 -119 c36 59 56 85 97 120c52 47 105 73 147 73c36 0 59 -44 59 -111c0 -75 -34 -185 -75 -246c-43 -63 -158 -136 -214 -136zM143 165l-18 -106c26 -16 51 -23 82 -23c41 0 73 15 93 44c53 76 93 195 93 276c0 46 -12 68 -38 68c-83 0 -190 -131 -212 -259Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2216" d="M101 459l559 -409l39 42l-559 409Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D44E" d="M271 204c-116 -163 -196 -215 -233 -215c-19 0 -34 34 -34 78c0 78 31 198 75 287c25 49 58 79 120 110c27 13 47 18 75 18c27 0 44 -4 85 -19l33 18l10 -9l-92 -379c-1 -3 -1 -6 -1 -11c0 -14 6 -23 15 -23c22 0 51 27 75 47l7 -21c-82 -68 -123 -94 -146 -94 c-15 0 -24 13 -24 35c0 16 2 34 6 51zM319 414c-44 15 -62 19 -85 19c-48 0 -71 -18 -95 -73c-35 -80 -63 -197 -63 -261c0 -27 6 -40 18 -40c32 0 93 58 150 142c34 52 53 104 75 213Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-5D" d="M245 -184h-194l-6 6v26l4 5h38c27 0 49 6 61 16c9 9 12 23 12 56v691c0 33 -3 48 -12 57c-12 10 -34 16 -61 16h-38l-4 5v26l6 6h194c4 -9 5 -20 5 -35c0 -26 -4 -63 -4 -113v-622c0 -68 2 -96 8 -127Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
<g transform="translate(332,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-2216" x="1285" y="0"></use>
<g transform="translate(2084,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-5D" x="2997" y="0"></use>
</g>
</svg></td>
<td align="center">=</td>
<td align="left"><code><span style="color: #000000">(</span></code> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.039ex" height="2.509ex" style="vertical-align: -1.171ex;" viewBox="0 -576.1 877.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e_f</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D453" d="M345 437c63 0 62 2 91 9l4 -7c-6 -14 -13 -37 -17 -56h-104c-84 -401 -104 -497 -175 -581c-39 -47 -93 -78 -134 -78c-11 0 -26 3 -35 8c5 9 19 57 23 80l14 4c18 -22 29 -29 52 -29c36 0 66 31 84 90c22 69 59 255 89 450l9 56h-81l5 22c25 9 45 17 86 37l15 79 c11 57 23 87 45 109c23 24 105 85 129 96c8 4 24 7 35 7c23 0 54 -6 70 -13l-5 -15c-8 -20 -18 -51 -23 -67l-10 -4c-15 24 -42 39 -72 39c-46 0 -74 -38 -90 -124l-21 -112h16Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D453" x="549" y="-247"></use>
</g>
</svg> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.735ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 3330.3 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[x_p \backslash v_a]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D45D" d="M176 -11c-18 0 -40 7 -61 14l-42 -262c-32 -5 -52 -10 -73 -17l-7 6l8 37c20 90 39 181 49 241l58 343c2 10 4 30 4 38c0 14 -7 23 -17 23c-9 0 -20 -5 -48 -23l-32 -21l-7 20l28 20c74 53 112 74 133 74c14 0 22 -11 22 -30c0 -12 -2 -27 -5 -44l-24 -119 c36 59 56 85 97 120c52 47 105 73 147 73c36 0 59 -44 59 -111c0 -75 -34 -185 -75 -246c-43 -63 -158 -136 -214 -136zM143 165l-18 -106c26 -16 51 -23 82 -23c41 0 73 15 93 44c53 76 93 195 93 276c0 46 -12 68 -38 68c-83 0 -190 -131 -212 -259Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2216" d="M101 459l559 -409l39 42l-559 409Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D44E" d="M271 204c-116 -163 -196 -215 -233 -215c-19 0 -34 34 -34 78c0 78 31 198 75 287c25 49 58 79 120 110c27 13 47 18 75 18c27 0 44 -4 85 -19l33 18l10 -9l-92 -379c-1 -3 -1 -6 -1 -11c0 -14 6 -23 15 -23c22 0 51 27 75 47l7 -21c-82 -68 -123 -94 -146 -94 c-15 0 -24 13 -24 35c0 16 2 34 6 51zM319 414c-44 15 -62 19 -85 19c-48 0 -71 -18 -95 -73c-35 -80 -63 -197 -63 -261c0 -27 6 -40 18 -40c32 0 93 58 150 142c34 52 53 104 75 213Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-5D" d="M245 -184h-194l-6 6v26l4 5h38c27 0 49 6 61 16c9 9 12 23 12 56v691c0 33 -3 48 -12 57c-12 10 -34 16 -61 16h-38l-4 5v26l6 6h194c4 -9 5 -20 5 -35c0 -26 -4 -63 -4 -113v-622c0 -68 2 -96 8 -127Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
<g transform="translate(332,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-2216" x="1285" y="0"></use>
<g transform="translate(2084,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-5D" x="2997" y="0"></use>
</g>
</svg> <code><span style="color: #000000">(</span></code> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.863ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 802.1 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">e_a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D44E" d="M271 204c-116 -163 -196 -215 -233 -215c-19 0 -34 34 -34 78c0 78 31 198 75 287c25 49 58 79 120 110c27 13 47 18 75 18c27 0 44 -4 85 -19l33 18l10 -9l-92 -379c-1 -3 -1 -6 -1 -11c0 -14 6 -23 15 -23c22 0 51 27 75 47l7 -21c-82 -68 -123 -94 -146 -94 c-15 0 -24 13 -24 35c0 16 2 34 6 51zM319 414c-44 15 -62 19 -85 19c-48 0 -71 -18 -95 -73c-35 -80 -63 -197 -63 -261c0 -27 6 -40 18 -40c32 0 93 58 150 142c34 52 53 104 75 213Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="549" y="-213"></use>
</g>
</svg> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.735ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 3330.3 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[x_p \backslash v_a]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D45D" d="M176 -11c-18 0 -40 7 -61 14l-42 -262c-32 -5 -52 -10 -73 -17l-7 6l8 37c20 90 39 181 49 241l58 343c2 10 4 30 4 38c0 14 -7 23 -17 23c-9 0 -20 -5 -48 -23l-32 -21l-7 20l28 20c74 53 112 74 133 74c14 0 22 -11 22 -30c0 -12 -2 -27 -5 -44l-24 -119 c36 59 56 85 97 120c52 47 105 73 147 73c36 0 59 -44 59 -111c0 -75 -34 -185 -75 -246c-43 -63 -158 -136 -214 -136zM143 165l-18 -106c26 -16 51 -23 82 -23c41 0 73 15 93 44c53 76 93 195 93 276c0 46 -12 68 -38 68c-83 0 -190 -131 -212 -259Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2216" d="M101 459l559 -409l39 42l-559 409Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D44E" d="M271 204c-116 -163 -196 -215 -233 -215c-19 0 -34 34 -34 78c0 78 31 198 75 287c25 49 58 79 120 110c27 13 47 18 75 18c27 0 44 -4 85 -19l33 18l10 -9l-92 -379c-1 -3 -1 -6 -1 -11c0 -14 6 -23 15 -23c22 0 51 27 75 47l7 -21c-82 -68 -123 -94 -146 -94 c-15 0 -24 13 -24 35c0 16 2 34 6 51zM319 414c-44 15 -62 19 -85 19c-48 0 -71 -18 -95 -73c-35 -80 -63 -197 -63 -261c0 -27 6 -40 18 -40c32 0 93 58 150 142c34 52 53 104 75 213Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-5D" d="M245 -184h-194l-6 6v26l4 5h38c27 0 49 6 61 16c9 9 12 23 12 56v691c0 33 -3 48 -12 57c-12 10 -34 16 -61 16h-38l-4 5v26l6 6h194c4 -9 5 -20 5 -35c0 -26 -4 -63 -4 -113v-622c0 -68 2 -96 8 -127Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
<g transform="translate(332,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-2216" x="1285" y="0"></use>
<g transform="translate(2084,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-5D" x="2997" y="0"></use>
</g>
</svg> <code><span style="color: #000000">))</span></code></td>
<td align="left"></td>
</tr>
<tr>
<td align="right"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.16ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 499.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
</g>
</svg> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.735ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 3330.3 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[x_p \backslash v_a]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D45D" d="M176 -11c-18 0 -40 7 -61 14l-42 -262c-32 -5 -52 -10 -73 -17l-7 6l8 37c20 90 39 181 49 241l58 343c2 10 4 30 4 38c0 14 -7 23 -17 23c-9 0 -20 -5 -48 -23l-32 -21l-7 20l28 20c74 53 112 74 133 74c14 0 22 -11 22 -30c0 -12 -2 -27 -5 -44l-24 -119 c36 59 56 85 97 120c52 47 105 73 147 73c36 0 59 -44 59 -111c0 -75 -34 -185 -75 -246c-43 -63 -158 -136 -214 -136zM143 165l-18 -106c26 -16 51 -23 82 -23c41 0 73 15 93 44c53 76 93 195 93 276c0 46 -12 68 -38 68c-83 0 -190 -131 -212 -259Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2216" d="M101 459l559 -409l39 42l-559 409Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D44E" d="M271 204c-116 -163 -196 -215 -233 -215c-19 0 -34 34 -34 78c0 78 31 198 75 287c25 49 58 79 120 110c27 13 47 18 75 18c27 0 44 -4 85 -19l33 18l10 -9l-92 -379c-1 -3 -1 -6 -1 -11c0 -14 6 -23 15 -23c22 0 51 27 75 47l7 -21c-82 -68 -123 -94 -146 -94 c-15 0 -24 13 -24 35c0 16 2 34 6 51zM319 414c-44 15 -62 19 -85 19c-48 0 -71 -18 -95 -73c-35 -80 -63 -197 -63 -261c0 -27 6 -40 18 -40c32 0 93 58 150 142c34 52 53 104 75 213Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-5D" d="M245 -184h-194l-6 6v26l4 5h38c27 0 49 6 61 16c9 9 12 23 12 56v691c0 33 -3 48 -12 57c-12 10 -34 16 -61 16h-38l-4 5v26l6 6h194c4 -9 5 -20 5 -35c0 -26 -4 -63 -4 -113v-622c0 -68 2 -96 8 -127Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
<g transform="translate(332,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-2216" x="1285" y="0"></use>
<g transform="translate(2084,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-5D" x="2997" y="0"></use>
</g>
</svg></td>
<td align="center">=</td>
<td align="left"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.16ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 499.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
</g>
</svg></td>
<td align="left">if <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.216ex" height="2.676ex" style="vertical-align: -1.005ex;" viewBox="0 -719.6 2676.3 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x \ne x_p</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2260" d="M604 135h-296l-74 -190h-57l75 189h-187v59h211l61 154h-272v59h296l75 190h57l-75 -189h186v-59h-210l-61 -154h271v-59Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D45D" d="M176 -11c-18 0 -40 7 -61 14l-42 -262c-32 -5 -52 -10 -73 -17l-7 6l8 37c20 90 39 181 49 241l58 343c2 10 4 30 4 38c0 14 -7 23 -17 23c-9 0 -20 -5 -48 -23l-32 -21l-7 20l28 20c74 53 112 74 133 74c14 0 22 -11 22 -30c0 -12 -2 -27 -5 -44l-24 -119 c36 59 56 85 97 120c52 47 105 73 147 73c36 0 59 -44 59 -111c0 -75 -34 -185 -75 -246c-43 -63 -158 -136 -214 -136zM143 165l-18 -106c26 -16 51 -23 82 -23c41 0 73 15 93 44c53 76 93 195 93 276c0 46 -12 68 -38 68c-83 0 -190 -131 -212 -259Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-2260" x="777" y="0"></use>
<g transform="translate(1723,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
</g>
</svg></td>
</tr>
<tr>
<td align="right"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.213ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 952.7 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x_p</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D45D" d="M176 -11c-18 0 -40 7 -61 14l-42 -262c-32 -5 -52 -10 -73 -17l-7 6l8 37c20 90 39 181 49 241l58 343c2 10 4 30 4 38c0 14 -7 23 -17 23c-9 0 -20 -5 -48 -23l-32 -21l-7 20l28 20c74 53 112 74 133 74c14 0 22 -11 22 -30c0 -12 -2 -27 -5 -44l-24 -119 c36 59 56 85 97 120c52 47 105 73 147 73c36 0 59 -44 59 -111c0 -75 -34 -185 -75 -246c-43 -63 -158 -136 -214 -136zM143 165l-18 -106c26 -16 51 -23 82 -23c41 0 73 15 93 44c53 76 93 195 93 276c0 46 -12 68 -38 68c-83 0 -190 -131 -212 -259Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
</svg> <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.735ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 3330.3 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[x_p \backslash v_a]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D45D" d="M176 -11c-18 0 -40 7 -61 14l-42 -262c-32 -5 -52 -10 -73 -17l-7 6l8 37c20 90 39 181 49 241l58 343c2 10 4 30 4 38c0 14 -7 23 -17 23c-9 0 -20 -5 -48 -23l-32 -21l-7 20l28 20c74 53 112 74 133 74c14 0 22 -11 22 -30c0 -12 -2 -27 -5 -44l-24 -119 c36 59 56 85 97 120c52 47 105 73 147 73c36 0 59 -44 59 -111c0 -75 -34 -185 -75 -246c-43 -63 -158 -136 -214 -136zM143 165l-18 -106c26 -16 51 -23 82 -23c41 0 73 15 93 44c53 76 93 195 93 276c0 46 -12 68 -38 68c-83 0 -190 -131 -212 -259Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2216" d="M101 459l559 -409l39 42l-559 409Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D44E" d="M271 204c-116 -163 -196 -215 -233 -215c-19 0 -34 34 -34 78c0 78 31 198 75 287c25 49 58 79 120 110c27 13 47 18 75 18c27 0 44 -4 85 -19l33 18l10 -9l-92 -379c-1 -3 -1 -6 -1 -11c0 -14 6 -23 15 -23c22 0 51 27 75 47l7 -21c-82 -68 -123 -94 -146 -94 c-15 0 -24 13 -24 35c0 16 2 34 6 51zM319 414c-44 15 -62 19 -85 19c-48 0 -71 -18 -95 -73c-35 -80 -63 -197 -63 -261c0 -27 6 -40 18 -40c32 0 93 58 150 142c34 52 53 104 75 213Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-5D" d="M245 -184h-194l-6 6v26l4 5h38c27 0 49 6 61 16c9 9 12 23 12 56v691c0 33 -3 48 -12 57c-12 10 -34 16 -61 16h-38l-4 5v26l6 6h194c4 -9 5 -20 5 -35c0 -26 -4 -63 -4 -113v-622c0 -68 2 -96 8 -127Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
<g transform="translate(332,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D45D" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-2216" x="1285" y="0"></use>
<g transform="translate(2084,0)">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="706" y="-213"></use>
</g>
 <use xlink:href="#E1-ASANAMATHMAIN-5D" x="2997" y="0"></use>
</g>
</svg></td>
<td align="center">=</td>
<td align="left"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.121ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 913.1 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">v_a</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D44E" d="M271 204c-116 -163 -196 -215 -233 -215c-19 0 -34 34 -34 78c0 78 31 198 75 287c25 49 58 79 120 110c27 13 47 18 75 18c27 0 44 -4 85 -19l33 18l10 -9l-92 -379c-1 -3 -1 -6 -1 -11c0 -14 6 -23 15 -23c22 0 51 27 75 47l7 -21c-82 -68 -123 -94 -146 -94 c-15 0 -24 13 -24 35c0 16 2 34 6 51zM319 414c-44 15 -62 19 -85 19c-48 0 -71 -18 -95 -73c-35 -80 -63 -197 -63 -261c0 -27 6 -40 18 -40c32 0 93 58 150 142c34 52 53 104 75 213Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-ASANAMATHNORMAL-1D44E" x="706" y="-213"></use>
</g>
</svg></td>
<td align="left"></td>
</tr>
</tbody></table>
</figure>
</fieldset>

<h3 id="parser"><span class="heading-counter">1.3.15</span> Parser<code class="draft"> [](#parser)</code></h3>
<p>The parser is responsible for converting an Yocto-JavaScript program written as a string into data structures that are more convenient for the runner to manipulate (see <a href="#architecture">§&nbsp;1.3.1</a> for a high-level view of the architecture and <a href="#data-structures-to-represent-yocto-javascript-programs">§&nbsp;1.3.2</a> for the definition of the data structures). We choose to represent Yocto-JavaScript programs with data structures that are compatible with a specification for representing JavaScript programs called ESTree&nbsp;[??, ??] because it allows us to use tools from the JavaScript ecosystem, including a parser called Esprima&nbsp;[??], and the Esprima Interactive Online Demonstration&nbsp;[??], which shows the data structures used to represent a given program.</p>
<p>Our strategy to implement the Yocto-JavaScript parser is to delegate most of the work to Esprima and check that the program is using only features supported by Yocto-JavaScript. The following is the full implementation of the parser:</p>
<pre><code class="language-ts{number}"><span style="color: #aaa;"> 1</span>  <span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">parse</span><span style="color: #000000">(</span><span style="color: #001080">input</span><span style="color: #000000">: </span><span style="color: #267F99">string</span><span style="color: #000000">): </span><span style="color: #267F99">Expression</span><span style="color: #000000"> {</span>
<span style="color: #aaa;"> 2</span>  <span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">program</span><span style="color: #000000"> = </span><span style="color: #001080">esprima</span><span style="color: #000000">.</span><span style="color: #795E26">parseScript</span><span style="color: #000000">(</span><span style="color: #001080">input</span><span style="color: #000000">, { </span><span style="color: #001080">range:</span><span style="color: #000000"> </span><span style="color: #0000FF">true</span><span style="color: #000000"> }, </span><span style="color: #001080">checkFeatures</span><span style="color: #000000">);</span>
<span style="color: #aaa;"> 3</span>  <span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000"> = (</span><span style="color: #001080">program</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #267F99">any</span><span style="color: #000000">).</span><span style="color: #001080">body</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">].</span><span style="color: #001080">expression</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #267F99">Expression</span><span style="color: #000000">;</span>
<span style="color: #aaa;"> 4</span>  <span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000">;</span>
<span style="color: #aaa;"> 5</span>  <span style="color: #000000">  </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">checkFeatures</span><span style="color: #000000">(</span><span style="color: #001080">node</span><span style="color: #000000">: </span><span style="color: #267F99">estree</span><span style="color: #000000">.</span><span style="color: #267F99">Node</span><span style="color: #000000">): </span><span style="color: #267F99">void</span><span style="color: #000000"> {</span>
<span style="color: #aaa;"> 6</span>  <span style="color: #000000">    </span><span style="color: #0000FF">switch</span><span style="color: #000000"> (</span><span style="color: #001080">node</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000">) {</span>
<span style="color: #aaa;"> 7</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Program"</span><span style="color: #000000">:</span>
<span style="color: #aaa;"> 8</span>  <span style="color: #000000">        </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">node</span><span style="color: #000000">.</span><span style="color: #001080">body</span><span style="color: #000000">.</span><span style="color: #001080">length</span><span style="color: #000000"> !== </span><span style="color: #098658">1</span><span style="color: #000000">)</span>
<span style="color: #aaa;"> 9</span>  <span style="color: #000000">          </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span>
<span style="color: #aaa;">10</span>  <span style="color: #000000">            </span><span style="color: #A31515">"Unsupported Yocto-JavaScript feature: Program with multiple statements"</span>
<span style="color: #aaa;">11</span>  <span style="color: #000000">          );</span>
<span style="color: #aaa;">12</span>  <span style="color: #000000">        </span><span style="color: #0000FF">break</span><span style="color: #000000">;</span>
<span style="color: #aaa;">13</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ExpressionStatement"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">14</span>  <span style="color: #000000">        </span><span style="color: #0000FF">break</span><span style="color: #000000">;</span>
<span style="color: #aaa;">15</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">16</span>  <span style="color: #000000">        </span><span style="color: #0000FF">break</span><span style="color: #000000">;</span>
<span style="color: #aaa;">17</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">18</span>  <span style="color: #000000">        </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">node</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">.</span><span style="color: #001080">length</span><span style="color: #000000"> !== </span><span style="color: #098658">1</span><span style="color: #000000">)</span>
<span style="color: #aaa;">19</span>  <span style="color: #000000">          </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span>
<span style="color: #aaa;">20</span>  <span style="color: #000000">            </span><span style="color: #A31515">"Unsupported Yocto-JavaScript feature: CallExpression with multiple arguments"</span>
<span style="color: #aaa;">21</span>  <span style="color: #000000">          );</span>
<span style="color: #aaa;">22</span>  <span style="color: #000000">        </span><span style="color: #0000FF">break</span><span style="color: #000000">;</span>
<span style="color: #aaa;">23</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">24</span>  <span style="color: #000000">        </span><span style="color: #0000FF">break</span><span style="color: #000000">;</span>
<span style="color: #aaa;">25</span>  <span style="color: #000000">      </span><span style="color: #0000FF">default</span><span style="color: #000000">:</span>
<span style="color: #aaa;">26</span>  <span style="color: #000000">        </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">`Unsupported Yocto-JavaScript feature: </span><span style="color: #0000FF">${</span><span style="color: #001080">node</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span><span style="color: #000000">);</span>
<span style="color: #aaa;">27</span>  <span style="color: #000000">    }</span>
<span style="color: #aaa;">28</span>  <span style="color: #000000">  }</span>
<span style="color: #aaa;">29</span>  <span style="color: #000000">}</span></code></pre>
<p>\begin{description}
\item [Line 1:]</p>
<p>The parser is defined as a function called <code><span style="color: #795E26">parse</span><span style="color: #000000">()</span></code>, which receives the program <code><span style="color: #001080">input</span></code> represented as a <code><span style="color: #001080">string</span></code> and returns an <code><span style="color: #001080">Expression</span></code> (see <a href="#data-structures-to-represent-yocto-javascript-programs">§&nbsp;1.3.2</a>).</p>
<p>\item [Line 2:]</p>
<p>Call <code><span style="color: #001080">esprima</span><span style="color: #000000">.</span><span style="color: #795E26">parseScript</span><span style="color: #000000">()</span></code>, which parses the <code><span style="color: #001080">input</span></code> as a JavaScript program and produces a data structure following the ESTree specification. The <code><span style="color: #001080">esprima</span><span style="color: #000000">.</span><span style="color: #795E26">parseScript</span><span style="color: #000000">()</span></code> function also detects syntax errors, for example, in the program <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span></code>, which is missing the function body.</p>
<p>The <code><span style="color: #000000">{ </span><span style="color: #001080">range</span><span style="color: #000000">: </span><span style="color: #0000FF">true</span></code>} argument causes Esprima to include in the generated data structures some information about the part of the <code><span style="color: #001080">input</span></code> from where they came. We do not use this information (it is not even part of the definition of the data structures; see <a href="#data-structures-to-represent-yocto-javascript-programs">§&nbsp;1.3.2</a>), but in programs with expressions that repeat, for example, <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code>, this information distinguishes the <code><span style="color: #001080">x</span></code>s.</p>
<p>We pass as argument to <code><span style="color: #001080">esprima</span><span style="color: #000000">.</span><span style="color: #795E26">parseScript</span><span style="color: #000000">()</span></code> a function called <code><span style="color: #795E26">checkFeatures</span><span style="color: #000000">()</span></code> which is called with every fragment of data structure that represents a part of the program. The purpose of <code><span style="color: #795E26">checkFeatures</span><span style="color: #000000">()</span></code> is to check that the program uses only the features that are supported by Yocto-JavaScript.</p>
<p>\item [Line 3:]</p>
<p>Extract the single <code><span style="color: #001080">Expression</span></code> from within the <code><span style="color: #001080">Program</span></code> returned by <code><span style="color: #001080">esprima</span><span style="color: #000000">.</span><span style="color: #795E26">parseScript</span><span style="color: #000000">()</span></code>. The <code><span style="color: #0000FF">as</span><span style="color: #000000"> &lt;</span><span style="color: #267F99">something</span><span style="color: #000000">&gt;</span></code> forms sidestep the TypeScript type checker and assert that the <code><span style="color: #001080">expression</span></code> is of the correct type. This is safe to do because of <code><span style="color: #795E26">checkFeatures</span><span style="color: #000000">()</span></code>.</p>
<p>\item [Line 5:]</p>
<p>The <code><span style="color: #795E26">checkFeatures</span><span style="color: #000000">()</span></code> function, which is passed to <code><span style="color: #001080">esprima</span><span style="color: #000000">.</span><span style="color: #795E26">parseScript</span><span style="color: #000000">()</span></code> is called with every fragment of data structure used to represent the program. These fragments are called <em>nodes</em>, because the data structure as a whole forms a <em>tree</em>, also known as the <em>Abstract Syntax Tree</em>&nbsp;(AST) of the program (see <a href="#data-structures-to-represent-yocto-javascript-programs">§&nbsp;1.3.2</a>). The <code><span style="color: #795E26">checkFeatures</span><span style="color: #000000">()</span></code> does not return anything (<code><span style="color: #0000FF">void</span></code>); its purpose is only to throw an exception in case the program uses a feature that is not supported by Yocto-JavaScript.</p>
<p>\item [Lines 6, 7, 13, 15, 17, 23, 25:]</p>
<p>Similar to <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> and <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code> (see <a href="#the-entire-runner">§&nbsp;1.3.13</a>), <code><span style="color: #795E26">checkFeatures</span><span style="color: #000000">()</span></code> starts by determining which type of <code><span style="color: #001080">estree</span><span style="color: #000000">.</span><span style="color: #001080">Node</span></code> it is given.</p>
<p>\item [Lines 8–11:]</p>
<p>Check that the <code><span style="color: #001080">Program</span></code> contains a single statement. This prevents programs such as <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">; </span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span></code>.</p>
<p>\item [Lines 13, 15:]</p>
<p><code><span style="color: #001080">ExpressionStatement</span></code>s and <code><span style="color: #001080">ArrowFunctionExpression</span></code>s are supported in Yocto-JavaScript unconditionally. We could check that the <code><span style="color: #001080">ArrowFunctionExpression</span></code> includes only one parameter and that this parameter is a variable (as opposed to being a pattern such as <code><span style="color: #000000">[</span><span style="color: #001080">x</span><span style="color: #000000">, </span><span style="color: #001080">y</span><span style="color: #000000">]</span></code>, for example), but this would be redundant because Esprima already calls <code><span style="color: #795E26">checkFeatures</span><span style="color: #000000">()</span></code> with other unsupported <code><span style="color: #001080">node</span></code>s that subsume these cases. For example, given the program <code><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">, </span><span style="color: #001080">y</span><span style="color: #000000">) </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code>, which is a function of multiple parameters, Esprima calls <code><span style="color: #795E26">checkFeatures</span><span style="color: #000000">()</span></code> with a <code><span style="color: #001080">node</span></code> of type <code><span style="color: #001080">SequenceExpression</span></code>. Similarly, given the program <code><span style="color: #000000">([</span><span style="color: #001080">x</span><span style="color: #000000">, </span><span style="color: #001080">y</span><span style="color: #000000">]) </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code>, which is a function in which the parameter is a pattern, Esprima calls <code><span style="color: #795E26">checkFeatures</span><span style="color: #000000">()</span></code> with a <code><span style="color: #001080">node</span></code> of type <code><span style="color: #001080">ArrayExpression</span></code>.</p>
<p>\item [Lines 18–21:]</p>
<p>Check that the <code><span style="color: #001080">CallExpression</span></code> contains a single argument. This prevents programs such as <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">a</span><span style="color: #000000">, </span><span style="color: #001080">b</span><span style="color: #000000">)</span></code>.</p>
<p>\item [Line 23:]</p>
<p><code><span style="color: #001080">Identifier</span></code>s are supported in Yocto-JavaScript unconditionally. An <code><span style="color: #001080">Identifier</span></code> may be an expression or the parameter of an <code><span style="color: #001080">ArrowFunctionExpression</span></code>.</p>
<p>\item [Line 26:]</p>
<p>All other types of <code><span style="color: #001080">estree</span><span style="color: #000000">.</span><span style="color: #001080">Node</span></code> are not supported by Yocto-JavaScript. This includes programs such as <code><span style="color: #098658">29</span></code> (<code><span style="color: #001080">estree</span><span style="color: #000000">.</span><span style="color: #001080">Literal</span></code>) and <code><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000"> = </span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code> (<code><span style="color: #001080">estree</span><span style="color: #000000">.</span><span style="color: #001080">VariableDeclarator</span></code>).
\end{description}</p>
<p>In later Steps almost everything about the interpreter will change, but the parser will remain the same.</p>
<h3 id="generator"><span class="heading-counter">1.3.16</span> Generator<code class="draft"> [](#generator)</code></h3>
<p>The generator transforms a <code><span style="color: #001080">Value</span></code> produced by <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> into a human-readable format (see <a href="#architecture">§&nbsp;1.3.1</a> for a high-level view of the architecture). Similar to what happened in the parser (see <a href="#parser">§&nbsp;1.3.15</a>), we may implement the generator by reusing existing tools from the JavaScript ecosystem, because we are representing Yocto-JavaScript programs and values with data structures that follow the ESTree specification. In particular, we use a library called Escodegen&nbsp;[??] to generate a string representation of an ESTree data structure, and a library called Prettier&nbsp;[<a href="#prettier">26</a>] to format that string. The following is the full implementation of the generator:</p>
<pre><code class="language-ts{number}"><span style="color: #aaa;">1</span>  <span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">generate</span><span style="color: #000000">(</span><span style="color: #001080">value</span><span style="color: #000000">: </span><span style="color: #267F99">Value</span><span style="color: #000000">): </span><span style="color: #267F99">string</span><span style="color: #000000"> {</span>
<span style="color: #aaa;">2</span>  <span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">prettier</span>
<span style="color: #aaa;">3</span>  <span style="color: #000000">    .</span><span style="color: #795E26">format</span><span style="color: #000000">(</span><span style="color: #001080">escodegen</span><span style="color: #000000">.</span><span style="color: #795E26">generate</span><span style="color: #000000">(</span><span style="color: #001080">value</span><span style="color: #000000">), {</span>
<span style="color: #aaa;">4</span>  <span style="color: #000000">      </span><span style="color: #001080">parser:</span><span style="color: #000000"> </span><span style="color: #A31515">"babel"</span><span style="color: #000000">,</span>
<span style="color: #aaa;">5</span>  <span style="color: #000000">      </span><span style="color: #001080">semi:</span><span style="color: #000000"> </span><span style="color: #0000FF">false</span><span style="color: #000000">,</span>
<span style="color: #aaa;">6</span>  <span style="color: #000000">      </span><span style="color: #001080">arrowParens:</span><span style="color: #000000"> </span><span style="color: #A31515">"avoid"</span><span style="color: #000000">,</span>
<span style="color: #aaa;">7</span>  <span style="color: #000000">    })</span>
<span style="color: #aaa;">8</span>  <span style="color: #000000">    .</span><span style="color: #795E26">trim</span><span style="color: #000000">();</span>
<span style="color: #aaa;">9</span>  <span style="color: #000000">}</span></code></pre>
<p>\begin{description}
\item [Line 4:]</p>
<p>Prettier needs to parse and regenerate the string representing the value, in an architecture similar to that of the interpreter (see <a href="#architecture">§&nbsp;1.3.1</a>), and it may use different parsers. We choose Babel&nbsp;[<a href="#babel">2</a>], which is the default parser for JavaScript (Prettier also supports formatting other languages, for example, TypeScript and Markdown).</p>
<p>\item [Line 5:]</p>
<p>Instruct Prettier not to produce semicolons at the end of the line, for example, <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span></code> instead of <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">;</span></code>.</p>
<p>\item [Line 6:]</p>
<p>Instruct Prettier not to wrap parameters in parentheses, for example, <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span></code> instead of <code><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">) </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span></code>.</p>
<p>\item [Line 8:]</p>
<p>Remove the newline at the end of the output produced by Prettier.
\end{description}</p>
<h3 id="programs-that-do-not-terminate"><span class="heading-counter">1.3.17</span> Programs That Do Not Terminate<code class="draft"> [](#programs-that-do-not-terminate)</code></h3>
<p>\begin{center}
\begin{tabular}{ll}
\textbf{Example Program} &amp; <code><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))</span></code> \
\textbf{Current Output} &amp; <code><span style="color: undefined">DOES NOT TERMINATE</span></code> \
\textbf{Expected Output} &amp; <code><span style="color: undefined">DOES NOT TERMINATE</span></code> \
\end{tabular}
\end{center}</p>
<fieldset>
<legend><span class="legend-wrapper"><strong>Technical Terms</strong></span></legend>

<p>This example program is also known as the <em><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.915ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 824.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\Omega</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-3A9" d="M791 145c-7 -50 -14 -101 -17 -151c-103 4 -208 4 -311 6v68c159 21 206 165 206 306c0 170 -56 303 -250 303c-190 0 -263 -125 -263 -300c0 -142 45 -288 206 -309v-68c-103 -3 -207 -2 -310 -6c-5 50 -11 101 -18 151l4 3h15l3 -3c13 -52 13 -70 73 -70h129v7 c-134 56 -207 172 -207 316c0 223 167 306 368 306c199 0 356 -90 356 -306c0 -145 -74 -260 -208 -316v-7h129c60 0 60 17 73 70l4 3h14Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-3A9" x="0" y="0"></use>
</g>
</svg>-combinator</em>. The function <code><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)</span></code> that is part of this program is also known as the <em><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.855ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 798.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">U</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D448" d="M795 664l-36 -3c-38 -4 -45 -10 -51 -48l-85 -507c-5 -36 -6 -41 -6 -56c0 -13 9 -19 32 -21l60 -4l-5 -28l-32 1c-32 1 -54 2 -58 2l-62 -3h-22l-5 5c13 55 19 81 27 127c-52 -60 -84 -85 -143 -114c-48 -24 -89 -34 -133 -34c-112 0 -179 62 -179 163c0 16 2 41 6 62 l64 375c4 21 7 49 7 58c0 17 -8 22 -34 23l-52 2l3 28l32 -1c28 -1 48 -2 58 -2c11 0 31 1 58 2l31 1l-88 -477c-5 -28 -7 -44 -7 -61c0 -70 54 -115 139 -115c38 0 75 9 113 29c51 25 81 51 129 109l71 445c1 4 1 7 1 12c0 19 -11 27 -35 28l-48 2l3 28l63 -2 c44 -1 65 -1 80 -1l91 3h16Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D448" x="0" y="0"></use>
</g>
</svg>-combinator</em> (<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.556ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4975.6 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\Omega = (U)(U)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-3A9" d="M791 145c-7 -50 -14 -101 -17 -151c-103 4 -208 4 -311 6v68c159 21 206 165 206 306c0 170 -56 303 -250 303c-190 0 -263 -125 -263 -300c0 -142 45 -288 206 -309v-68c-103 -3 -207 -2 -310 -6c-5 50 -11 101 -18 151l4 3h15l3 -3c13 -52 13 -70 73 -70h129v7 c-134 56 -207 172 -207 316c0 223 167 306 368 306c199 0 356 -90 356 -306c0 -145 -74 -260 -208 -316v-7h129c60 0 60 17 73 70l4 3h14Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-3D" d="M604 347h-539v59h539v-59zM604 134h-539v59h539v-59Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-28" d="M146 266c0 -281 109 -403 155 -460l-19 -21c-82 77 -114 116 -149 183c-48 90 -73 191 -73 298c0 276 165 409 222 460l19 -26c-58 -68 -155 -174 -155 -434Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D448" d="M795 664l-36 -3c-38 -4 -45 -10 -51 -48l-85 -507c-5 -36 -6 -41 -6 -56c0 -13 9 -19 32 -21l60 -4l-5 -28l-32 1c-32 1 -54 2 -58 2l-62 -3h-22l-5 5c13 55 19 81 27 127c-52 -60 -84 -85 -143 -114c-48 -24 -89 -34 -133 -34c-112 0 -179 62 -179 163c0 16 2 41 6 62 l64 375c4 21 7 49 7 58c0 17 -8 22 -34 23l-52 2l3 28l32 -1c28 -1 48 -2 58 -2c11 0 31 1 58 2l31 1l-88 -477c-5 -28 -7 -44 -7 -61c0 -70 54 -115 139 -115c38 0 75 9 113 29c51 25 81 51 129 109l71 445c1 4 1 7 1 12c0 19 -11 27 -35 28l-48 2l3 28l63 -2 c44 -1 65 -1 80 -1l91 3h16Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-29" d="M51 726c57 -51 222 -184 222 -461c0 -288 -169 -430 -222 -480l-19 21c51 63 155 184 155 460c0 260 -100 370 -155 434Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-3A9" x="0" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-3D" x="1102" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-28" x="2048" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D448" x="2381" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-29" x="3179" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-28" x="3512" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D448" x="3844" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-29" x="4643" y="0"></use>
</g>
</svg>).</p>
</fieldset>

<p>Yocto-JavaScript may express any program that a computer may run (see §&nbsp;\ref{The Computational Power of Yocto-JavaScript}), including some programs that do not terminate. For example, consider the program above, which is the shortest non-terminating program in Yocto-JavaScript. The following is a trace of the first call to <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code>:</p>
<p>\begin{center}
\begin{tabular}{rrcl}
\textbf{Line} &amp; \multicolumn{1}{l}{(see <a href="#the-entire-runner">§&nbsp;1.3.13</a>)} &amp; &amp; \
3 &amp; <code><span style="color: #001080">expression</span></code> &amp; = &amp; <code><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))</span></code> \
9 &amp; <code><span style="color: #001080">parameter</span></code> &amp; = &amp; <code><span style="color: #001080">f</span></code> \
10 &amp; <code><span style="color: #001080">body</span></code> &amp; = &amp; <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)</span></code> \
12 &amp; <code><span style="color: #001080">argument</span></code> &amp; = &amp; <code><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)</span></code> \
13 &amp; <code><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">body</span><span style="color: #000000">)</span></code> &amp; = &amp; <code><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))</span></code> \
\end{tabular}
\end{center}</p>
<p>The result of substitution is the same as the initial expression, so when it is passed as argument to the recursive call to <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> in line&nbsp;13, it causes <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> to go into an infinite loop.</p>
<p>\begin{center}
\begin{tabular}{ll}
\textbf{Example Program} &amp; <code><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> (</span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))(</span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)))(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> (</span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))(</span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)))</span></code> \
\textbf{Current Output} &amp; <code><span style="color: undefined">DOES NOT TERMINATE</span></code> \
\textbf{Expected Output} &amp; <code><span style="color: undefined">DOES NOT TERMINATE</span></code> \
\end{tabular}
\end{center}</p>
<p>There are also programs for which interpretation does not terminate that never produce the same expression twice. For example, consider the program above, which is a variation of the first program in which every variable reference to <code><span style="color: #001080">f</span></code> has been replaced with <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)</span></code>. The following is a trace of the first call to <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code>:</p>
<p>\begin{center}
\begin{tabular}{rrcl}
\textbf{Line} &amp; \multicolumn{1}{l}{(see <a href="#the-entire-runner">§&nbsp;1.3.13</a>)} &amp; &amp; where <code><span style="color: #795E26">F</span><span style="color: #000000"> = </span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> (</span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))(</span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))</span></code> \
3 &amp; <code><span style="color: #001080">expression</span></code> &amp; = &amp; <code><span style="color: #795E26">F</span><span style="color: #000000">(F)</span></code> \
9 &amp; <code><span style="color: #001080">parameter</span></code> &amp; = &amp; <code><span style="color: #001080">f</span></code> \
10 &amp; <code><span style="color: #001080">body</span></code> &amp; = &amp; <code><span style="color: #000000">(</span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))(</span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))</span></code> \
12 &amp; <code><span style="color: #001080">argument</span></code> &amp; = &amp; <code><span style="color: #000000">F</span></code> \
13 &amp; <code><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">body</span><span style="color: #000000">)</span></code> &amp; = &amp; <code><span style="color: #000000">(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))</span></code> \
\end{tabular}
\end{center}</p>
<p>The result of substitution (<code><span style="color: #000000">(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))</span></code>) is an expression that contains the initial expression (the first <code><span style="color: #795E26">F</span><span style="color: #000000">(F)</span></code>) in addition to some extra work (the second <code><span style="color: #795E26">F</span><span style="color: #000000">(F)</span></code>), so when it is passed as argument to the recursive call to <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> in line&nbsp;13, it causes <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> to go into an infinite loop. Unlike what happened in the first example, when interpreting this program the expressions that are passed to <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> never repeat themselves:</p>
<p>\begin{center}
\begin{tabular}{l}
<code><span style="color: #000000">(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))</span></code> \
<code><span style="color: #000000">(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))</span></code> \
<code><span style="color: #000000">(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))</span></code> \
<code><span style="color: #000000">(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))</span></code> \
\multicolumn{1}{c}{<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.579ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 249.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\vdots</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-22EE" d="M124 674c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58zM124 329c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58zM124 -26c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-22EE" x="0" y="0"></use>
</g>
</svg>} \
\end{tabular}
\end{center}</p>
<p>Non-termination is what we expect from an interpreter, but not from an analyzer, and as the second example demonstrates, preventing non-termination is not as simple as checking whether <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> is being called with the same expression multiple times. As we move forward from an interpreter to an analyzer in the next Steps one of the main issues we address is termination: even if it takes a long time, an analyzer must eventually finish its work regardless of the program it is given.</p>
<fieldset>
<legend><span class="legend-wrapper"><strong>Advanced</strong></span></legend>

<p>Detecting non-termination in an interpreter without losing any information about the original program is a problem that cannot be solved, regardless of the sophistication of the detector and the computational power available to it. The problem, which is known as the <em>halting problem</em>, is said to be <em>uncomputable</em>&nbsp;[<a href="#understanding-computation">30 (§&nbsp;8)</a>], and is a direct consequence of the Turing completeness of Yocto-JavaScript (see §&nbsp;\ref{The Computational Power of Yocto-JavaScript}). In our analyzer we will guarantee termination by allowing some information to be lost.</p>
</fieldset>

<h2 id="step-1-environment-based-interpreter"><span class="heading-counter">1.4</span> Step 1: Environment-Based Interpreter<code class="draft"> [](#step-1-environment-based-interpreter)</code></h2>
<p>The interpreter in Step&nbsp;0 may not terminate for some programs, and preventing non-termination is one of the main issues we must address when developing an analyzer (see §&nbsp;\ref{Step 0: Programs That Do Not Terminate}). The source of non-termination in Step&nbsp;0 is substitution, which may produce infinitely many new expressions and cause the interpreter to loop forever. In Step&nbsp;1, we modify the interpreter so that it does not perform substitution, and as a consequence it considers only the finitely many expressions found in the input program. The interpreter in Step&nbsp;1 may still not terminate, but that is due to other sources of non-termination that will be addressed in subsequent Steps.</p>
<h3 id="avoiding-substitution-by-introducing-environments-and-closures"><span class="heading-counter">1.4.1</span> Avoiding Substitution by Introducing Environments and Closures<code class="draft"> [](#avoiding-substitution-by-introducing-environments-and-closures)</code></h3>
<p>When the interpreter from Step&nbsp;0 encounters a function call, it produces a new expression by traversing the body of the called function and substituting the references to the parameter with the argument, for example:</p>
<p>\begin{center}
\begin{tabular}{ll}
\textbf{Example Program} (see <a href="#substitution-in-function-definitions">§&nbsp;1.3.5</a>) &amp; <code><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code> \
\textbf{Step&nbsp;0 Output} &amp; <code><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> (</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code> \
\end{tabular}
\end{center}</p>
<p>The issue with this strategy is that the expression <code><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> (</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code> does not exist in the original program, and as mentioned in §&nbsp;\ref{Step 0: Programs That Do Not Terminate}, there is a possibility that the interpreter tries to produce infinitely many of these new expressions and loops forever. In Step&nbsp;1 we want to avoid producing new expressions, so that the interpreter has to consider only the finitely many expressions found in the original program. We accomplish this by interpreting function calls with a different strategy: instead of performing substitution, we maintain a map from variables to the values with which they would have been substituted, for example:</p>
<p>\begin{center}
\begin{tabular}{ll}
\textbf{Example Program} &amp; <code><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span></code> \
\textbf{Step&nbsp;1 Output} &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(y =&gt; y) ``, [] \rangle `` \\ \textbf{Example Program} &amp; `` js</code>(x =&gt; z =&gt; x)(y =&gt; y) <code>\\ \textbf{Step 1 Output} &amp;</code> math<code>\langle `` js</code>(z =&gt; x) <code>, [</code> js<code>x `` \mapsto \langle `` js</code>(y =&gt; y) <code>, [] \rangle] \rangle</code> \
\end{tabular}
\end{center}</p>
<fieldset>
<legend><span class="legend-wrapper"><strong>Technical Terms</strong></span></legend>

<p>A map from variables to the values with which they would have been replaced (for example, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.772ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 332.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
</g>
</svg> js<code>x `` \mapsto \langle `` js</code>(y =&gt; y) <code>, [] \rangle]</code>) is something called an <em>environment</em>. A function along with an environment (for example, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(z =&gt; x) ``, [ `` js</code>x <code>\mapsto \langle</code> js<code>(y =&gt; y)</code>, [] \rangle] \rangle`) is something called a <em>closure</em>&nbsp;[<a href="#closures">13</a>].</p>
</fieldset>

<p>In Step&nbsp;1 we have a different notion of <em>value</em>: while in Step&nbsp;0 the interpreter produced a <em>function</em>, now it produces a <em>closure</em>. It is possible to use the closure produced in Step&nbsp;1 to recreate the function that would have been produced in Step&nbsp;0 by substituting the variable references in the function body with the corresponding values from the environment found in the closure. We may do this to check that the outputs of the interpreters are equivalent, but in Step&nbsp;1 we do not perform substitution in the regular course of interpretation; we add more mappings to the environment and look up variable references in the environment.</p>
<fieldset>
<legend><span class="legend-wrapper"><strong>Alternative Argument</strong></span></legend>

<p>Another way to reason about an environment-based interpreter is that it is a substitution-based interpreter in which substitutions are delayed until they are needed.</p>
</fieldset>

<h3 id="new-data-structures"><span class="heading-counter">1.4.2</span> New Data Structures<code class="draft"> [](#new-data-structures)</code></h3>
<p>The following are the data structures used to represent environments and closures:</p>
<pre><code class="language-ts"><span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Value</span><span style="color: #000000"> = </span><span style="color: #267F99">Closure</span><span style="color: #000000">;</span>

<span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Closure</span><span style="color: #000000"> = {</span>
<span style="color: #000000">  </span><span style="color: #001080">function</span><span style="color: #000000">: </span><span style="color: #267F99">ArrowFunctionExpression</span><span style="color: #000000">;</span>
<span style="color: #000000">  </span><span style="color: #001080">environment</span><span style="color: #000000">: </span><span style="color: #267F99">Environment</span><span style="color: #000000">;</span>
<span style="color: #000000">};</span>

<span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Environment</span><span style="color: #000000"> = </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Identifier</span><span style="color: #000000">[</span><span style="color: #A31515">"name"</span><span style="color: #000000">], </span><span style="color: #267F99">Value</span><span style="color: #000000">&gt;;</span></code></pre>
<fieldset>
<legend><span class="legend-wrapper"><strong>Implementation Details</strong></span></legend>

<p>The <code><span style="color: #001080">MapDeepEqual</span></code> data structure is provided by a JavaScript package developed by the author called Collections Deep Equal&nbsp;[<a href="#collections-deep-equal">6</a>]. A <code><span style="color: #001080">MapDeepEqual</span></code> is similar to a <code><span style="color: #267F99">Map</span></code>, except that the keys are compared by value, not by reference, for example:</p>
<pre><code class="language-ts"><span style="color: #000000">&gt; </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Map</span><span style="color: #000000">([[{ </span><span style="color: #001080">age:</span><span style="color: #000000"> </span><span style="color: #098658">29</span><span style="color: #000000"> }, </span><span style="color: #A31515">"Leandro"</span><span style="color: #000000">]]).</span><span style="color: #795E26">get</span><span style="color: #000000">({ </span><span style="color: #001080">age:</span><span style="color: #000000"> </span><span style="color: #098658">29</span><span style="color: #000000"> });</span>
<span style="color: #0000FF">undefined</span>
<span style="color: #000000">&gt; </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">([[{ </span><span style="color: #001080">age:</span><span style="color: #000000"> </span><span style="color: #098658">29</span><span style="color: #000000"> }, </span><span style="color: #A31515">"Leandro"</span><span style="color: #000000">]]).</span><span style="color: #795E26">get</span><span style="color: #000000">({ </span><span style="color: #001080">age:</span><span style="color: #000000"> </span><span style="color: #098658">29</span><span style="color: #000000"> });</span>
<span style="color: #A31515">"Leandro"</span></code></pre>
<p>The occurrences of <code><span style="color: #000000">{ </span><span style="color: #001080">age</span><span style="color: #000000">: </span><span style="color: #098658">29</span></code>} are objects with the same key and value, but they are not the same object.</p>
</fieldset>

<h3 id="adding-an-environment-to-the-runner"><span class="heading-counter">1.4.3</span> Adding an Environment to the Runner<code class="draft"> [](#adding-an-environment-to-the-runner)</code></h3>
<p>The runner needs to maintain an environment, so we modify the implementation of <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> from <a href="#the-entire-runner">§&nbsp;1.3.13</a> to introduce an auxiliary function called <code><span style="color: #795E26">step</span><span style="color: #000000">()</span></code> that receives an <code><span style="color: #001080">environment</span></code> as an extra parameter:</p>
<pre><code class="language-ts{number}{2-3,11-13}"><span style="color: #aaa;"> 1</span>  <span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): </span><span style="color: #267F99">Value</span><span style="color: #000000"> {</span>
<div style="background-color: #e0ffff;"><span style="color: #aaa;"> 2</span>  <span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">, </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">());</span>
<div style="background-color: #e0ffff;"></div><span style="color: #aaa;"> 3</span>  <span style="color: #000000">  </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">: </span><span style="color: #267F99">Environment</span><span style="color: #000000">): </span><span style="color: #267F99">Value</span><span style="color: #000000"> {</span>
</div><span style="color: #aaa;"> 4</span>  <span style="color: #000000">    </span><span style="color: #0000FF">switch</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000">) {</span>
<span style="color: #aaa;"> 5</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">:</span>
<span style="color: #aaa;"> 6</span>  <span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000">;</span>
<span style="color: #aaa;"> 7</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #aaa;"> 8</span>  <span style="color: #000000">        </span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<span style="color: #aaa;"> 9</span>  <span style="color: #000000">          </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<span style="color: #aaa;">10</span>  <span style="color: #000000">          </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<div style="background-color: #e0ffff;"><span style="color: #aaa;">11</span>  <span style="color: #000000">        } = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"></div><span style="color: #aaa;">12</span>  <span style="color: #000000">        </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">], </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"></div><span style="color: #aaa;">13</span>  <span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">body</span><span style="color: #000000">), </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
</div><span style="color: #aaa;">14</span>  <span style="color: #000000">        </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): </span><span style="color: #267F99">Expression</span><span style="color: #000000"> {</span>
<span style="color: #aaa;">15</span>  <span style="color: #000000">          </span><span style="color: #0000FF">switch</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000">) {</span>
<span style="color: #aaa;">16</span>  <span style="color: #000000">            </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">17</span>  <span style="color: #000000">              </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">params</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">].</span><span style="color: #001080">name</span><span style="color: #000000"> === </span><span style="color: #001080">parameter</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">)</span>
<span style="color: #aaa;">18</span>  <span style="color: #000000">                </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000">;</span>
<span style="color: #aaa;">19</span>  <span style="color: #000000">              </span><span style="color: #0000FF">return</span><span style="color: #000000"> {</span>
<span style="color: #aaa;">20</span>  <span style="color: #000000">                ...</span><span style="color: #001080">expression</span><span style="color: #000000">,</span>
<span style="color: #aaa;">21</span>  <span style="color: #000000">                </span><span style="color: #001080">body:</span><span style="color: #000000"> </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">body</span><span style="color: #000000">),</span>
<span style="color: #aaa;">22</span>  <span style="color: #000000">              };</span>
<span style="color: #aaa;">23</span>  <span style="color: #000000">            </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">24</span>  <span style="color: #000000">              </span><span style="color: #0000FF">return</span><span style="color: #000000"> {</span>
<span style="color: #aaa;">25</span>  <span style="color: #000000">                ...</span><span style="color: #001080">expression</span><span style="color: #000000">,</span>
<span style="color: #aaa;">26</span>  <span style="color: #000000">                </span><span style="color: #001080">callee:</span><span style="color: #000000"> </span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">),</span>
<span style="color: #aaa;">27</span>  <span style="color: #000000">                </span><span style="color: #001080">arguments:</span><span style="color: #000000"> [</span><span style="color: #795E26">substitute</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">])],</span>
<span style="color: #aaa;">28</span>  <span style="color: #000000">              };</span>
<span style="color: #aaa;">29</span>  <span style="color: #000000">            </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">30</span>  <span style="color: #000000">              </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000"> !== </span><span style="color: #001080">parameter</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">) </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000">;</span>
<span style="color: #aaa;">31</span>  <span style="color: #000000">              </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000">;</span>
<span style="color: #aaa;">32</span>  <span style="color: #000000">          }</span>
<span style="color: #aaa;">33</span>  <span style="color: #000000">        }</span>
<span style="color: #aaa;">34</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">35</span>  <span style="color: #000000">        </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span><span style="color: #A31515">`Reference to undefined variable: </span><span style="color: #0000FF">${</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span><span style="color: #000000">);</span>
<span style="color: #aaa;">36</span>  <span style="color: #000000">    }</span>
<span style="color: #aaa;">37</span>  <span style="color: #000000">  }</span>
<span style="color: #aaa;">38</span>  <span style="color: #000000">}</span></code></pre>
<p>\begin{description}
\item [Line 3:]</p>
<p>We define the <code><span style="color: #795E26">step</span><span style="color: #000000">()</span></code> auxiliary function that receives an <code><span style="color: #001080">environment</span></code> as an extra parameter.</p>
<p>\item [Line 2:]</p>
<p>The <code><span style="color: #001080">environment</span></code> starts empty.</p>
<p>\item [Lines 11–13:]</p>
<p>The recursive calls to <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> are changed to recursive calls to <code><span style="color: #795E26">step</span><span style="color: #000000">()</span></code> and the <code><span style="color: #001080">environment</span></code> is propagated.
\end{description}</p>
<p>The listing above does not compile yet because we are not producing closures. In the following sections we fix this by considering how to manage the <code><span style="color: #001080">environment</span></code> for each type of <code><span style="color: #001080">expression</span></code>.</p>
<h3 id="a-function-definition"><span class="heading-counter">1.4.4</span> A Function Definition<code class="draft"> [](#a-function-definition)</code></h3>
<p>\begin{center}
\begin{tabular}{ll}
\textbf{Example Program} &amp; <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code> \
\textbf{Current Output} &amp; — \
\textbf{Expected Output} &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(x =&gt; x)</code>, [] \rangle` \
\end{tabular}
\end{center}</p>
<p>When the interpreter encounters a function definition, it captures the current <code><span style="color: #001080">environment</span></code> in a closure:</p>
<pre><code class="language-ts"><span style="color: #008000">// step()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">:</span>
<span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> { </span><span style="color: #001080">function:</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000"> };</span></code></pre>
<h3 id="a-function-call"><span class="heading-counter">1.4.5</span> A Function Call<code class="draft"> [](#a-function-call)</code></h3>
<p>\begin{center}
\begin{tabular}{ll}
\textbf{Example Program} &amp; <code><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code> \
\textbf{Current Output} &amp; — \
\textbf{Expected Output} &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(z =&gt; x) ``, [ `` js</code>x <code>\mapsto \langle</code> js<code>(y =&gt; y)</code>, [] \rangle] \rangle` \
\end{tabular}
\end{center}</p>
<p>First, we remove <code><span style="color: #795E26">substitute</span><span style="color: #000000">()</span></code>, which is the goal of Step&nbsp;1:</p>
<pre><code class="language-ts{8}"><span style="color: #008000">// step()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<span style="color: #000000">    </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<span style="color: #000000">    </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<span style="color: #000000">  } = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">], </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">body</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
</div></code></pre>
<p>Next, we fix the pattern that matches the result of the interpretation of the called function to take in account the closure:</p>
<pre><code class="language-ts{4,7,8}"><span style="color: #008000">// step()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">    </span><span style="color: #001080">function</span><span style="color: #000000">: {</span>
</div><span style="color: #000000">      </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<span style="color: #000000">      </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">    },</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #001080">environment</span><span style="color: #000000">: </span><span style="color: #001080">functionEnvironment</span><span style="color: #000000">,</span>
</div><span style="color: #000000">  } = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">], </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">body</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">);</span></code></pre>
<p>Finally, we modify the recursive call to <code><span style="color: #795E26">step</span><span style="color: #000000">()</span></code> that interprets the function body so that it receives a new augmented <code><span style="color: #001080">environment</span></code> including a mapping from the <code><span style="color: #001080">parameter</span></code> (for example, <code><span style="color: #001080">x</span></code>) to the <code><span style="color: #001080">argument</span></code> (for example, <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(y =&gt; y)</code>, [] \rangle`):</p>
<pre><code class="language-ts{number}{11-14}"><span style="color: #aaa;"> 1</span>  <span style="color: #008000">// step()</span>
<span style="color: #aaa;"> 2</span>  <span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #aaa;"> 3</span>  <span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<span style="color: #aaa;"> 4</span>  <span style="color: #000000">    </span><span style="color: #001080">function</span><span style="color: #000000">: {</span>
<span style="color: #aaa;"> 5</span>  <span style="color: #000000">      </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<span style="color: #aaa;"> 6</span>  <span style="color: #000000">      </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<span style="color: #aaa;"> 7</span>  <span style="color: #000000">    },</span>
<span style="color: #aaa;"> 8</span>  <span style="color: #000000">    </span><span style="color: #001080">environment</span><span style="color: #000000">: </span><span style="color: #001080">functionEnvironment</span><span style="color: #000000">,</span>
<span style="color: #aaa;"> 9</span>  <span style="color: #000000">  } = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<span style="color: #aaa;">10</span>  <span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">], </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"><span style="color: #aaa;">11</span>  <span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span>
<div style="background-color: #e0ffff;"></div><span style="color: #aaa;">12</span>  <span style="color: #000000">    </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<div style="background-color: #e0ffff;"></div><span style="color: #aaa;">13</span>  <span style="color: #000000">    </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">(</span><span style="color: #001080">environment</span><span style="color: #000000">).</span><span style="color: #795E26">set</span><span style="color: #000000">(</span><span style="color: #001080">parameter</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">, </span><span style="color: #001080">argument</span><span style="color: #000000">)</span>
<div style="background-color: #e0ffff;"></div><span style="color: #aaa;">14</span>  <span style="color: #000000">  );</span>
</div></code></pre>
<h3 id="name-reuse-1"><span class="heading-counter">1.4.6</span> Name Reuse<code class="draft"> [](#name-reuse-1)</code></h3>
<p>\begin{center}
\begin{tabular}{ll}
\textbf{Example Program} &amp; <code><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)(</span><span style="color: #001080">a</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">a</span><span style="color: #000000">)(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code> \
\textbf{Current Output} &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(z =&gt; x) ``, [ `` js</code>x <code>\mapsto \langle</code> js<code>(y =&gt; y) ``, [] \rangle] \rangle `` \\ \textbf{Expected Output} &amp; `` math</code>\langle <code><span style="color: #000000">(</span><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)</span></code>, [<code><span style="color: #001080">x</span></code> \mapsto \langle <code><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code>, [] \rangle] \rangle `` \
\end{tabular}
\end{center}</p>
<p>If a name is reused (for example, <code><span style="color: #001080">x</span></code> in the example program above), then the second time it is encountered by <code><span style="color: #795E26">step</span><span style="color: #000000">()</span></code> it is overwritten in the <code><span style="color: #001080">environment</span></code> (see the call to <code><span style="color: #795E26">set</span><span style="color: #000000">()</span></code> in line&nbsp;13 of §&nbsp;\ref{A Function Call}, which overwrites an existing map key). This causes the variable reference to <code><span style="color: #001080">x</span></code> to refer to the second (inner) <code><span style="color: #001080">x</span></code>, which is the expected behavior (it is what we called Option&nbsp;2 in §&nbsp;\ref{Step 0: Name Reuse}).</p>
<h3 id="a-variable-reference"><span class="heading-counter">1.4.7</span> A Variable Reference<code class="draft"> [](#a-variable-reference)</code></h3>
<p>\begin{center}
\begin{tabular}{ll}
\textbf{Example Program} &amp; <code><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)</span></code> \
\textbf{Current Output} &amp; — \
\textbf{Expected Output} &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(y =&gt; y) ``, [] \rangle `` \\ \\ \textbf{Example Program} &amp; `` js</code>(x =&gt; y)(y =&gt; y) <code>\\ \textbf{Current Output} &amp; — \\ \textbf{Expected Output} &amp;</code> text<code>Reference to undefined variable: y `` \\ \\ \textbf{Example Program} &amp; `` js</code>x =&gt; y <code>\\ \textbf{Current Output} &amp; — \\ \textbf{Expected Output} &amp;</code> math<code>\langle `` js</code>(x =&gt; y) <code>, [] \rangle</code> \
\end{tabular}
\end{center}</p>
<p>When we encounter a variable reference, we look it up in the current environment:</p>
<pre><code class="language-ts{3-8}"><span style="color: #008000">// step()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">:</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">value</span><span style="color: #000000"> = </span><span style="color: #001080">environment</span><span style="color: #000000">.</span><span style="color: #795E26">get</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">  </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">value</span><span style="color: #000000"> === </span><span style="color: #0000FF">undefined</span><span style="color: #000000">)</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">      </span><span style="color: #A31515">`Reference to undefined variable: </span><span style="color: #0000FF">${</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">    );</span>
<div style="background-color: #e0ffff;"></div><span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">value</span><span style="color: #000000">;</span>
</div></code></pre>
<h3 id="a-function-body-is-evaluated-with-the-environment-in-its-closure"><span class="heading-counter">1.4.8</span> A Function Body Is Evaluated with the Environment in Its Closure<code class="draft"> [](#a-function-body-is-evaluated-with-the-environment-in-its-closure)</code></h3>
<p>\begin{center}
\begin{tabular}{ll}
\textbf{Example Program} &amp; \
\multicolumn{2}{l}{<code><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> (</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">))(</span><span style="color: #001080">a</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">a</span><span style="color: #000000">))((</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">))</span></code>} \
\textbf{Current Output} &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(a =&gt; a) ``, [ `` js</code>f <code>\mapsto \langle</code> js<code>(z =&gt; x) ``, [ `` js</code>x <code>\mapsto \langle</code> js<code>(y =&gt; y) ``, [] \rangle ] \rangle] \rangle `` \\ \textbf{Expected Output} &amp; `` math</code>\langle <code><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code>, [] \rangle `` \
\end{tabular}
\end{center}</p>
<p>This example program shows the difference between the current environment with which an expression is evaluated and the environment that comes from a closure. The following is a trace of the first call to <code><span style="color: #795E26">step</span><span style="color: #000000">()</span></code>, when a closure is created:</p>
<p>\begin{center}
\begin{tabular}{rrcl}
\multicolumn{4}{c}{\textbf{Trace 1: First Call to <code><span style="color: #795E26">step</span><span style="color: #000000">()</span></code> ·&nbsp;Closure Creation}} \
\textbf{Line} &amp; \multicolumn{1}{l}{(see §&nbsp;\ref{A Function Call})} &amp; &amp; \
&amp; <code><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span></code> &amp; = &amp; <code><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> (</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">))(</span><span style="color: #001080">a</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">a</span><span style="color: #000000">)</span></code> \
&amp; <code><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">]</span></code> &amp; = &amp; <code><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code> \
\rowcolor[rgb]{.88,1,1} 10 &amp; <code><span style="color: #001080">argument</span></code> &amp; = &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(z =&gt; x) ``, [ `` js</code>x <code>\mapsto \langle</code> js<code>(y =&gt; y)</code>, [] \rangle] \rangle` \
\end{tabular}
\end{center}</p>
<p>And the following is a trace of the recursive call to <code><span style="color: #795E26">step</span><span style="color: #000000">()</span></code> in which that closure is called:</p>
<p>\begin{center}
\begin{tabular}{rrcl}
\multicolumn{4}{c}{\textbf{Trace 2: Recursive Call to <code><span style="color: #795E26">step</span><span style="color: #000000">()</span></code> ·&nbsp;Closure Call}} \
\textbf{Line} &amp; \multicolumn{1}{l}{(see §&nbsp;\ref{A Function Call})} &amp; &amp; \
&amp; <code><span style="color: #001080">expression</span></code> &amp; = &amp; <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000">)</span></code> \
&amp; <code><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span></code> &amp; = &amp; <code><span style="color: #001080">f</span></code> \
\rowcolor[rgb]{.88,1,1} &amp; <code><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">]</span></code> &amp; = &amp; <code><span style="color: #001080">x</span></code> \
\rowcolor[rgb]{.88,1,1} &amp; <code><span style="color: #001080">environment</span></code> &amp; = &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.772ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 332.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
</g>
</svg> js<code>x `` \mapsto \langle `` js</code>(a =&gt; a) <code>, [\cdots] \rangle, \cdots]</code> \
9 &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0" height="0.343ex" style="vertical-align: -0.171ex;" viewBox="0 -73.8 0 147.5" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title"></title>
<defs aria-hidden="true"></defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true"></g>
</svg> ts<code>step( ``\cdots `` ts</code>) <code>&amp; = &amp;</code> math<code>\langle `` js</code> (z =&gt; x) <code>, [</code> js <code>x</code>\mapsto \langle<code>js</code> (y =&gt; y) <code>, [] \rangle] \rangle</code> \ 5 &amp; <code>ts `parameter `&amp; = &amp;` js` z</code> \ \rowcolor[rgb]{.88,1,1} 6 &amp; <code>ts `body `&amp; = &amp;` js` x</code> \ \rowcolor[rgb]{.88,1,1} 8 &amp; <code>ts `functionEnvironment `&amp; = &amp;` math` [</code> js <code>x</code>\mapsto \langle<code>js</code>(y =&gt; y) <code>, [] \rangle]</code> \
\multicolumn{4}{c}{Paused before line 10}\
\end{tabular}
\end{center}</p>
<p>At this point, there are two expressions left to evaluate: the argument (<code><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">]</span></code>; line 10), and the body of the called function (<code><span style="color: #001080">body</span></code>; lines 11–14). Both of these expressions have the same code (<code><span style="color: #001080">x</span></code>), and our current implementation looks up this variable both times on the current <code><span style="color: #001080">environment</span></code>, which produces the same value: <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(a =&gt; a)</code>, [\cdots] \rangle`.</p>
<p>But this leads to an issue: we may not reason about <code><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span></code> by looking only at where it is defined; we must also examine all the places in which it may be called. This is the same issue we had to solve when considering name reuse in Step&nbsp;0 (see §&nbsp;\ref{Step 0: Name Reuse}). We would like, instead, for each <code><span style="color: #001080">x</span></code> to refer to the value that existed in the environment where the closure is <em>created</em>, not where it is <em>called</em>:</p>
<p>\begin{center}
\includegraphics[page = 8]{images.pdf}
\end{center}</p>
<p>To implement this, we change the recursive call to <code><span style="color: #795E26">step</span><span style="color: #000000">()</span></code> that evaluates the function body so that it uses the environment coming from the closure (<code><span style="color: #001080">functionEnvironment</span></code>) instead of the current environment (<code><span style="color: #001080">environment</span></code>):</p>
<pre><code class="language-ts{13}"><span style="color: #008000">// step()</span>
<span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<span style="color: #000000">    </span><span style="color: #001080">function</span><span style="color: #000000">: {</span>
<span style="color: #000000">      </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<span style="color: #000000">      </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<span style="color: #000000">    },</span>
<span style="color: #000000">    </span><span style="color: #001080">environment</span><span style="color: #000000">: </span><span style="color: #001080">functionEnvironment</span><span style="color: #000000">,</span>
<span style="color: #000000">  } = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">], </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span>
<span style="color: #000000">    </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<div style="background-color: #e0ffff;"><span style="color: #000000">    </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">(</span><span style="color: #001080">functionEnvironment</span><span style="color: #000000">).</span><span style="color: #795E26">set</span><span style="color: #000000">(</span><span style="color: #001080">parameter</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">, </span><span style="color: #001080">argument</span><span style="color: #000000">)</span>
</div><span style="color: #000000">  );</span></code></pre>
<fieldset>
<legend><span class="legend-wrapper"><strong>Technical Terms</strong></span></legend>

<p>The principle of being able to reason about a function only by looking at its definition is something called <em>local reasoning</em> (see §&nbsp;\ref{Step 0: Name Reuse}). The treatment given to the environment before this section is something called <em>dynamic scoping</em>, because the <em>scope</em> of a variable (where a variable is defined) is <em>dynamic</em>, depending on where the function is called. The treatment given to the environment in this section is something called <em>static scoping</em> or <em>lexical scoping</em>, because the scope of a variable is determined before we start interpreting the program.</p>
</fieldset>

<fieldset>
<legend><span class="legend-wrapper"><strong>Advanced</strong></span></legend>

<p>There are languages that implement dynamic scoping. In some cases dynamic scoping is the only option, for example, in the original implementation of LISP&nbsp;[<a href="#lisp-original">16</a>], though that was later considered a mistake&nbsp;[<a href="#lisp-history">15</a>]. In some cases dynamic scoping is the default, but there is an option to use static scoping, for example, in Emacs Lisp&nbsp;[<a href="#emacs-lisp">14 (§&nbsp;12.10)</a>]. In some cases dynamic scoping is an extra feature to be used sparingly, for example, in Racket’s <code><span style="color: #000000">parameterize</span></code>&nbsp;[<a href="#racket-guide">9 (§&nbsp;4.13)</a>].</p>
</fieldset>

<h3 id="the-entire-runner-1"><span class="heading-counter">1.4.9</span> The Entire Runner<code class="draft"> [](#the-entire-runner-1)</code></h3>
<p>We completed the changes necessary to transform the <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> function from the substitution-based interpreter in Step&nbsp;0 into an environment-based interpreter:</p>
<pre><code class="language-ts{number}"><span style="color: #aaa;"> 1</span>  <span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Value</span><span style="color: #000000"> = </span><span style="color: #267F99">Closure</span><span style="color: #000000">;</span>
<span style="color: #aaa;"> 2</span>  
<span style="color: #aaa;"> 3</span>  <span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Closure</span><span style="color: #000000"> = {</span>
<span style="color: #aaa;"> 4</span>  <span style="color: #000000">  </span><span style="color: #001080">function</span><span style="color: #000000">: </span><span style="color: #267F99">ArrowFunctionExpression</span><span style="color: #000000">;</span>
<span style="color: #aaa;"> 5</span>  <span style="color: #000000">  </span><span style="color: #001080">environment</span><span style="color: #000000">: </span><span style="color: #267F99">Environment</span><span style="color: #000000">;</span>
<span style="color: #aaa;"> 6</span>  <span style="color: #000000">};</span>
<span style="color: #aaa;"> 7</span>  
<span style="color: #aaa;"> 8</span>  <span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Environment</span><span style="color: #000000"> = </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Identifier</span><span style="color: #000000">[</span><span style="color: #A31515">"name"</span><span style="color: #000000">], </span><span style="color: #267F99">Value</span><span style="color: #000000">&gt;;</span>
<span style="color: #aaa;"> 9</span>  
<span style="color: #aaa;">10</span>  <span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): </span><span style="color: #267F99">Value</span><span style="color: #000000"> {</span>
<span style="color: #aaa;">11</span>  <span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">, </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">());</span>
<span style="color: #aaa;">12</span>  <span style="color: #000000">  </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">: </span><span style="color: #267F99">Environment</span><span style="color: #000000">): </span><span style="color: #267F99">Value</span><span style="color: #000000"> {</span>
<span style="color: #aaa;">13</span>  <span style="color: #000000">    </span><span style="color: #0000FF">switch</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000">) {</span>
<span style="color: #aaa;">14</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">15</span>  <span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000"> { </span><span style="color: #001080">function:</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000"> };</span>
<span style="color: #aaa;">16</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">17</span>  <span style="color: #000000">        </span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<span style="color: #aaa;">18</span>  <span style="color: #000000">          </span><span style="color: #001080">function</span><span style="color: #000000">: {</span>
<span style="color: #aaa;">19</span>  <span style="color: #000000">            </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<span style="color: #aaa;">20</span>  <span style="color: #000000">            </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<span style="color: #aaa;">21</span>  <span style="color: #000000">          },</span>
<span style="color: #aaa;">22</span>  <span style="color: #000000">          </span><span style="color: #001080">environment</span><span style="color: #000000">: </span><span style="color: #001080">functionEnvironment</span><span style="color: #000000">,</span>
<span style="color: #aaa;">23</span>  <span style="color: #000000">        } = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<span style="color: #aaa;">24</span>  <span style="color: #000000">        </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">], </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<span style="color: #aaa;">25</span>  <span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span>
<span style="color: #aaa;">26</span>  <span style="color: #000000">          </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<span style="color: #aaa;">27</span>  <span style="color: #000000">          </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">(</span><span style="color: #001080">functionEnvironment</span><span style="color: #000000">).</span><span style="color: #795E26">set</span><span style="color: #000000">(</span><span style="color: #001080">parameter</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">, </span><span style="color: #001080">argument</span><span style="color: #000000">)</span>
<span style="color: #aaa;">28</span>  <span style="color: #000000">        );</span>
<span style="color: #aaa;">29</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">:</span>
<span style="color: #aaa;">30</span>  <span style="color: #000000">        </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">value</span><span style="color: #000000"> = </span><span style="color: #001080">environment</span><span style="color: #000000">.</span><span style="color: #795E26">get</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">);</span>
<span style="color: #aaa;">31</span>  <span style="color: #000000">        </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">value</span><span style="color: #000000"> === </span><span style="color: #0000FF">undefined</span><span style="color: #000000">)</span>
<span style="color: #aaa;">32</span>  <span style="color: #000000">          </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span>
<span style="color: #aaa;">33</span>  <span style="color: #000000">            </span><span style="color: #A31515">`Reference to undefined variable: </span><span style="color: #0000FF">${</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span>
<span style="color: #aaa;">34</span>  <span style="color: #000000">          );</span>
<span style="color: #aaa;">35</span>  <span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">value</span><span style="color: #000000">;</span>
<span style="color: #aaa;">36</span>  <span style="color: #000000">    }</span>
<span style="color: #aaa;">37</span>  <span style="color: #000000">  }</span>
<span style="color: #aaa;">38</span>  <span style="color: #000000">}</span></code></pre>
<fieldset>
<legend><span class="legend-wrapper"><strong>Advanced</strong></span></legend>

<h3 id="operational-semantics"><span class="heading-counter">1.4.10</span> Operational Semantics<code class="draft"> [](#operational-semantics)</code></h3>
<p>We adapt the operational semantics from <a href="#an-operational-semantics-for-the-interpreter">§&nbsp;1.3.14</a> to the interpreter defined in Step&nbsp;1. First, we change the notion of values:</p>
<p>\begin{center}
\begin{tabular}{rcll}
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.16ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 499.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">v</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="0" y="0"></use>
</g>
</svg> &amp; = &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>( ``x `` js</code> =&gt; <code>e</code> js<code>) ``, \rho \rangle `` &amp; Values / Closures \\ `` math</code>\rho <code>&amp; = &amp;</code> math`{x \mapsto v, \cdots} `` &amp; Environments \
\end{tabular}
\end{center}</p>
<p>We then define the relation <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.051ex" height="2.509ex" style="vertical-align: -0.838ex;" viewBox="0 -719.6 4327.6 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\rho \vdash e \Rightarrow v</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D70C" d="M386 473c96 0 141 -53 139 -148c-3 -157 -101 -340 -278 -340c-41 0 -78 10 -102 44c-30 -174 -29 -251 -27 -295c-26 -11 -56 -17 -84 -18c26 187 45 382 85 561c27 119 148 196 267 196zM347 441c-137 0 -179 -198 -181 -303c-2 -66 16 -127 94 -127 c138 0 184 192 185 300c1 69 -19 130 -98 130Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-22A2" d="M144 599v-280h520v-59h-520v-280h-59v619h59Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-21D2" d="M949 273l-253 -266l-30 31l80 98h-681v59h732l63 76l-64 78h-731v59h681l-80 98l30 33Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D70C" x="0" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-22A2" x="844" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="1870" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-21D2" x="2536" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="3828" y="0"></use>
</g>
</svg> to be equivalent to the new implementation of <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code>:</p>
<p>\begin{mathpar}
\inferrule
{ }
{\rho \vdash <code><span style="color: #000000">(</span></code>x<code><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span></code>e<code><span style="color: #000000">)</span></code> \Rightarrow \langle <code><span style="color: #000000">(</span></code>x<code><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span></code>e<code><span style="color: #000000">)</span></code>, \rho \rangle}</p>
<p>\inferrule
{
\rho \vdash e_f \Rightarrow \langle <code><span style="color: #000000">(</span></code>x<code><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span></code>e_b<code><span style="color: #000000">)</span></code>, \rho_f \rangle \
\rho \vdash e_a \Rightarrow v_a \
\rho_f \cup {x \mapsto v_a} \vdash e_b \Rightarrow v \
}
{\rho \vdash e_f<code><span style="color: #000000">(</span></code>e_a<code><span style="color: #000000">)</span></code> \Rightarrow v}</p>
<p>\inferrule
{ }
{\rho \vdash x \Rightarrow \rho(x)}
\end{mathpar}</p>
</fieldset>

<h3 id="generator-1"><span class="heading-counter">1.4.11</span> Generator<code class="draft"> [](#generator-1)</code></h3>
<p>We modify the generator from <a href="#generator">§&nbsp;1.3.16</a> to support closures. For example, the following is the representation of the closure from §&nbsp;\ref{A Function Call}:</p>
<p>\begin{center}
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(z =&gt; x) ``, [ `` js</code>x <code>\mapsto \langle</code> js<code>(y =&gt; y)</code>, [] \rangle] \rangle`
\end{center}</p>
<pre><code class="language-js"><span style="color: #000000">{</span>
<span style="color: #000000">  </span><span style="color: #A31515">"function"</span><span style="color: #000000">: </span><span style="color: #A31515">"z =&gt; x"</span><span style="color: #000000">,</span>
<span style="color: #000000">  </span><span style="color: #A31515">"environment"</span><span style="color: #000000">: [</span>
<span style="color: #000000">    [</span>
<span style="color: #000000">      </span><span style="color: #A31515">"x"</span><span style="color: #000000">,</span>
<span style="color: #000000">      {</span>
<span style="color: #000000">        </span><span style="color: #A31515">"function"</span><span style="color: #001080">:</span><span style="color: #000000"> </span><span style="color: #A31515">"y =&gt; y"</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #A31515">"environment"</span><span style="color: #001080">:</span><span style="color: #000000"> []</span>
<span style="color: #000000">      }</span>
<span style="color: #000000">    ]</span>
<span style="color: #000000">  ]</span>
<span style="color: #000000">}</span></code></pre>
<p>The following is the modified implementation of <code><span style="color: #795E26">generate</span><span style="color: #000000">()</span></code>:</p>
<pre><code class="language-ts{number}{1,2,4,5,15}"><div style="background-color: #e0ffff;"><span style="color: #aaa;"> 1</span>  <span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">generate</span><span style="color: #000000">(</span><span style="color: #001080">value</span><span style="color: #000000">: </span><span style="color: #267F99">any</span><span style="color: #000000">): </span><span style="color: #267F99">string</span><span style="color: #000000"> {</span>
<div style="background-color: #e0ffff;"></div><span style="color: #aaa;"> 2</span>  <span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #267F99">JSON</span><span style="color: #000000">.</span><span style="color: #795E26">stringify</span><span style="color: #000000">(</span>
</div><span style="color: #aaa;"> 3</span>  <span style="color: #000000">    </span><span style="color: #001080">value</span><span style="color: #000000">,</span>
<div style="background-color: #e0ffff;"><span style="color: #aaa;"> 4</span>  <span style="color: #000000">    (</span><span style="color: #001080">key</span><span style="color: #000000">, </span><span style="color: #001080">value</span><span style="color: #000000">) </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> {</span>
<div style="background-color: #e0ffff;"></div><span style="color: #aaa;"> 5</span>  <span style="color: #000000">      </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">value</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000"> !== </span><span style="color: #0000FF">undefined</span><span style="color: #000000">)</span>
</div><span style="color: #aaa;"> 6</span>  <span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">prettier</span>
<span style="color: #aaa;"> 7</span>  <span style="color: #000000">          .</span><span style="color: #795E26">format</span><span style="color: #000000">(</span><span style="color: #001080">escodegen</span><span style="color: #000000">.</span><span style="color: #795E26">generate</span><span style="color: #000000">(</span><span style="color: #001080">value</span><span style="color: #000000">), {</span>
<span style="color: #aaa;"> 8</span>  <span style="color: #000000">            </span><span style="color: #001080">parser:</span><span style="color: #000000"> </span><span style="color: #A31515">"babel"</span><span style="color: #000000">,</span>
<span style="color: #aaa;"> 9</span>  <span style="color: #000000">            </span><span style="color: #001080">semi:</span><span style="color: #000000"> </span><span style="color: #0000FF">false</span><span style="color: #000000">,</span>
<span style="color: #aaa;">10</span>  <span style="color: #000000">            </span><span style="color: #001080">arrowParens:</span><span style="color: #000000"> </span><span style="color: #A31515">"avoid"</span><span style="color: #000000">,</span>
<span style="color: #aaa;">11</span>  <span style="color: #000000">          })</span>
<span style="color: #aaa;">12</span>  <span style="color: #000000">          .</span><span style="color: #795E26">trim</span><span style="color: #000000">();</span>
<span style="color: #aaa;">13</span>  <span style="color: #000000">      </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">value</span><span style="color: #000000">;</span>
<span style="color: #aaa;">14</span>  <span style="color: #000000">    },</span>
<div style="background-color: #e0ffff;"><span style="color: #aaa;">15</span>  <span style="color: #000000">    </span><span style="color: #098658">2</span>
</div><span style="color: #aaa;">16</span>  <span style="color: #000000">  );</span>
<span style="color: #aaa;">17</span>  <span style="color: #000000">}</span></code></pre>
<p>\begin{description}
\item [Line 1:]</p>
<p>Change the input type from <code><span style="color: #001080">Value</span></code> to <code><span style="color: #001080">any</span></code>, because this implementation of <code><span style="color: #795E26">strinfigy</span><span style="color: #000000">()</span></code> supports any data structure, including the data structures we will define in later Steps.</p>
<p>\item [Line 2:]</p>
<p>Call <code><span style="color: #267F99">JSON</span><span style="color: #000000">.</span><span style="color: #795E26">stringify</span><span style="color: #000000">()</span></code>&nbsp;[<a href="#javascript-json-stringify">22</a>], which traverses any data structure and converts it into a string.</p>
<p>\item [Line 4:]</p>
<p>Provide a <code><span style="color: #001080">replacer</span></code> that is responsible for converting data structures that represent Yocto-JavaScript programs into strings.</p>
<p>\item [Line 5:]</p>
<p>Check whether a data structure represents an Yocto-JavaScript program by checking the existence of a field called <code><span style="color: #001080">type</span></code> (see <a href="#data-structures-to-represent-yocto-javascript-programs">§&nbsp;1.3.2</a>), in which case we use the previous implementation of <code><span style="color: #795E26">generate</span><span style="color: #000000">()</span></code> (see <a href="#generator">§&nbsp;1.3.16</a>) to produce a string.</p>
<p>\item [Line 15:]</p>
<p>Format the output with indentation of two spaces.
\end{description}</p>
<p>This implementation of <code><span style="color: #795E26">generate</span><span style="color: #000000">()</span></code> supports not only closures but any data structure (because of <code><span style="color: #267F99">JSON</span><span style="color: #000000">.</span><span style="color: #795E26">stringify</span><span style="color: #000000">()</span></code>), so it will remain the same in the following Steps.</p>
<h3 id="programs-that-do-not-terminate-1"><span class="heading-counter">1.4.12</span> Programs That Do Not Terminate<code class="draft"> [](#programs-that-do-not-terminate-1)</code></h3>
<p>The programs that do not terminate in Step&nbsp;0 (see §&nbsp;\ref{Step 0: Programs That Do Not Terminate}) do not terminate in Step&nbsp;1 either, because the interpreters are equivalent except for the technique used to interpret function calls, but the sources of non-termination are different. In Step&nbsp;0 substitution may produce infinitely many expressions, including expressions that do not occur in the original program. In Step&nbsp;1 the interpreter considers only the finitely many expressions that occur in the original program, but it may produce infinitely many environments.</p>
<p>This difference is significant because there are programs that produce infinitely many different expressions in Step&nbsp;0, but produce the same expression and environment repeatedly in Step&nbsp;1, and in these cases we could detect non-termination by checking whether the runner is in a loop with the same arguments, for example:</p>
<p>\begin{center}
\begin{tabular}{ll}
\multicolumn{2}{c}{<code><span style="color: #000000">(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))</span></code>, where <code><span style="color: #795E26">F</span><span style="color: #000000"> = </span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> (</span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))(</span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))</span></code>} \
\multicolumn{1}{c}{\textbf{Step&nbsp;0}} &amp; \multicolumn{1}{c}{\textbf{Step&nbsp;1}} \
<code><span style="color: #000000">(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))</span></code> &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(F(F)) ``, [ `` js</code>f <code>\mapsto \langle</code> js<code>F ``, [] \rangle] \rangle `` \\ `` js</code>(F(F))(F(F)) <code>&amp;</code> math<code>\langle `` js</code>(F(F)) <code>, [</code> js<code>f `` \mapsto \langle `` js</code>F <code>, [] \rangle] \rangle</code> \
<code><span style="color: #000000">(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))(</span><span style="color: #795E26">F</span><span style="color: #000000">(F))</span></code> &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(F(F)) ``, [ `` js</code>f <code>\mapsto \langle</code> js<code>F ``, [] \rangle] \rangle `` \\ `` js</code>(F(F))(F(F))(F(F))(F(F)) <code>&amp;</code> math<code>\langle `` js</code>(F(F)) <code>, [</code> js<code>f `` \mapsto \langle `` js</code>F <code>, [] \rangle] \rangle</code> \
\multicolumn{1}{c}{<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.579ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 249.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\vdots</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-22EE" d="M124 674c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58zM124 329c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58zM124 -26c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-22EE" x="0" y="0"></use>
</g>
</svg>} &amp; \multicolumn{1}{c}{<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.579ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 249.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\vdots</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-22EE" d="M124 674c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58zM124 329c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58zM124 -26c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-22EE" x="0" y="0"></use>
</g>
</svg>} \
\end{tabular}
\end{center}</p>
<p>But this strategy is insufficient to guarantee termination, because there are programs that do not terminate which produce infinitely many different environments, for example:</p>
<p>\begin{center}
\begin{tabular}{l}
\multicolumn{1}{c}{<code><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">c</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">c</span><span style="color: #000000">))(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">c</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">c</span><span style="color: #000000">))(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code>} \
\multicolumn{1}{c}{or <code><span style="color: #795E26">F</span><span style="color: #000000">(F)(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code>, where <code><span style="color: #795E26">F</span><span style="color: #000000"> = </span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">c</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)(C)</span></code> and <code><span style="color: #795E26">C</span><span style="color: #000000"> = </span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">c</span></code>} \
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>f(f)(C) ``, [ `` js</code>c <code>\mapsto \langle</code> js<code>(y =&gt; y) ``, [] \rangle, \cdots] \rangle `` \\ `` math</code>\langle <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)(C)</span></code>, [<code><span style="color: #001080">c</span></code> \mapsto \langle <code><span style="color: #000000">C</span></code>, [<code><span style="color: #001080">c</span></code> \mapsto \langle <code><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code>, [] \rangle, \cdots] \rangle, \cdots] \rangle <code>\\</code> math<code>\langle `` js</code>f(f)(C) <code>, [</code> js<code>c `` \mapsto \langle `` js</code>C <code>, [</code> js<code>c `` \mapsto \langle `` js</code>C <code>, [</code> js<code>c `` \mapsto \langle `` js</code>(y =&gt; y) <code>, [] \rangle, \cdots] \rangle, \cdots] \rangle, \cdots] \rangle</code> \
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>f(f)(C) ``, [ `` js</code>c <code>\mapsto \langle</code> js<code>C ``, [ `` js</code>c <code>\mapsto \langle</code> js<code>C ``, [ `` js</code>c <code>\mapsto \langle</code> js<code>C ``, [ `` js</code>c <code>\mapsto \langle</code> js<code>(y =&gt; y) ``, [] \rangle, \cdots] \rangle, \cdots] \rangle, \cdots] \rangle, \cdots] \rangle `` \\ \multicolumn{1}{c}{`` math</code>\vdots ``} \
\end{tabular}
\end{center}</p>
<p>The program above is a variation on the shortest non-terminating program, <code><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">))</span></code>, in which each <code><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)</span></code> receives an additional parameter <code><span style="color: #001080">c</span></code>, and each <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)</span></code> receives an additional argument <code><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">c</span></code>.</p>
<p>The interpreter in Step&nbsp;1 may produce infinitely many different environments because environments may be nested. That is the issue that we address in Step&nbsp;2.</p>
<fieldset>
<legend><span class="legend-wrapper"><strong>Technical Terms</strong></span></legend>

<p>The nesting of environments in Step&nbsp;1 characterizes them as something called <em>recursive data structures</em>: data structures that may contain themselves. The data structures used to represented Yocto-JavaScript programs are recursive as well (see <a href="#data-structures-to-represent-yocto-javascript-programs">§&nbsp;1.3.2</a>).</p>
</fieldset>

<h2 id="step-2-store-based-interpreter"><span class="heading-counter">1.5</span> Step 2: Store-Based Interpreter<code class="draft"> [](#step-2-store-based-interpreter)</code></h2>
<p>The source of non-termination in Step&nbsp;1 is the nesting of the environments (see §&nbsp;\ref{Step 1: Programs That Do Not Terminate}). In Step&nbsp;2, we address this issue by introducing a layer of indirection between a name in the environment and its corresponding value. The interpreter in Step&nbsp;2 may still not terminate, but that is due to other sources of non-termination that will be addressed in subsequent Steps.</p>
<h3 id="avoiding-nested-environments-by-introducing-a-store"><span class="heading-counter">1.5.1</span> Avoiding Nested Environments by Introducing a Store<code class="draft"> [](#avoiding-nested-environments-by-introducing-a-store)</code></h3>
<p>In Step&nbsp;1 a closure contains an environment mapping names to other closures, which in turn contain their own environments mapping to yet more closures. In Step&nbsp;2, we remove this circularity by introducing a layer of indirection: an environment maps names to <em>addresses</em>, which may be used to lookup values in a <em>store</em>, for example:</p>
<p>\begin{center}
\begin{tabular}{rcc}
(See §&nbsp;\ref{A Variable Reference}) &amp; \textbf{Step&nbsp;1} &amp; \textbf{Step&nbsp;2} \
\textbf{Variable Reference} &amp; <code><span style="color: #001080">x</span></code> &amp; <code><span style="color: #001080">x</span></code> \
\textbf{Environment} &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.772ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 332.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
</g>
</svg> js<code>x `` \mapsto \langle `` js</code>(y =&gt; y) <code>, [] \rangle]</code> &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.772ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 332.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
</g>
</svg> js<code>x `` \mapsto `` js</code>0 <code>]</code> \
\textbf{Store} &amp; — &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.772ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 332.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
</g>
</svg> js<code>0 `` \mapsto \langle `` js</code>(y =&gt; y) <code>, [] \rangle]</code> \
\textbf{Value} &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(y =&gt; y) ``, [] \rangle `` &amp; `` math</code>\langle <code><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code>, [] \rangle `` \
\end{tabular}
\end{center}</p>
<p>Each closure continues to include its own environment, because it needs to look up variable references from where the closure was created (see §&nbsp;\ref{A Function Body Is Evaluated with the Environment in Its Closure}), but there is only one store for the entire interpreter, and we avoid ambiguities by allocating different addresses, for example:</p>
<p>\begin{center}
\begin{tabular}{rll}
(See §&nbsp;\ref{A Function Body Is Evaluated with the Environment in Its Closure}) &amp; \multicolumn{1}{c}{\textbf{Step&nbsp;1}} &amp; \multicolumn{1}{c}{\textbf{Step&nbsp;2}} \
<code><span style="color: #001080">environment</span></code> &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.772ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 332.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
</g>
</svg> js<code>x `` \mapsto \langle `` js</code>(a =&gt; a) <code>, [\cdots] \rangle, \cdots]</code> &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.772ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 332.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
</g>
</svg> js<code>x `` \mapsto `` js</code>0 <code>, \cdots]</code> \
<code><span style="color: #001080">funcEnv</span><span style="color: #000000">.</span></code> &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.772ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 332.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
</g>
</svg> js<code>x `` \mapsto \langle `` js</code>(y =&gt; y) <code>, [] \rangle]</code> &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.772ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 332.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
</g>
</svg> js<code>x `` \mapsto `` js</code>1 <code>]</code> \
\textbf{Store} &amp; \multicolumn{1}{c}{—} &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.772ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 332.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
</g>
</svg> js<code>0 `` \mapsto \langle `` js</code>(a =&gt; a) <code>, [\cdots] \rangle,</code> \
&amp; &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.772ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 332.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\phantom{[}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true"></g>
</svg> js<code>1 `` \mapsto \langle `` js</code>(y =&gt; y) <code>, [] \rangle]</code>
\end{tabular}
\end{center}</p>
<p>The runner must return the store along with the value, for the variable references to be looked up, for example:</p>
<p>\begin{center}
\begin{tabular}{ll}
\textbf{Example Program} (see §&nbsp;\ref{A Function Call}) &amp; <code><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code> \
\textbf{Step&nbsp;1 Output} &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(z =&gt; x) ``, [ `` js</code>x <code>\mapsto \langle</code> js<code>(y =&gt; y) ``, [] \rangle] \rangle `` \\ \textbf{Step 2 Output} &amp; `` ts</code>value <code>=</code> math<code>\langle `` js</code>(z =&gt; x) <code>, [</code> js<code>x `` \mapsto `` js</code>0 <code>] \rangle</code> \
&amp; <code><span style="color: #001080">store</span></code> = <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.772ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 332.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
</g>
</svg> js<code>0 `` \mapsto \langle `` js</code>(y =&gt; y) <code>, [] \rangle]</code> \
\end{tabular}
\end{center}</p>
<fieldset>
<legend><span class="legend-wrapper"><strong>Advanced</strong></span></legend>

<p>The technique used in Step&nbsp;2 is related to the run-time environments that are the target of traditional compilers for languages such as C&nbsp;[<a href="#dragon-book">1 (§&nbsp;7)</a>]: an environment corresponds to some of the data stored in an activation frame on the call stack, and the store corresponds to the heap.</p>
</fieldset>

<h3 id="new-data-structures-1"><span class="heading-counter">1.5.2</span> New Data Structures<code class="draft"> [](#new-data-structures-1)</code></h3>
<p>The following are the data structures used to represent environments, stores, and addresses:</p>
<pre><code class="language-ts"><span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Environment</span><span style="color: #000000"> = </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Identifier</span><span style="color: #000000">[</span><span style="color: #A31515">"name"</span><span style="color: #000000">], </span><span style="color: #267F99">Address</span><span style="color: #000000">&gt;;</span>

<span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Store</span><span style="color: #000000"> = </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Address</span><span style="color: #000000">, </span><span style="color: #267F99">Value</span><span style="color: #000000">&gt;;</span>

<span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Address</span><span style="color: #000000"> = </span><span style="color: #267F99">number</span><span style="color: #000000">;</span></code></pre>
<h3 id="adding-a-store-to-the-runner"><span class="heading-counter">1.5.3</span> Adding a Store to the Runner<code class="draft"> [](#adding-a-store-to-the-runner)</code></h3>
<p>We modify the implementation of <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code> from §&nbsp;\ref{Step 1: The Entire Runner} to introduce a <code><span style="color: #001080">store</span></code>:</p>
<pre><code class="language-ts{number}"><span style="color: #aaa;">1</span>  <span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): { </span><span style="color: #001080">value</span><span style="color: #000000">: </span><span style="color: #267F99">Value</span><span style="color: #000000">; </span><span style="color: #001080">store</span><span style="color: #000000">: </span><span style="color: #267F99">Store</span><span style="color: #000000"> } {</span>
<span style="color: #aaa;">2</span>  <span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">store</span><span style="color: #000000">: </span><span style="color: #267F99">Store</span><span style="color: #000000"> = </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">();</span>
<span style="color: #aaa;">3</span>  <span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> { </span><span style="color: #001080">value:</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">, </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">()), </span><span style="color: #001080">store</span><span style="color: #000000"> };</span>
<span style="color: #aaa;">4</span>  <span style="color: #000000">  </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">: </span><span style="color: #267F99">Environment</span><span style="color: #000000">): </span><span style="color: #267F99">Value</span><span style="color: #000000"> {</span>
<span style="color: #aaa;">5</span>  <span style="color: #000000">    </span><span style="color: #008000">// ...</span>
<span style="color: #aaa;">6</span>  <span style="color: #000000">  }</span>
<span style="color: #aaa;">7</span>  <span style="color: #000000">}</span></code></pre>
<p>\begin{description}
\item [Lines 1 and 3:]</p>
<p>The <code><span style="color: #001080">store</span></code> is returned because it is necessary to look up variable references in the <code><span style="color: #001080">value</span></code>.</p>
<p>\item [Lines 2 and 4:]</p>
<p>The <code><span style="color: #001080">store</span></code> is unique for the whole interpreter, unlike <code><span style="color: #001080">environment</span></code>s which are different for each closure, so we create only one store that is always available to <code><span style="color: #795E26">step</span><span style="color: #000000">()</span></code> instead of adding it as an extra parameter.
\end{description}</p>
<h3 id="adding-a-value-to-the-store"><span class="heading-counter">1.5.4</span> Adding a Value to the Store<code class="draft"> [](#adding-a-value-to-the-store)</code></h3>
<p>\begin{center}
\begin{tabular}{ll}
\textbf{Example Program} &amp; <code><span style="color: #000000">(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">z</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code> \
\textbf{Current Output} &amp; — \
\textbf{Expected Output} &amp; <code><span style="color: #001080">value</span></code> = <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(z =&gt; x) ``, [ `` js</code>x <code>\mapsto</code> js<code>0 ``] \rangle `` \\ &amp; `` ts</code>store <code>=</code> math<code>[ `` js</code>0 <code>\mapsto \langle</code> js<code>(y =&gt; y)</code>, [] \rangle]` \
\end{tabular}
\end{center}</p>
<p>In Step&nbsp;1, when we encounter a function call we extend the <code><span style="color: #001080">functionEnvironment</span></code> with a mapping from the <code><span style="color: #001080">parameter</span><span style="color: #000000">.</span><span style="color: #001080">name</span></code> to the <code><span style="color: #001080">argument</span></code> (see §&nbsp;\ref{A Function Call},&nbsp;\ref{A Function Body Is Evaluated with the Environment in Its Closure}). In Step&nbsp;2, we introduce the <code><span style="color: #001080">store</span></code> as a layer of indirection:</p>
<pre><code class="language-ts{number}{11,12,15}"><span style="color: #aaa;"> 1</span>  <span style="color: #008000">// step()</span>
<span style="color: #aaa;"> 2</span>  <span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">: {</span>
<span style="color: #aaa;"> 3</span>  <span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<span style="color: #aaa;"> 4</span>  <span style="color: #000000">    </span><span style="color: #001080">function</span><span style="color: #000000">: {</span>
<span style="color: #aaa;"> 5</span>  <span style="color: #000000">      </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<span style="color: #aaa;"> 6</span>  <span style="color: #000000">      </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<span style="color: #aaa;"> 7</span>  <span style="color: #000000">    },</span>
<span style="color: #aaa;"> 8</span>  <span style="color: #000000">    </span><span style="color: #001080">environment</span><span style="color: #000000">: </span><span style="color: #001080">functionEnvironment</span><span style="color: #000000">,</span>
<span style="color: #aaa;"> 9</span>  <span style="color: #000000">  } = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<span style="color: #aaa;">10</span>  <span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">], </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<div style="background-color: #e0ffff;"><span style="color: #aaa;">11</span>  <span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">address</span><span style="color: #000000"> = </span><span style="color: #001080">store</span><span style="color: #000000">.</span><span style="color: #001080">size</span><span style="color: #000000">;</span>
<div style="background-color: #e0ffff;"></div><span style="color: #aaa;">12</span>  <span style="color: #000000">  </span><span style="color: #001080">store</span><span style="color: #000000">.</span><span style="color: #795E26">set</span><span style="color: #000000">(</span><span style="color: #001080">address</span><span style="color: #000000">, </span><span style="color: #001080">argument</span><span style="color: #000000">);</span>
</div><span style="color: #aaa;">13</span>  <span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span>
<span style="color: #aaa;">14</span>  <span style="color: #000000">    </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<div style="background-color: #e0ffff;"><span style="color: #aaa;">15</span>  <span style="color: #000000">    </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">(</span><span style="color: #001080">functionEnvironment</span><span style="color: #000000">).</span><span style="color: #795E26">set</span><span style="color: #000000">(</span><span style="color: #001080">parameter</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">, </span><span style="color: #001080">address</span><span style="color: #000000">)</span>
</div><span style="color: #aaa;">16</span>  <span style="color: #000000">  );</span>
<span style="color: #aaa;">17</span>  <span style="color: #000000">}</span></code></pre>
<p>\begin{description}
\item [Line 11:]</p>
<p>Allocate an <code><span style="color: #001080">address</span></code>. We use the <code><span style="color: #001080">store</span><span style="color: #000000">.</span><span style="color: #001080">size</span></code> as the <code><span style="color: #001080">address</span></code> because as the <code><span style="color: #001080">store</span></code> grows this number changes, so it is guaranteed to be unique throughout the interpretation of a program.</p>
<p>\item [Line 15:]</p>
<p>Extend the <code><span style="color: #001080">functionEnvironment</span></code> with a mapping from the <code><span style="color: #001080">parameter</span><span style="color: #000000">.</span><span style="color: #001080">name</span></code> to the <code><span style="color: #001080">address</span></code>.</p>
<p>\item [Line 12:]</p>
<p>Extend the <code><span style="color: #001080">store</span></code> with a mapping from the <code><span style="color: #001080">address</span></code> to the <code><span style="color: #001080">argument</span></code>. This is mutating the unique <code><span style="color: #001080">store</span></code> that is available to the entire <code><span style="color: #795E26">step</span><span style="color: #000000">()</span></code> function, not creating a new <code><span style="color: #001080">store</span></code> in the same way that extending an <code><span style="color: #001080">environment</span></code> creates a new <code><span style="color: #001080">environment</span></code> (see line&nbsp;15).
\end{description}</p>
<h3 id="retrieving-a-value-from-the-store"><span class="heading-counter">1.5.5</span> Retrieving a Value from the Store<code class="draft"> [](#retrieving-a-value-from-the-store)</code></h3>
<p>\begin{center}
\begin{tabular}{ll}
\textbf{Example Program} &amp; <code><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">x</span><span style="color: #000000">)</span></code> \
\textbf{Current Output} &amp; — \
\textbf{Expected Output} &amp; <code><span style="color: #001080">value</span></code> = <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>(y =&gt; y) ``, [] \rangle `` \\ &amp; `` ts</code>store <code>=</code> math<code>[ `` js</code>0 <code>\mapsto \langle</code> js<code>(y =&gt; y)</code>, [] \rangle]` \
\end{tabular}
\end{center}</p>
<p>In Step&nbsp;1 we retrieved values directly from the <code><span style="color: #001080">environment</span></code> (see §&nbsp;\ref{A Variable Reference}), but in Step&nbsp;2 we have to go through the <code><span style="color: #001080">store</span></code>:</p>
<pre><code class="language-ts{number}{3,8}"><span style="color: #aaa;">1</span>  <span style="color: #008000">// step()</span>
<span style="color: #aaa;">2</span>  <span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">: {</span>
<div style="background-color: #e0ffff;"><span style="color: #aaa;">3</span>  <span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">address</span><span style="color: #000000"> = </span><span style="color: #001080">environment</span><span style="color: #000000">.</span><span style="color: #795E26">get</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">);</span>
</div><span style="color: #aaa;">4</span>  <span style="color: #000000">  </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">address</span><span style="color: #000000"> === </span><span style="color: #0000FF">undefined</span><span style="color: #000000">)</span>
<span style="color: #aaa;">5</span>  <span style="color: #000000">    </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span>
<span style="color: #aaa;">6</span>  <span style="color: #000000">      </span><span style="color: #A31515">`Reference to undefined variable: </span><span style="color: #0000FF">${</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span>
<span style="color: #aaa;">7</span>  <span style="color: #000000">    );</span>
<div style="background-color: #e0ffff;"><span style="color: #aaa;">8</span>  <span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">store</span><span style="color: #000000">.</span><span style="color: #795E26">get</span><span style="color: #000000">(</span><span style="color: #001080">address</span><span style="color: #000000">)!;</span>
</div><span style="color: #aaa;">9</span>  <span style="color: #000000">}</span></code></pre>
<p>\begin{description}
\item [Line 3:]</p>
<p>Retrieve the <code><span style="color: #001080">address</span></code> from the <code><span style="color: #001080">environment</span></code>.</p>
<p>\item [Line 8:]</p>
<p>Retrieve the <code><span style="color: #001080">value</span></code> from the <code><span style="color: #001080">store</span></code> at the given <code><span style="color: #001080">address</span></code> found in the <code><span style="color: #001080">environment</span></code>. The <code><span style="color: #001080">address</span></code> is guaranteed to be in the <code><span style="color: #001080">store</span></code> because we extend the <code><span style="color: #001080">store</span></code> and the <code><span style="color: #001080">environment</span></code> together (see §&nbsp;\ref{Adding a Value to the Store}), so we use <code><span style="color: #000000">!</span></code> to indicate that <code><span style="color: #795E26">get</span><span style="color: #000000">()</span></code> may not return <code><span style="color: #0000FF">undefined</span></code>.
\end{description}</p>
<h3 id="the-entire-runner-2"><span class="heading-counter">1.5.6</span> The Entire Runner<code class="draft"> [](#the-entire-runner-2)</code></h3>
<p>We completed the changes necessary to remove the circularity between closures and environments:</p>
<pre><code class="language-ts{number}"><span style="color: #aaa;"> 1</span>  <span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Environment</span><span style="color: #000000"> = </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Identifier</span><span style="color: #000000">[</span><span style="color: #A31515">"name"</span><span style="color: #000000">], </span><span style="color: #267F99">Address</span><span style="color: #000000">&gt;;</span>
<span style="color: #aaa;"> 2</span>  
<span style="color: #aaa;"> 3</span>  <span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Store</span><span style="color: #000000"> = </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Address</span><span style="color: #000000">, </span><span style="color: #267F99">Value</span><span style="color: #000000">&gt;;</span>
<span style="color: #aaa;"> 4</span>  
<span style="color: #aaa;"> 5</span>  <span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Address</span><span style="color: #000000"> = </span><span style="color: #267F99">number</span><span style="color: #000000">;</span>
<span style="color: #aaa;"> 6</span>  
<span style="color: #aaa;"> 7</span>  <span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): { </span><span style="color: #001080">value</span><span style="color: #000000">: </span><span style="color: #267F99">Value</span><span style="color: #000000">; </span><span style="color: #001080">store</span><span style="color: #000000">: </span><span style="color: #267F99">Store</span><span style="color: #000000"> } {</span>
<span style="color: #aaa;"> 8</span>  <span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">store</span><span style="color: #000000">: </span><span style="color: #267F99">Store</span><span style="color: #000000"> = </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">();</span>
<span style="color: #aaa;"> 9</span>  <span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> { </span><span style="color: #001080">value:</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">, </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">()), </span><span style="color: #001080">store</span><span style="color: #000000"> };</span>
<span style="color: #aaa;">10</span>  <span style="color: #000000">  </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">: </span><span style="color: #267F99">Environment</span><span style="color: #000000">): </span><span style="color: #267F99">Value</span><span style="color: #000000"> {</span>
<span style="color: #aaa;">11</span>  <span style="color: #000000">    </span><span style="color: #0000FF">switch</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000">) {</span>
<span style="color: #aaa;">12</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">: {</span>
<span style="color: #aaa;">13</span>  <span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000"> { </span><span style="color: #001080">function:</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000"> };</span>
<span style="color: #aaa;">14</span>  <span style="color: #000000">      }</span>
<span style="color: #aaa;">15</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">: {</span>
<span style="color: #aaa;">16</span>  <span style="color: #000000">        </span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<span style="color: #aaa;">17</span>  <span style="color: #000000">          </span><span style="color: #001080">function</span><span style="color: #000000">: {</span>
<span style="color: #aaa;">18</span>  <span style="color: #000000">            </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<span style="color: #aaa;">19</span>  <span style="color: #000000">            </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<span style="color: #aaa;">20</span>  <span style="color: #000000">          },</span>
<span style="color: #aaa;">21</span>  <span style="color: #000000">          </span><span style="color: #001080">environment</span><span style="color: #000000">: </span><span style="color: #001080">functionEnvironment</span><span style="color: #000000">,</span>
<span style="color: #aaa;">22</span>  <span style="color: #000000">        } = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<span style="color: #aaa;">23</span>  <span style="color: #000000">        </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">], </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<span style="color: #aaa;">24</span>  <span style="color: #000000">        </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">address</span><span style="color: #000000"> = </span><span style="color: #001080">store</span><span style="color: #000000">.</span><span style="color: #001080">size</span><span style="color: #000000">;</span>
<span style="color: #aaa;">25</span>  <span style="color: #000000">        </span><span style="color: #001080">store</span><span style="color: #000000">.</span><span style="color: #795E26">set</span><span style="color: #000000">(</span><span style="color: #001080">address</span><span style="color: #000000">, </span><span style="color: #001080">argument</span><span style="color: #000000">);</span>
<span style="color: #aaa;">26</span>  <span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span>
<span style="color: #aaa;">27</span>  <span style="color: #000000">          </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<span style="color: #aaa;">28</span>  <span style="color: #000000">          </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">(</span><span style="color: #001080">functionEnvironment</span><span style="color: #000000">).</span><span style="color: #795E26">set</span><span style="color: #000000">(</span><span style="color: #001080">parameter</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">, </span><span style="color: #001080">address</span><span style="color: #000000">)</span>
<span style="color: #aaa;">29</span>  <span style="color: #000000">        );</span>
<span style="color: #aaa;">30</span>  <span style="color: #000000">      }</span>
<span style="color: #aaa;">31</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">: {</span>
<span style="color: #aaa;">32</span>  <span style="color: #000000">        </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">address</span><span style="color: #000000"> = </span><span style="color: #001080">environment</span><span style="color: #000000">.</span><span style="color: #795E26">get</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">);</span>
<span style="color: #aaa;">33</span>  <span style="color: #000000">        </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">address</span><span style="color: #000000"> === </span><span style="color: #0000FF">undefined</span><span style="color: #000000">)</span>
<span style="color: #aaa;">34</span>  <span style="color: #000000">          </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span>
<span style="color: #aaa;">35</span>  <span style="color: #000000">            </span><span style="color: #A31515">`Reference to undefined variable: </span><span style="color: #0000FF">${</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span>
<span style="color: #aaa;">36</span>  <span style="color: #000000">          );</span>
<span style="color: #aaa;">37</span>  <span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">store</span><span style="color: #000000">.</span><span style="color: #795E26">get</span><span style="color: #000000">(</span><span style="color: #001080">address</span><span style="color: #000000">)!;</span>
<span style="color: #aaa;">38</span>  <span style="color: #000000">      }</span>
<span style="color: #aaa;">39</span>  <span style="color: #000000">    }</span>
<span style="color: #aaa;">40</span>  <span style="color: #000000">  }</span>
<span style="color: #aaa;">41</span>  <span style="color: #000000">}</span></code></pre>
<fieldset>
<legend><span class="legend-wrapper"><strong>Advanced</strong></span></legend>

<h3 id="operational-semantics-1"><span class="heading-counter">1.5.7</span> Operational Semantics<code class="draft"> [](#operational-semantics-1)</code></h3>
<p>We adapt the operational semantics from §&nbsp;\ref{Step 2: Operational Semantics} to the interpreter defined in Step&nbsp;2. First, we change the notion of environments:</p>
<p>\begin{center}
\begin{tabular}{rcll}
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.316ex" height="2.176ex" style="vertical-align: -0.838ex;" viewBox="0 -576.1 566.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\rho</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D70C" d="M386 473c96 0 141 -53 139 -148c-3 -157 -101 -340 -278 -340c-41 0 -78 10 -102 44c-30 -174 -29 -251 -27 -295c-26 -11 -56 -17 -84 -18c26 187 45 382 85 561c27 119 148 196 267 196zM347 441c-137 0 -179 -198 -181 -303c-2 -66 16 -127 94 -127 c138 0 184 192 185 300c1 69 -19 130 -98 130Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D70C" x="0" y="0"></use>
</g>
</svg> &amp; = &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.385ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 4901.7 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\{x \mapsto A, \cdots\}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-7B" d="M289 -175c-113 0 -155 26 -155 158v168c0 72 -10 103 -76 122c62 19 76 54 76 119v186c0 125 55 148 155 148c-65 -19 -83 -59 -83 -131v-186c0 -74 -12 -117 -81 -135v-2c72 -19 81 -65 81 -144v-173c0 -72 20 -116 83 -130Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D465" d="M9 1c4 26 12 52 12 87l20 3l11 -28c2 -5 13 -9 28 -9c28 0 62 32 105 99l40 62l-11 62c-17 98 -39 139 -72 139c-19 0 -39 -14 -69 -48l-17 10l58 83c9 13 31 21 57 21c59 0 86 -36 98 -135l6 -48l37 55c62 92 102 128 142 128c9 0 18 -3 30 -10l-15 -85l-14 -4 c-5 15 -17 23 -33 23c-31 0 -58 -23 -105 -88l-35 -49l18 -101c5 -29 16 -66 25 -85c10 -20 23 -30 38 -30c16 0 41 15 77 45l9 -19l-49 -44c-32 -29 -64 -46 -86 -46c-36 0 -59 39 -72 124l-11 69l-76 -117c-31 -47 -70 -76 -103 -76c-12 0 -28 4 -43 12Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-21A6" d="M94 300h770l-124 152l32 34l206 -217l-206 -214l-32 34l124 152h-770v-186h-58v431h58v-186Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D434" d="M567 55c0 14 -4 29 -4 31v3l-25 188h-246l-102 -175c-19 -33 -26 -47 -26 -55c0 -9 15 -18 31 -19l52 -3v-28c-86 3 -88 3 -107 3c-20 0 -20 0 -112 -3v30l20 5c34 8 52 24 88 80l373 593h46l87 -625c8 -45 9 -45 56 -52l26 -3v-28c-102 3 -102 3 -122 3s-20 0 -122 -3 v28l44 3c28 2 43 11 43 27zM496 601l-179 -288h216Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2C" d="M204 123l14 -14c-28 -77 -66 -140 -147 -245l-41 -19l-14 11c58 96 83 161 90 237c53 15 71 21 98 30Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-22EF" d="M499 329c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58zM166 329c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58zM832 329c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-7D" d="M275 273c-66 -19 -76 -50 -76 -122v-168c0 -132 -42 -158 -155 -158c63 14 83 58 83 130v173c0 79 9 125 81 144v2c-69 18 -81 61 -81 135v186c0 72 -18 112 -83 131c100 0 155 -23 155 -148v-186c0 -65 14 -100 76 -119Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-7B" x="0" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D465" x="332" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-21A6" x="1109" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D434" x="2401" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-2C" x="3152" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-22EF" x="3568" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-7D" x="4569" y="0"></use>
</g>
</svg> &amp; Environments \
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.283ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 552.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\sigma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D70E" d="M171 -15c-112 0 -143 63 -143 168c0 176 122 271 285 304c51 10 172 -4 211 17c-3 -23 -6 -43 -13 -63c-54 -8 -113 -4 -166 -4v-3c65 -43 91 -61 89 -147c-3 -157 -103 -272 -263 -272zM367 267c0 61 -8 145 -93 145c-131 0 -169 -120 -170 -230c-1 -70 7 -169 99 -169 c126 0 164 155 164 254Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D70E" x="0" y="0"></use>
</g>
</svg> &amp; = &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.385ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 4901.7 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\{A \mapsto v, \cdots\}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-7B" d="M289 -175c-113 0 -155 26 -155 158v168c0 72 -10 103 -76 122c62 19 76 54 76 119v186c0 125 55 148 155 148c-65 -19 -83 -59 -83 -131v-186c0 -74 -12 -117 -81 -135v-2c72 -19 81 -65 81 -144v-173c0 -72 20 -116 83 -130Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D434" d="M567 55c0 14 -4 29 -4 31v3l-25 188h-246l-102 -175c-19 -33 -26 -47 -26 -55c0 -9 15 -18 31 -19l52 -3v-28c-86 3 -88 3 -107 3c-20 0 -20 0 -112 -3v30l20 5c34 8 52 24 88 80l373 593h46l87 -625c8 -45 9 -45 56 -52l26 -3v-28c-102 3 -102 3 -122 3s-20 0 -122 -3 v28l44 3c28 2 43 11 43 27zM496 601l-179 -288h216Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-21A6" d="M94 300h770l-124 152l32 34l206 -217l-206 -214l-32 34l124 152h-770v-186h-58v431h58v-186Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2C" d="M204 123l14 -14c-28 -77 -66 -140 -147 -245l-41 -19l-14 11c58 96 83 161 90 237c53 15 71 21 98 30Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-22EF" d="M499 329c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58zM166 329c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58zM832 329c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-7D" d="M275 273c-66 -19 -76 -50 -76 -122v-168c0 -132 -42 -158 -155 -158c63 14 83 58 83 130v173c0 79 9 125 81 144v2c-69 18 -81 61 -81 135v186c0 72 -18 112 -83 131c100 0 155 -23 155 -148v-186c0 -65 14 -100 76 -119Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-7B" x="0" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D434" x="332" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-21A6" x="1361" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="2653" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-2C" x="3152" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-22EF" x="3568" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-7D" x="4569" y="0"></use>
</g>
</svg> &amp; Stores \
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.745ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 751.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">A</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D434" d="M567 55c0 14 -4 29 -4 31v3l-25 188h-246l-102 -175c-19 -33 -26 -47 -26 -55c0 -9 15 -18 31 -19l52 -3v-28c-86 3 -88 3 -107 3c-20 0 -20 0 -112 -3v30l20 5c34 8 52 24 88 80l373 593h46l87 -625c8 -45 9 -45 56 -52l26 -3v-28c-102 3 -102 3 -122 3s-20 0 -122 -3 v28l44 3c28 2 43 11 43 27zM496 601l-179 -288h216Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D434" x="0" y="0"></use>
</g>
</svg> &amp; = &amp; <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.21ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 951.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbb{N}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHDOUBLESTRUCK-2115" d="M934 662l-45 -3c-41 -4 -50 -6 -50 -90v-569h-87l-471 581h-2v-461c0 -79 7 -89 50 -91l45 -2v-30c-45 1 -80 3 -120 3c-36 0 -76 -1 -116 -1c-42 -1 -87 -1 -121 -2v30l44 2c41 2 51 12 51 91v449c0 79 -10 87 -51 90l-44 3v30c34 -1 79 -3 121 -3h120c18 0 36 2 54 3 l477 -590h4v467c0 82 -8 86 -51 90l-44 3v30c40 -1 80 -3 116 -3c40 0 75 2 120 3v-30zM189 31c37 4 44 9 44 89v449c0 79 -6 85 -44 89c-26 -3 -31 -15 -31 -89v-449c0 -74 5 -86 31 -89Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHDOUBLESTRUCK-2115" x="0" y="0"></use>
</g>
</svg> &amp; Addresses \
\end{tabular}
\end{center}</p>
<p>We then define the relation <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.323ex" height="2.676ex" style="vertical-align: -0.838ex;" viewBox="0 -791.3 7027.9 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\rho, \sigma \vdash e \Rightarrow \langle v, \sigma \rangle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D70C" d="M386 473c96 0 141 -53 139 -148c-3 -157 -101 -340 -278 -340c-41 0 -78 10 -102 44c-30 -174 -29 -251 -27 -295c-26 -11 -56 -17 -84 -18c26 187 45 382 85 561c27 119 148 196 267 196zM347 441c-137 0 -179 -198 -181 -303c-2 -66 16 -127 94 -127 c138 0 184 192 185 300c1 69 -19 130 -98 130Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-2C" d="M204 123l14 -14c-28 -77 -66 -140 -147 -245l-41 -19l-14 11c58 96 83 161 90 237c53 15 71 21 98 30Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D70E" d="M171 -15c-112 0 -143 63 -143 168c0 176 122 271 285 304c51 10 172 -4 211 17c-3 -23 -6 -43 -13 -63c-54 -8 -113 -4 -166 -4v-3c65 -43 91 -61 89 -147c-3 -157 -103 -272 -263 -272zM367 267c0 61 -8 145 -93 145c-131 0 -169 -120 -170 -230c-1 -70 7 -169 99 -169 c126 0 164 155 164 254Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-22A2" d="M144 599v-280h520v-59h-520v-280h-59v619h59Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D452" d="M328 111l8 -19c-92 -75 -148 -103 -205 -103c-72 0 -116 46 -116 124c0 67 30 186 60 236c37 74 147 147 215 133c50 0 84 -31 84 -78c0 -62 -39 -108 -124 -145c-25 -11 -134 -41 -151 -45c-5 -29 -8 -56 -8 -81c0 -60 29 -97 76 -97c36 0 84 20 137 58zM113 274l-9 -37 c45 10 81 21 109 35c52 25 87 72 87 116c0 32 -19 52 -48 52c-24 0 -55 -12 -73 -28c-29 -26 -49 -69 -66 -138Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-21D2" d="M949 273l-253 -266l-30 31l80 98h-681v59h732l63 76l-64 78h-731v59h681l-80 98l30 33Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D463" d="M166 420c-38 0 -22 2 -55 2c-24 0 -44 -11 -51 -28l-17 -42h-22c13 55 24 91 38 118c11 5 20 7 32 7c1 0 6 0 12 -1l12 -1c29 -3 71 -5 99 -5s41 3 61 12l10 -18c-98 -122 -137 -213 -137 -318c0 -65 31 -107 80 -107c88 0 185 163 185 311c0 40 -16 63 -43 63 c-9 0 -18 -3 -27 -9l-11 19l50 47c8 8 20 12 33 12c36 0 62 -41 62 -98c0 -148 -153 -395 -291 -395c-64 0 -110 55 -110 132c0 100 42 183 153 303c-26 -3 -42 -4 -63 -4Z"></path>
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E9" d="M329 271l-226 -443h-50l204 443l-204 442h50Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D70C" x="0" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-2C" x="566" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D70E" x="982" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-22A2" x="1812" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D452" x="2839" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-21D2" x="3505" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="4796" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D463" x="5178" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-2C" x="5677" y="0"></use>
 <use xlink:href="#E1-ASANAMATHNORMAL-1D70E" x="6093" y="0"></use>
 <use xlink:href="#E1-ASANAMATHMAIN-27E9" x="6646" y="0"></use>
</g>
</svg> to be equivalent to the new implementation of <code><span style="color: #795E26">run</span><span style="color: #000000">()</span></code>:</p>
<p>\begin{mathpar}
\inferrule
{ }
{\rho, \sigma \vdash <code><span style="color: #000000">(</span></code>x<code><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span></code>e<code><span style="color: #000000">)</span></code> \Rightarrow \langle \langle <code><span style="color: #000000">(</span></code>x<code><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span></code>e<code><span style="color: #000000">)</span></code>, \rho \rangle, \sigma \rangle}</p>
<p>\inferrule
{
\rho, \sigma \vdash e_f \Rightarrow \langle \langle <code><span style="color: #000000">(</span></code>x<code><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span></code>e_b<code><span style="color: #000000">)</span></code>, \rho_f \rangle, \sigma_f \rangle \
\rho, \sigma_f \vdash e_a \Rightarrow \langle v_a, \sigma_a \rangle \
A = \lvert \sigma_a \rvert \
\rho_f \cup {x \mapsto A}, \sigma_a \cup {A \mapsto v_a} \vdash e_b \Rightarrow \langle v, \sigma_v \rangle \
}
{\rho, \sigma \vdash e_f<code><span style="color: #000000">(</span></code>e_a<code><span style="color: #000000">)</span></code> \Rightarrow \langle v, \sigma_v \rangle}</p>
<p>\inferrule
{ }
{\rho, \sigma \vdash x \Rightarrow \sigma(\rho(x))}
\end{mathpar}</p>
</fieldset>

<h3 id="programs-that-do-not-terminate-2"><span class="heading-counter">1.5.8</span> Programs That Do Not Terminate<code class="draft"> [](#programs-that-do-not-terminate-2)</code></h3>
<p>The programs that do not terminate in Step&nbsp;1 (see §&nbsp;\ref{Step 1: Programs That Do Not Terminate}) do not terminate in Step&nbsp;2 either, because the interpreters are equivalent except for the treatment of environments, but the sources of non-termination are different. In both cases the issue is that the interpreter may create infinitely many environments, but in Step&nbsp;1 the environments are nested, and in Step&nbsp;2 they contain different addresses, for example:</p>
<p>\begin{center}
\begin{tabular}{l}
\multicolumn{1}{c}{<code><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">c</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">c</span><span style="color: #000000">))(</span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">c</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)(</span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">c</span><span style="color: #000000">))(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code>} \
\multicolumn{1}{c}{or <code><span style="color: #795E26">F</span><span style="color: #000000">(F)(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code>, where <code><span style="color: #795E26">F</span><span style="color: #000000"> = </span><span style="color: #001080">f</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">c</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)(C)</span></code> and <code><span style="color: #795E26">C</span><span style="color: #000000"> = </span><span style="color: #001080">x</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">c</span></code>} \
\multicolumn{1}{c}{\textbf{Step&nbsp;1}} \
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>f(f)(C) ``, [ `` js</code>c <code>\mapsto \langle</code> js<code>(y =&gt; y) ``, [] \rangle, \cdots] \rangle `` \\ `` math</code>\langle <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)(C)</span></code>, [<code><span style="color: #001080">c</span></code> \mapsto \langle <code><span style="color: #000000">C</span></code>, [<code><span style="color: #001080">c</span></code> \mapsto \langle <code><span style="color: #000000">(</span><span style="color: #001080">y</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">y</span><span style="color: #000000">)</span></code>, [] \rangle, \cdots] \rangle, \cdots] \rangle <code>\\</code> math<code>\langle `` js</code>f(f)(C) <code>, [</code> js<code>c `` \mapsto \langle `` js</code>C <code>, [</code> js<code>c `` \mapsto \langle `` js</code>C <code>, [</code> js<code>c `` \mapsto \langle `` js</code>(y =&gt; y) <code>, [] \rangle, \cdots] \rangle, \cdots] \rangle, \cdots] \rangle</code> \
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>f(f)(C) ``, [ `` js</code>c <code>\mapsto \langle</code> js<code>C ``, [ `` js</code>c <code>\mapsto \langle</code> js<code>C ``, [ `` js</code>c <code>\mapsto \langle</code> js<code>C ``, [ `` js</code>c <code>\mapsto \langle</code> js<code>(y =&gt; y) ``, [] \rangle, \cdots] \rangle, \cdots] \rangle, \cdots] \rangle, \cdots] \rangle `` \\ \multicolumn{1}{c}{`` math</code>\vdots <code>} \\ \multicolumn{1}{c}{\textbf{Step 2}} \\ \multicolumn{1}{c}{</code> math<code>\langle `` js</code>f(f)(C) <code>, [</code> js<code>c `` \mapsto `` js</code>0 <code>, \cdots] \rangle</code>} \
\multicolumn{1}{c}{<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.886ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 381.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\langle</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-27E8" d="M329 -172h-50l-226 443l226 442h50l-204 -442Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-27E8" x="0" y="0"></use>
</g>
</svg> js<code>f(f)(C) ``, [ `` js</code>c <code>\mapsto</code> js<code>1 ``, \cdots] \rangle ``} \\ \multicolumn{1}{c}{`` math</code>\langle <code><span style="color: #795E26">f</span><span style="color: #000000">(</span><span style="color: #001080">f</span><span style="color: #000000">)(C)</span></code>, [<code><span style="color: #001080">c</span></code> \mapsto <code><span style="color: #098658">2</span></code>, \cdots] \rangle <code>} \\ \multicolumn{1}{c}{</code> math<code>\langle `` js</code>f(f)(C) <code>, [</code> js<code>c `` \mapsto `` js</code>3 <code>, \cdots] \rangle</code>} \
\multicolumn{1}{c}{<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.579ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 249.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\vdots</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-22EE" d="M124 674c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58zM124 329c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58zM124 -26c31 0 59 -28 59 -58c0 -31 -28 -58 -60 -58c-29 0 -56 28 -56 58s27 58 57 58Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-22EE" x="0" y="0"></use>
</g>
</svg>} \
\multicolumn{1}{c}{<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.772ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 332.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHMAIN-5B" d="M88 -184l-9 13c6 31 8 59 8 127v622c0 50 -4 87 -4 113c0 15 1 26 5 35l100 -3l94 3l6 -6v-26l-4 -5h-38c-27 0 -49 -6 -61 -16c-9 -9 -12 -24 -12 -57v-691c0 -33 3 -47 12 -56c12 -10 34 -16 61 -16h38l4 -5v-26l-6 -6l-100 1Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHMAIN-5B" x="0" y="0"></use>
</g>
</svg> js<code>0 `` \mapsto \langle `` js</code>(y =&gt; y) <code>, [] \rangle,</code> js<code>1 `` \mapsto \langle `` js</code>C <code>, [</code> js<code>c `` \mapsto `` c</code>0 <code>, \cdots] \rangle,</code> js<code>2 `` \mapsto \langle `` js</code>C <code>, [</code> js<code>c `` \mapsto `` c</code>1 <code>, \cdots] \rangle, \cdots]</code>}
\end{tabular}
\end{center}</p>
<p>We address this issue in Step&nbsp;3.</p>
<h2 id="step-3-finitely-many-addresses"><span class="heading-counter">1.6</span> Step 3: Finitely Many Addresses<code class="draft"> [](#step-3-finitely-many-addresses)</code></h2>
<h3 id="the-entire-runner-3"><span class="heading-counter">1.6.1</span> The Entire Runner<code class="draft"> [](#the-entire-runner-3)</code></h3>
<p>We completed the changes necessary to produce only finitely many addresses:</p>
<pre><code class="language-ts{number}"><span style="color: #aaa;"> 1</span>  <span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Value</span><span style="color: #000000"> = </span><span style="color: #267F99">SetDeepEqual</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Closure</span><span style="color: #000000">&gt;;</span>
<span style="color: #aaa;"> 2</span>  
<span style="color: #aaa;"> 3</span>  <span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Address</span><span style="color: #000000"> = </span><span style="color: #267F99">Identifier</span><span style="color: #000000">;</span>
<span style="color: #aaa;"> 4</span>  
<span style="color: #aaa;"> 5</span>  <span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">run</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">): { </span><span style="color: #001080">value</span><span style="color: #000000">: </span><span style="color: #267F99">Value</span><span style="color: #000000">; </span><span style="color: #001080">store</span><span style="color: #000000">: </span><span style="color: #267F99">Store</span><span style="color: #000000"> } {</span>
<span style="color: #aaa;"> 6</span>  <span style="color: #000000">  </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">store</span><span style="color: #000000">: </span><span style="color: #267F99">Store</span><span style="color: #000000"> = </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">();</span>
<span style="color: #aaa;"> 7</span>  <span style="color: #000000">  </span><span style="color: #0000FF">return</span><span style="color: #000000"> { </span><span style="color: #001080">value:</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">, </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">()), </span><span style="color: #001080">store</span><span style="color: #000000"> };</span>
<span style="color: #aaa;"> 8</span>  <span style="color: #000000">  </span><span style="color: #0000FF">function</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">: </span><span style="color: #267F99">Expression</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">: </span><span style="color: #267F99">Environment</span><span style="color: #000000">): </span><span style="color: #267F99">Value</span><span style="color: #000000"> {</span>
<span style="color: #aaa;"> 9</span>  <span style="color: #000000">    </span><span style="color: #0000FF">switch</span><span style="color: #000000"> (</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">type</span><span style="color: #000000">) {</span>
<span style="color: #aaa;">10</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"ArrowFunctionExpression"</span><span style="color: #000000">: {</span>
<span style="color: #aaa;">11</span>  <span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">SetDeepEqual</span><span style="color: #000000">([{ </span><span style="color: #001080">function:</span><span style="color: #000000"> </span><span style="color: #001080">expression</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000"> }]);</span>
<span style="color: #aaa;">12</span>  <span style="color: #000000">      }</span>
<span style="color: #aaa;">13</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"CallExpression"</span><span style="color: #000000">: {</span>
<span style="color: #aaa;">14</span>  <span style="color: #000000">        </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">value</span><span style="color: #000000">: </span><span style="color: #267F99">Value</span><span style="color: #000000"> = </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">SetDeepEqual</span><span style="color: #000000">();</span>
<span style="color: #aaa;">15</span>  <span style="color: #000000">        </span><span style="color: #0000FF">for</span><span style="color: #000000"> (</span><span style="color: #0000FF">const</span><span style="color: #000000"> {</span>
<span style="color: #aaa;">16</span>  <span style="color: #000000">          </span><span style="color: #001080">function</span><span style="color: #000000">: {</span>
<span style="color: #aaa;">17</span>  <span style="color: #000000">            </span><span style="color: #001080">params</span><span style="color: #000000">: [</span><span style="color: #001080">parameter</span><span style="color: #000000">],</span>
<span style="color: #aaa;">18</span>  <span style="color: #000000">            </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<span style="color: #aaa;">19</span>  <span style="color: #000000">          },</span>
<span style="color: #aaa;">20</span>  <span style="color: #000000">          </span><span style="color: #001080">environment</span><span style="color: #000000">: </span><span style="color: #001080">functionEnvironment</span><span style="color: #000000">,</span>
<span style="color: #aaa;">21</span>  <span style="color: #000000">        } </span><span style="color: #0000FF">of</span><span style="color: #000000"> </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">callee</span><span style="color: #000000">, </span><span style="color: #001080">environment</span><span style="color: #000000">)) {</span>
<span style="color: #aaa;">22</span>  <span style="color: #000000">          </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">argument</span><span style="color: #000000"> = </span><span style="color: #795E26">step</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">arguments</span><span style="color: #000000">[</span><span style="color: #098658">0</span><span style="color: #000000">], </span><span style="color: #001080">environment</span><span style="color: #000000">);</span>
<span style="color: #aaa;">23</span>  <span style="color: #000000">          </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">address</span><span style="color: #000000"> = </span><span style="color: #001080">parameter</span><span style="color: #000000">;</span>
<span style="color: #aaa;">24</span>  <span style="color: #000000">          </span><span style="color: #001080">store</span><span style="color: #000000">.</span><span style="color: #795E26">merge</span><span style="color: #000000">(</span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">([[</span><span style="color: #001080">address</span><span style="color: #000000">, </span><span style="color: #001080">argument</span><span style="color: #000000">]]));</span>
<span style="color: #aaa;">25</span>  <span style="color: #000000">          </span><span style="color: #001080">value</span><span style="color: #000000">.</span><span style="color: #795E26">merge</span><span style="color: #000000">(</span>
<span style="color: #aaa;">26</span>  <span style="color: #000000">            </span><span style="color: #795E26">step</span><span style="color: #000000">(</span>
<span style="color: #aaa;">27</span>  <span style="color: #000000">              </span><span style="color: #001080">body</span><span style="color: #000000">,</span>
<span style="color: #aaa;">28</span>  <span style="color: #000000">              </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">MapDeepEqual</span><span style="color: #000000">(</span><span style="color: #001080">functionEnvironment</span><span style="color: #000000">).</span><span style="color: #795E26">set</span><span style="color: #000000">(</span><span style="color: #001080">parameter</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">, </span><span style="color: #001080">address</span><span style="color: #000000">)</span>
<span style="color: #aaa;">29</span>  <span style="color: #000000">            )</span>
<span style="color: #aaa;">30</span>  <span style="color: #000000">          );</span>
<span style="color: #aaa;">31</span>  <span style="color: #000000">        }</span>
<span style="color: #aaa;">32</span>  <span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">value</span><span style="color: #000000">;</span>
<span style="color: #aaa;">33</span>  <span style="color: #000000">      }</span>
<span style="color: #aaa;">34</span>  <span style="color: #000000">      </span><span style="color: #0000FF">case</span><span style="color: #000000"> </span><span style="color: #A31515">"Identifier"</span><span style="color: #000000">: {</span>
<span style="color: #aaa;">35</span>  <span style="color: #000000">        </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #001080">address</span><span style="color: #000000"> = </span><span style="color: #001080">environment</span><span style="color: #000000">.</span><span style="color: #795E26">get</span><span style="color: #000000">(</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #000000">);</span>
<span style="color: #aaa;">36</span>  <span style="color: #000000">        </span><span style="color: #0000FF">if</span><span style="color: #000000"> (</span><span style="color: #001080">address</span><span style="color: #000000"> === </span><span style="color: #0000FF">undefined</span><span style="color: #000000">)</span>
<span style="color: #aaa;">37</span>  <span style="color: #000000">          </span><span style="color: #0000FF">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #267F99">Error</span><span style="color: #000000">(</span>
<span style="color: #aaa;">38</span>  <span style="color: #000000">            </span><span style="color: #A31515">`Reference to undefined variable: </span><span style="color: #0000FF">${</span><span style="color: #001080">expression</span><span style="color: #000000">.</span><span style="color: #001080">name</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span>
<span style="color: #aaa;">39</span>  <span style="color: #000000">          );</span>
<span style="color: #aaa;">40</span>  <span style="color: #000000">        </span><span style="color: #0000FF">return</span><span style="color: #000000"> </span><span style="color: #001080">store</span><span style="color: #000000">.</span><span style="color: #795E26">get</span><span style="color: #000000">(</span><span style="color: #001080">address</span><span style="color: #000000">)!;</span>
<span style="color: #aaa;">41</span>  <span style="color: #000000">      }</span>
<span style="color: #aaa;">42</span>  <span style="color: #000000">    }</span>
<span style="color: #aaa;">43</span>  <span style="color: #000000">  }</span>
<span style="color: #aaa;">44</span>  <span style="color: #000000">}</span></code></pre>
<!--
TODO: Some loss of precision. Now it’s an analyzer (of sorts).

TODO: Add highlightlines to entire runner sections.
TODO: High-level examples.

TODO: Variations
      Context Sensitivity
        k-CFA
        Set-based
        Top-frames / Call+return / Call-only / Return-only
        m-CFA
        Stack/Heap separation
        Closures contain references & stores contain environments (the PL II trick) (sets of maps instead of maps of sets) (path-sensitive?)
      Store Widening
        None
        Universal (flow-insensitive)
      Garbage Collection
        Filtered environments to contain only the non-locals
        Filtered stores (proper garbage collection)
-->

</main>
<footer>

<h1 id="bibliography">Bibliography</h1>
<ol>
<li><span id="dragon-book"></span> Alfred Aho, Monica Lam, Ravi Sethi, and Jeffrey Ullman. <em>Compilers: Principles, Techniques, and Tools</em>. Addison-Wesley. 2006.</li>
<li><span id="babel"></span> <em>Babel</em>. <a href="https://babeljs.io"><code>https://babeljs.io</code></a>. Accessed 2020-04-06.</li>
<li><span id="babel-types"></span> <em>Babel Types</em>. <a href="https://git.io/JfZF8"><code>https://git.io/JfZF8</code></a>. Accessed 2020-05-06.</li>
<li><span id="code-quality"></span> Emery Berger, Celeste Hollenbeck, Petr Maj, Olga Vitek, and Jan Vitek. <em>On the Impact of Programming Languages on Code Quality: A Reproduction Study</em>. ACM Transactions on Programming Languages and Systems. 2019. <a href="https://doi.org/10.1145/3340571"><code>https://doi.org/10.1145/3340571</code></a>.</li>
<li><span id="understanding-typescript"></span> Gavin Bierman, Martín Abadi, and Mads Torgersen. <em>Understanding TypeScript</em>. European Conference on Object-Oriented Programming (ECOOP). 2014.</li>
<li><span id="collections-deep-equal"></span> <strong>Leandro Facchinetti</strong>. <em>Collections Deep Equal</em>. <a href="https://github.com/leafac/collections-deep-equal"><code>https://github.com/leafac/collections-deep-equal</code></a>. Accessed 2020-04-01.</li>
<li><span id="expressive-power"></span> Matthias Felleisen. <em>On the Expressive Power of Programming Languages</em>. Science of Computer Programming. 1991. <a href="https://doi.org/10.1016/0167-6423(91)90036-W"><code>https://doi.org/10.1016/0167-6423(91)90036-W</code></a>.</li>
<li><span id="semantics-engineering"></span> Matthias Felleisen, Robert Bruce Findler, and Matthew Flatt. <em>Semantics Engineering with PLT Redex</em>. The MIT Press. 2009.</li>
<li><span id="racket-guide"></span> Matthew Flatt, Robert Bruce Findler, and PLT. <em>The Racket Guide</em>. <a href="https://docs.racket-lang.org/guide/"><code>https://docs.racket-lang.org/guide/</code></a>. Accessed 2020-04-13.</li>
<li><span id="pl-book"></span> Mike Grant, Zachary Palmer, and Scott Smith. <em>Principles of Programming Languages</em>. 2020.</li>
<li><span id="jet-brains-developer-survey"></span> JetBrains. <em>The State of Developer Ecosystem 2019</em>. <a href="https://www.jetbrains.com/lp/devecosystem-2019/"><code>https://www.jetbrains.com/lp/devecosystem-2019/</code></a>. Accessed 2020-01-14.</li>
<li><span id="natural-semantics"> Gilles Kahn. <em>Natural Semantics</em>. Annual Symposium on Theoretical Aspects of Computer Science. 1987.</span></li>
<li><span id="closures"></span> Peter Landin. <em>The Mechanical Evaluation of Expressions</em>. The Computer Journal. 1964.</li>
<li><span id="emacs-lisp"></span> Bil Lewis, Dan LaLiberte, and Richard Stallman. <em>GNU Emacs Lisp Reference Manual</em>. 2015.</li>
<li><span id="lisp-history"></span> John McCarthy. <em>History of LISP</em>. History of Programming Languages. 1978. <a href="https://doi.org/10.1145/800025.1198360"><code>https://doi.org/10.1145/800025.1198360</code></a>.</li>
<li><span id="lisp-original"></span> John McCarthy. <em>Recursive Functions of Symbolic Expressions and Their Computation by Machine, Part I</em>. Communications of the ACM. 1960. <a href="https://doi.org/10.1145/367177.367199"><code>https://doi.org/10.1145/367177.367199</code></a>.</li>
<li><span id="bnf"></span> Matthew Might. <em>The Language of Languages</em>. <a href="http://matt.might.net/articles/grammars-bnf-ebnf/"><code>http://matt.might.net/articles/grammars-bnf-ebnf/</code></a>. Accessed 2020-01-17.</li>
<li><span id="m-cfa"></span> Matthew Might, Yannis Smaragdakis, and David Van Horn. <em>Resolving and Exploiting the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.088ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 468.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">k</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D458" d="M240 722l-107 -492c125 175 208 252 274 252c12 0 30 -3 48 -9l-17 -63c-17 4 -28 6 -36 6c-50 0 -96 -25 -157 -86l-14 -14c39 -123 61 -177 96 -241c9 -17 16 -23 26 -23c8 0 15 2 29 10l43 24l8 -19l-46 -32c-44 -31 -68 -44 -81 -44c-25 0 -57 68 -126 268 c-34 -34 -58 -79 -67 -127l-23 -124l-67 -17l-9 10c52 209 68 278 82 353l48 268c1 7 2 16 2 24c0 17 -10 24 -34 24h-48l4 21c72 7 108 16 160 42Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D458" x="0" y="0"></use>
</g>
</svg>-CFA Paradox: Illuminating Functional vs Object-Oriented Program Analysis</em>. Programming Language Design and Implementation (PLDI). 2010. <a href="https://doi.org/10.1145/1806596.1806631"><code>https://doi.org/10.1145/1806596.1806631</code></a>.</li>
<li><span id="javascript-arrow-function-expressions"></span> Mozilla. <em>Arrow Function Expressions</em>. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions"><code>https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions</code></a>. Accessed 2020-01-16.</li>
<li><span id="javascript-destructuring-assignment"></span> Mozilla. <em>Destructuring Assignment</em>. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment"><code>https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment</code></a>. Accessed 2020-01-27.</li>
<li><span id="javascript-eval"></span> Mozilla. <code><span style="color: #795E26">eval</span><span style="color: #000000">()</span></code>. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval"><code>https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval</code></a>. Accessed 2020-02-13.</li>
<li><span id="javascript-json-stringify"></span> Mozilla. <code><span style="color: #267F99">JSON</span><span style="color: #000000">.</span><span style="color: #795E26">stringify</span><span style="color: #000000">()</span></code>. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify"><code>https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify</code></a>. Accessed 2020-04-13.</li>
<li><span id="javascript-spread-syntax"></span> Mozilla. <em>Spread Syntax</em>. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax"><code>https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax</code></a>. Accessed 2020-02-03.</li>
<li><span id="javascript-template-literals"></span> Mozilla. <em>Template Literals</em>. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals"><code>https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals</code></a>. Accessed 2020-02-03.</li>
<li><span id="call-by-name-call-by-value-and-the-lambda-calculus"></span> Gordon Plotkin. <em>Call-By-Name, Call-By-Value and the <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.437ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 618.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\lambda</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-ASANAMATHNORMAL-1D706" d="M209 656c42 11 138 72 174 33c16 -17 41 -363 56 -470c5 -31 13 -164 52 -164c21 0 50 22 67 33v-1h12v-13c-42 -30 -114 -116 -169 -80c-17 19 -40 371 -48 434c-92 -120 -199 -269 -242 -415c-26 -9 -51 -18 -76 -29l-10 14c95 163 194 322 322 462 c-4 40 -13 193 -65 193c-16 0 -47 -11 -64 -16c-5 2 -7 6 -9 11v8Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-ASANAMATHNORMAL-1D706" x="0" y="0"></use>
</g>
</svg>-Calculus</em>. Theoretical Computer Science. 1975. <a href="https://doi.org/10.1016/0304-3975(75)90017-1"><code>https://doi.org/10.1016/0304-3975(75)90017-1</code></a>.</li>
<li><span id="prettier"></span> <em>Prettier</em>. <a href="https://prettier.io"><code>https://prettier.io</code></a>. Accessed 2020-02-18.</li>
<li><span id="definitional-interpreters"></span> John Reynolds. <em>Definitional Interpreters for Higher-Order Programming Languages</em>. Proceedings of the ACM Annual Conference. 1972. <a href="https://doi.org/10.1145/800194.805852"><code>https://doi.org/10.1145/800194.805852</code></a>.</li>
<li><span id="k-cfa"></span> Olin Shivers. <em>Control-Flow Analysis of Higher-Order Languages</em>. PhD Dissertation, Carnegie Mellon University. 1991.</li>
<li><span id="stack-overflow-developer-survey"></span> Stack Overflow. <em>Developer Survey Results 2019</em>. <a href="https://insights.stackoverflow.com/survey/2019"><code>https://insights.stackoverflow.com/survey/2019</code></a>. Accessed 2020-01-14.</li>
<li><span id="understanding-computation"></span> Tom Stuart. <em>Understanding Computation: From Simple Machines to Impossible Programs</em>. O’Reilly Media. 2013.</li>
<li><span id="typescript-deep-dive"></span> Basarat Ali Syed. <em>TypeScript Deep Dive</em>. <a href="https://basarat.gitbook.io/typescript/"><code>https://basarat.gitbook.io/typescript/</code></a>. Accessed 2020-01-17.</li>
<li><span id="typescript-documentation"></span> <em>TypeScript Documentation</em>. <a href="https://www.typescriptlang.org/docs"><code>https://www.typescriptlang.org/docs</code></a>. Accessed 2020-01-17.</li>
</ol>
<!-- TODO: # Biographical Statement -->

</footer>


</body></html>